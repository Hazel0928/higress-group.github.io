<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-plugins/jwt-auth">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">JWT 认证 | Higress</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" name="twitter:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" property="og:url" content="https://higress.io/zh-cn/docs/plugins/jwt-auth"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="JWT 认证 | Higress"><meta data-rh="true" name="description" content="JWT 认证插件配置参考"><meta data-rh="true" property="og:description" content="JWT 认证插件配置参考"><meta data-rh="true" name="keywords" content="higress,jwt"><link data-rh="true" rel="icon" href="/zh-cn/img/higress_logo_small.png"><link data-rh="true" rel="canonical" href="https://higress.io/zh-cn/docs/plugins/jwt-auth"><link data-rh="true" rel="alternate" href="https://higress.io/en-us/docs/plugins/jwt-auth" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://higress.io/zh-cn/docs/plugins/jwt-auth" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://higress.io/docs/plugins/jwt-auth" hreflang="default"><link data-rh="true" rel="alternate" href="https://higress.io/docs/plugins/jwt-auth" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Higress RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Higress Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.16/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.16/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.43bb74b6.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.5373e763.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.4ab561ca.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/docs/overview/what-is-higress">文档</a><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a class="navbar__item navbar__link" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="https://github.com/alibaba/higress/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">下载</a><a href="http://demo.higress.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en-us/docs/plugins/jwt-auth" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/docs/plugins/jwt-auth" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">概述</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/what-is-higress">Higress是什么</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/overview/terminology">术语表</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">用户指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/zh-cn/docs/user/annotation">参考手册</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/zh-cn/docs/plugins/intro">插件使用文档</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/intro">Wasm 插件使用简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/custom">自定义插件</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh-cn/docs/plugins/jwt-auth">JWT 认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/hmac-auth">HMAC 认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/key-auth">Key 认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/basic-auth">Basic 认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/key-rate-limit">基于 Key 限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/custom-response">自定义应答</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/bot-detect">机器人拦截</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/request-block">请求屏蔽</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/plugins/waf">WAF 防护</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/zh-cn/docs/user/wasm-go">最佳实践示例</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">运维指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/ops/deploy-by-helm">安装部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/ops/upgrade">版本升级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/ops/log">日志说明</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">开发者指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/dev/code">源码阅读指引</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-cn/docs/dev/architecture">组件编译说明</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">用户指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">插件使用文档</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">JWT 认证</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>JWT 认证</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="功能说明">功能说明<a href="#功能说明" class="hash-link" aria-label="功能说明的直接链接" title="功能说明的直接链接">​</a></h2><p><code>jwt-auth</code>插件实现了基于JWT(JSON Web Tokens)进行认证鉴权的功能，支持从HTTP请求的URL参数、请求头、Cookie字段解析JWT，同时验证该Token是否有权限访问。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行属性">运行属性<a href="#运行属性" class="hash-link" aria-label="运行属性的直接链接" title="运行属性的直接链接">​</a></h2><p>插件执行阶段：<code>认证阶段</code>
插件执行优先级：<code>340</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置字段">配置字段<a href="#配置字段" class="hash-link" aria-label="配置字段的直接链接" title="配置字段的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全局配置">全局配置<a href="#全局配置" class="hash-link" aria-label="全局配置的直接链接" title="全局配置的直接链接">​</a></h3><table><thead><tr><th>名称</th><th>数据类型</th><th>填写要求</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>consumers</code></td><td>array of object</td><td>必填</td><td>-</td><td>配置服务的调用者，用于对请求进行认证</td></tr><tr><td><code>global_auth</code></td><td>bool</td><td>选填</td><td>-</td><td>若配置为true，则全局生效认证机制; 若配置为false，则只对做了配置的域名和路由生效认证机制; 若不配置则仅当没有域名和路由配置时全局生效（兼容机制）</td></tr></tbody></table><p><code>consumers</code>中每一项的配置字段说明如下：</p><table><thead><tr><th>名称</th><th>数据类型</th><th>填写要求</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>name</code></td><td>string</td><td>必填</td><td>-</td><td>配置该consumer的名称</td></tr><tr><td><code>jwks</code></td><td>string</td><td>必填</td><td>-</td><td><a href="https://www.rfc-editor.org/rfc/rfc7517" target="_blank" rel="noopener noreferrer">https://www.rfc-editor.org/rfc/rfc7517</a> 指定的json格式字符串，是由验证JWT中签名的公钥（或对称密钥）组成的Json Web Key Set</td></tr><tr><td><code>issuer</code></td><td>string</td><td>必填</td><td>-</td><td>JWT的签发者，需要和payload中的iss字段保持一致</td></tr><tr><td><code>claims_to_headers</code></td><td>array of object</td><td>选填</td><td>-</td><td>抽取JWT的payload中指定字段，设置到指定的请求头中转发给后端</td></tr><tr><td><code>from_headers</code></td><td>array of object</td><td>选填</td><td>[{&quot;name&quot;:&quot;Authorization&quot;,&quot;value_prefix&quot;:&quot;Bearer &quot;}]</td><td>从指定的请求头中抽取JWT</td></tr><tr><td><code>from_params</code></td><td>array of string</td><td>选填</td><td>access_token</td><td>从指定的URL参数中抽取JWT</td></tr><tr><td><code>from_cookies</code></td><td>array of string</td><td>选填</td><td>-</td><td>从指定的cookie中抽取JWT</td></tr><tr><td><code>clock_skew_seconds</code></td><td>number</td><td>选填</td><td>60</td><td>校验JWT的exp和iat字段时允许的时钟偏移量，单位为秒</td></tr><tr><td><code>keep_token</code></td><td>bool</td><td>选填</td><td>ture</td><td>转发给后端时是否保留JWT</td></tr></tbody></table><p><strong>注意：</strong> </p><ul><li>只有当<code>from_headers</code>,<code>from_params</code>,<code>from_cookies</code>均未配置时，才会使用默认值</li></ul><p><code>from_headers</code> 中每一项的配置字段说明如下：
| 名称             | 数据类型        | 填写要求| 默认值 | 描述                                                      |
| ---------------- | --------------- | ------- | ------ | --------------------------------------------------------- |
| <code>name</code>           | string          | 必填    | -      | 抽取JWT的请求header                                       |
| <code>value_prefix</code>   | string          | 必填    | -      | 对请求header的value去除此前缀，剩余部分作为JWT            |</p><p><code>claims_to_headers</code> 中每一项的配置字段说明如下：
| 名称             | 数据类型        | 填写要求| 默认值 | 描述                                                      |
| ---------------- | --------------- | ------- | ------ | --------------------------------------------------------- |
| <code>claim</code>          | string          | 必填    | -      | JWT payload中的指定字段，要求必须是字符串或无符号整数类型 |
| <code>header</code>         | string          | 必填    | -      | 从payload取出字段的值设置到这个请求头中，转发给后端       |
| <code>override</code>       | bool            | 选填    | true   | true时，存在同名请求头会进行覆盖；false时，追加同名请求头 |</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="域名和路由级配置">域名和路由级配置<a href="#域名和路由级配置" class="hash-link" aria-label="域名和路由级配置的直接链接" title="域名和路由级配置的直接链接">​</a></h3><table><thead><tr><th>名称</th><th>数据类型</th><th>填写要求</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>allow</code></td><td>array of string</td><td>必填</td><td>-</td><td>对于符合匹配条件的请求，配置允许访问的consumer名称</td></tr></tbody></table><p><strong>注意：</strong></p><ul><li>对于通过认证鉴权的请求，请求的header会被添加一个<code>X-Mse-Consumer</code>字段，用以标识调用者的名称。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置示例">配置示例<a href="#配置示例" class="hash-link" aria-label="配置示例的直接链接" title="配置示例的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="对特定路由或域名开启">对特定路由或域名开启<a href="#对特定路由或域名开启" class="hash-link" aria-label="对特定路由或域名开启的直接链接" title="对特定路由或域名开启的直接链接">​</a></h3><p>以下配置将对网关特定路由或域名开启 Jwt Auth 认证和鉴权，注意如果一个JWT能匹配多个<code>jwks</code>，则按照配置顺序命中第一个匹配的<code>consumer</code></p><p><strong>全局配置</strong></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">consumers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consumer1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> abcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jwks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;keys&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;kty&quot;: &quot;oct&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;kid&quot;: &quot;123&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;k&quot;: &quot;hM0k3AbXBPpKOGg__Ql2Obcq7s60myWDpbHXzgKUQdYo7YCRp0gUqkCnbGSvZ2rGEl4YFkKqIqW7mTHdj-bcqXpNr-NOznEyMpVPOIlqG_NWVC3dydBgcsIZIdD-MR2AQceEaxriPA_VmiUCwfwL2Bhs6_i7eolXoY11EapLQtutz0BV6ZxQQ4dYUmct--7PLNb4BWJyQeWu0QfbIthnvhYllyl2dgeLTEJT58wzFz5HeNMNz8ohY5K0XaKAe5cepryqoXLhA-V-O1OjSG8lCNdKS09OY6O0fkyweKEtuDfien5tHHSsHXoAxYEHPFcSRL4bFPLZ0orTt1_4zpyfew&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;alg&quot;: &quot;HS256&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consumer2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> abc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jwks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;keys&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;kty&quot;: &quot;RSA&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;e&quot;: &quot;AQAB&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;use&quot;: &quot;sig&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;kid&quot;: &quot;123&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;alg&quot;: &quot;RS256&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;n&quot;: &quot;i0B67f1jggT9QJlZ_8QL9QQ56LfurrqDhpuu8BxtVcfxrYmaXaCtqTn7OfCuca7cGHdrJIjq99rz890NmYFZuvhaZ-LMt2iyiSb9LZJAeJmHf7ecguXS_-4x3hvbsrgUDi9tlg7xxbqGYcrco3anmalAFxsbswtu2PAXLtTnUo6aYwZsWA6ksq4FL3-anPNL5oZUgIp3HGyhhLTLdlQcC83jzxbguOim-0OEz-N4fniTYRivK7MlibHKrJfO3xa_6whBS07HW4Ydc37ZN3Rx9Ov3ZyV0idFblU519nUdqp_inXj1eEpynlxH60Ys_aTU2POGZh_25KXGdF_ZC_MSRw&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">global_auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>路由级配置</strong></p><p>对 route-a 和 route-b 这两个路由做如下配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">allow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> consumer1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对 *.exmaple.com 和 test.com 在这两个域名做如下配置:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">allow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> consumer2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>每条匹配规则下的<code>allow</code>字段用于指定该匹配条件下允许访问的调用者列表；</p><p>若是在控制台进行配置，此例指定的 <code>route-a</code> 和 <code>route-b</code> 即在控制台创建路由时填写的路由名称，当匹配到这两个路由时，将允许<code>name</code>为<code>consumer1</code>的调用者访问，其他调用者不允许访问；</p><p>此例指定的 <code>*.example.com</code> 和 <code>test.com</code> 用于匹配请求的域名，当发现域名匹配时，将允许<code>name</code>为<code>consumer2</code>的调用者访问，其他调用者不允许访问。</p><p>认证成功后，请求的header中会被添加一个<code>X-Mse-Consumer</code>字段，其值为调用方的名称，例如<code>consumer-1</code>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="根据该配置下列请求可以允许访问">根据该配置，下列请求可以允许访问：<a href="#根据该配置下列请求可以允许访问" class="hash-link" aria-label="根据该配置，下列请求可以允许访问：的直接链接" title="根据该配置，下列请求可以允许访问：的直接链接">​</a></h4><p>假设以下请求会匹配到route-a这条路由</p><p><strong>将 JWT 设置在 url 参数中</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;http://xxx.hello.com/test?access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjEyMyJ9.eyJpc3MiOiJhYmNkIiwic3ViIjoidGVzdCIsImlhdCI6MTY2NTY2MDUyNywiZXhwIjoxODY1NjczODE5fQ.-vBSV0bKeDwQcuS6eeSZN9dLTUnSnZVk8eVCXdooCQ4&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>将 JWT 设置在 http 请求头中</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain">  http://xxx.hello.com/test -H </span><span class="token string" style="color:#e3116c">&#x27;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjEyMyJ9.eyJpc3MiOiJhYmNkIiwic3ViIjoidGVzdCIsImlhdCI6MTY2NTY2MDUyNywiZXhwIjoxODY1NjczODE5fQ.-vBSV0bKeDwQcuS6eeSZN9dLTUnSnZVk8eVCXdooCQ4&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>认证鉴权通过后，请求的header中会被添加一个<code>X-Mse-Consumer</code>字段，在此例中其值为<code>consumer1</code>，用以标识调用方的名称</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="下列请求将拒绝访问">下列请求将拒绝访问：<a href="#下列请求将拒绝访问" class="hash-link" aria-label="下列请求将拒绝访问：的直接链接" title="下列请求将拒绝访问：的直接链接">​</a></h4><p><strong>请求未提供JWT，返回401</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain">  http://xxx.hello.com/test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>根据请求提供的JWT匹配到的调用者无访问权限，返回403</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## consumer1不在*.example.com的allow列表里</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;http://xxx.example.com/test&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjEyMyJ9.eyJpc3MiOiJhYmNkIiwic3ViIjoidGVzdCIsImlhdCI6MTY2NTY2MDUyNywiZXhwIjoxODY1NjczODE5fQ.-vBSV0bKeDwQcuS6eeSZN9dLTUnSnZVk8eVCXdooCQ4&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="常见错误码说明">常见错误码说明<a href="#常见错误码说明" class="hash-link" aria-label="常见错误码说明的直接链接" title="常见错误码说明的直接链接">​</a></h3><table><thead><tr><th>HTTP 状态码</th><th>出错信息</th><th>原因说明</th></tr></thead><tbody><tr><td>401</td><td>Jwt missing</td><td>请求头未提供JWT</td></tr><tr><td>401</td><td>Jwt expired</td><td>JWT已经过期</td></tr><tr><td>401</td><td>Jwt verification fails</td><td>JWT payload校验失败，如iss不匹配</td></tr><tr><td>403</td><td>Access Denied</td><td>无权限访问当前路由</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="机制说明">机制说明<a href="#机制说明" class="hash-link" aria-label="机制说明的直接链接" title="机制说明的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1基于token的认证">1、基于token的认证<a href="#1基于token的认证" class="hash-link" aria-label="1、基于token的认证的直接链接" title="1、基于token的认证的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="11-简介">1.1 简介<a href="#11-简介" class="hash-link" aria-label="1.1 简介的直接链接" title="1.1 简介的直接链接">​</a></h4><p>很多对外开放的API需要识别请求者的身份，并据此判断所请求的资源是否可以返回给请求者。token就是一种用于身份验证的机制，基于这种机制，应用不需要在服务端保留用户的认证信息或者会话信息，可实现无状态、分布式的Web应用授权，为应用的扩展提供了便利。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="12-流程描述">1.2 流程描述<a href="#12-流程描述" class="hash-link" aria-label="1.2 流程描述的直接链接" title="1.2 流程描述的直接链接">​</a></h4><p><img loading="lazy" src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2336348951/p135822.png" class="img_ev3q"></p><p>上图是网关利用JWT实现认证的整个业务流程时序图，下面我们用文字来详细描述图中标注的步骤：</p><ol><li><p>客户端向API网关发起认证请求，请求中一般会携带终端用户的用户名和密码；</p></li><li><p>网关将请求直接转发给后端服务；</p></li><li><p>后端服务读取请求中的验证信息（比如用户名、密码）进行验证，验证通过后使用私钥生成标准的token，返回给网关；</p></li><li><p>网关将携带token的应答返回给客户端，客户端需要将这个token缓存到本地；</p></li><li><p>客户端向API网关发送业务请求，请求中携带token；</p></li><li><p>网关使用用户设定的公钥对请求中的token进行验证，验证通过后，将请求透传给后端服务；</p></li><li><p>后端服务进行业务处理后应答；</p></li><li><p>网关将业务应答返回给客户端。</p></li></ol><p>在这个整个过程中, 网关利用token认证机制，实现了用户使用自己的用户体系对自己API进行授权的能力。下面我们就要介绍网关实现token认证所使用的结构化令牌Json Web Token(JWT)。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="13-jwt">1.3 JWT<a href="#13-jwt" class="hash-link" aria-label="1.3 JWT的直接链接" title="1.3 JWT的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="131-简介">1.3.1 简介<a href="#131-简介" class="hash-link" aria-label="1.3.1 简介的直接链接" title="1.3.1 简介的直接链接">​</a></h5><p>Json Web Toke（JWT），是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准RFC7519。JWT一般可以用作独立的身份验证令牌，可以包含用户标识、用户角色和权限等信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，特别适用于分布式站点的登录场景。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="132-jwt的构成">1.3.2 JWT的构成<a href="#132-jwt的构成" class="hash-link" aria-label="1.3.2 JWT的构成的直接链接" title="1.3.2 JWT的构成的直接链接">​</a></h5><p><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</code></p><p>如上面的例子所示，JWT就是一个字符串，由三部分构成：</p><ul><li>Header（头部）</li><li>Payload（数据）</li><li>Signature（签名）</li></ul><p><strong>Header</strong></p><p>JWT的头部承载两个信息：</p><ul><li>声明类型，这里是JWT</li><li>声明加密的算法</li></ul><p>网关支持的加密算法如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ES256, ES384, ES512,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HS256, HS384, HS512,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RS256, RS384, RS512,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS256, PS384, PS512,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EdDSA</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>完整的头部就像下面这样的JSON：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&#x27;typ&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;JWT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&#x27;alg&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HS256&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后将头部进行Base64编码（该编码是可以对称解码的），构成了第一部分。</p><p><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</code></p><p><strong>Payload</strong></p><p>载荷就是存放有效信息的地方。定义细节如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iss：令牌颁发者。表示该令牌由谁创建，该声明是一个字符串</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub: Subject Identifier，iss提供的终端用户的标识，在iss范围内唯一，最长为255个ASCII个字符，区分大小写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aud：Audience(s)，令牌的受众，分大小写的字符串数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exp：Expiration time，令牌的过期时间戳。超过此时间的token会作废， 该声明是一个整数，是1970年1月1日以来的秒数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iat: 令牌的颁发时间，该声明是一个整数，是1970年1月1日以来的秒数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jti: 令牌的唯一标识，该声明的值在令牌颁发者创建的每一个令牌中都是唯一的，为了防止冲突，它通常是一个密码学随机值。这个值相当于向结构化令牌中加入了一个攻击者无法获得的随机熵组件，有利于防止令牌猜测攻击和重放攻击。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以新增用户系统需要使用的自定义字段，比如下面的例子添加了name 用户昵称：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1234567890&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;John Doe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后将其进行Base64编码，得到JWT的第二部分：</p><p><code>JTdCJTBBJTIwJTIwJTIyc3ViJTIyJTNBJTIwJTIyMTIzNDU2Nzg5MCUyMiUyQyUwQSUyMCUyMCUyMm5hbWUlMjIlM0ElMjAlMjJKb2huJTIwRG9lJTIyJTBBJTdE</code></p><p><strong>Signature</strong></p><p>这个部分需要Base64编码后的Header和Base64编码后的Payload使用 . 连接组成的字符串，然后通过Header中声明的加密方式进行加密（$secret 表示用户的私钥），然后就构成了jwt的第三部分。</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> encodedString </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">base64UrlEncode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">base64UrlEncode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> signature </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HMACSHA256</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">encodedString</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$secret&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将这三部分用 . 连接成一个完整的字符串，就构成了 1.3.2 节最开始的JWT示例。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="133-时效">1.3.3 时效<a href="#133-时效" class="hash-link" aria-label="1.3.3 时效的直接链接" title="1.3.3 时效的直接链接">​</a></h5><p>网关会验证token中的exp字段，一旦这个字段过期了，网关会认为这个token无效而将请求直接打回。过期时间这个值必须设置。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="134-jwt的几个特点">1.3.4 JWT的几个特点<a href="#134-jwt的几个特点" class="hash-link" aria-label="1.3.4 JWT的几个特点的直接链接" title="1.3.4 JWT的几个特点的直接链接">​</a></h5><ol><li>JWT 默认是不加密，不能将秘密数据写入 JWT。</li><li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</li><li>JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</li><li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li><li>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用HTTPS 协议传输。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2用户系统如何应用jwt插件保护api">2、用户系统如何应用JWT插件保护API<a href="#2用户系统如何应用jwt插件保护api" class="hash-link" aria-label="2、用户系统如何应用JWT插件保护API的直接链接" title="2、用户系统如何应用JWT插件保护API的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21-生成一对jwkjson-web-密钥">2.1 生成一对JWK（JSON Web 密钥）<a href="#21-生成一对jwkjson-web-密钥" class="hash-link" aria-label="2.1 生成一对JWK（JSON Web 密钥）的直接链接" title="2.1 生成一对JWK（JSON Web 密钥）的直接链接">​</a></h4><p><strong>方法一、在线生成：</strong></p><p>用户可以在这个站点<a href="https://mkjwk.org" target="_blank" rel="noopener noreferrer">https://mkjwk.org</a> 生成用于token生成与验证的私钥与公钥， 私钥用于授权服务签发JWT，公钥配置到JWT插件中用于网关对请求验签，注意网关使用的jwks格式配置，下图中Public Key需要放到keys结构体中，如：<code>{&quot;keys&quot;:[{&quot;kty&quot;:&quot;RSA&quot;,&quot;e&quot;:&quot;AQAB&quot;,...}]}</code></p><p><img loading="lazy" src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2336348951/p135823.png" alt="img" class="img_ev3q"></p><p><strong>方法二、本地生成：</strong></p><p>本文应用Java示例说明，其他语言用户也可以找到相关的工具生成密钥对。 新建一个Maven项目，加入如下依赖：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.bitbucket.b_c</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jose4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.7.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用如下的代码生成一对RSA密钥：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RsaJsonWebKey rsaJsonWebKey = RsaJwkGenerator.generateJwk(2048);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final String publicKeyString = rsaJsonWebKey.toJson(JsonWebKey.OutputControlLevel.PUBLIC_ONLY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final String privateKeyString = rsaJsonWebKey.toJson(JsonWebKey.OutputControlLevel.INCLUDE_PRIVATE);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="22-使用jwk中的私钥实现颁发token-的认证服务">2.2 使用JWK中的私钥实现颁发token 的认证服务<a href="#22-使用jwk中的私钥实现颁发token-的认证服务" class="hash-link" aria-label="2.2 使用JWK中的私钥实现颁发token 的认证服务的直接链接" title="2.2 使用JWK中的私钥实现颁发token 的认证服务的直接链接">​</a></h4><p>需要使用2.1节中在线生成的 Keypair JSON字符串（三个方框内的第一个）或者本地生成的 privateKeyString JSON字符串作为私钥来颁发token，用于授权可信的用户访问受保护的API，具体实现可以参考下方示例。 向客户颁发token的形式由用户根据具体的业务场景决定，可以将颁发token的功能部署到生产环境，配置成普通API后由访问者通过用户名密码获得，也可以直接在本地环境生成token 后，直接拷贝给指定用户使用。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.security.PrivateKey; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.json.JsonUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.jwk.RsaJsonWebKey;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.jwk.RsaJwkGenerator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.jws.AlgorithmIdentifiers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.jws.JsonWebSignature;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.jwt.JwtClaims;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.jwt.NumericDate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.jose4j.lang.JoseException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class GenerateJwtDemo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws JoseException  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String keyId = &quot;uniq_key&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          //使用本文2.1节生成的Keypair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String privateKeyJson = &quot;{\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;  \&quot;kty\&quot;: \&quot;RSA\&quot;,\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;  \&quot;d\&quot;: &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;\&quot;O9MJSOgcjjiVMNJ4jmBAh0mRHF_TlaVva70Imghtlgwxl8BLfcf1S8ueN1PD7xV6Cnq8YenSKsfiNOhC6yZ_fjW1syn5raWfj68eR7cjHWjLOvKjwVY33GBPNOvspNhVAFzeqfWneRTBbga53Agb6jjN0SUcZdJgnelzz5JNdOGaLzhacjH6YPJKpbuzCQYPkWtoZHDqWTzCSb4mJ3n0NRTsWy7Pm8LwG_Fd3pACl7JIY38IanPQDLoighFfo-Lriv5z3IdlhwbPnx0tk9sBwQBTRdZ8JkqqYkxUiB06phwr7mAnKEpQJ6HvhZBQ1cCnYZ_nIlrX9-I7qomrlE1UoQ\&quot;,\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;  \&quot;e\&quot;: \&quot;AQAB\&quot;,\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;  \&quot;alg\&quot;: \&quot;RS256\&quot;,\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;  \&quot;n\&quot;: \&quot;vCuB8MgwPZfziMSytEbBoOEwxsG7XI3MaVMoocziP4SjzU4IuWuE_DodbOHQwb_thUru57_Efe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;--sfATHEa0Odv5ny3QbByqsvjyeHk6ZE4mSAV9BsHYa6GWAgEZtnDceeeDc0y76utXK2XHhC1Pysi2KG8KAzqDa099Yh7s31AyoueoMnrYTmWfEyDsQL_OAIiwgXakkS5U8QyXmWicCwXntDzkIMh8MjfPskesyli0XQD1AmCXVV3h2Opm1Amx0ggSOOiINUR5YRD6mKo49_cN-nrJWjtwSouqDdxHYP-4c7epuTcdS6kQHiQERBd1ejdpAxV4c0t0FHF7MOy9kw\&quot;\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JwtClaims claims = new JwtClaims();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setGeneratedJwtId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setIssuedAtToNow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //过期时间一定要设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NumericDate date = NumericDate.now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        date.addSeconds(120*60);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setExpirationTime(date);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setNotBeforeMinutesInThePast(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setSubject(&quot;YOUR_SUBJECT&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setAudience(&quot;YOUR_AUDIENCE&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //添加自定义参数，所有值请都使用String类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setClaim(&quot;userId&quot;, &quot;1213234&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.setClaim(&quot;email&quot;, &quot;userEmail@youapp.com&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonWebSignature jws = new JsonWebSignature();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jws.setAlgorithmHeaderValue(AlgorithmIdentifiers.RSA_USING_SHA256);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jws.setKeyIdHeaderValue(keyId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jws.setPayload(claims.toJson());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PrivateKey privateKey = new RsaJsonWebKey(JsonUtil.parseJson(privateKeyJson)).getPrivateKey();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jws.setKey(privateKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String jwtResult = jws.getCompactSerialization();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Generate Json Web token , result is &quot; + jwtResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/higress-group/higress-group.github.io/blob/main/i18n/zh-cn/docusaurus-plugin-content-docs/current/plugins/jwt-auth.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/docs/plugins/custom"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">自定义插件</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/docs/plugins/hmac-auth"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">HMAC 认证</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#功能说明" class="table-of-contents__link toc-highlight">功能说明</a></li><li><a href="#运行属性" class="table-of-contents__link toc-highlight">运行属性</a></li><li><a href="#配置字段" class="table-of-contents__link toc-highlight">配置字段</a><ul><li><a href="#全局配置" class="table-of-contents__link toc-highlight">全局配置</a></li><li><a href="#域名和路由级配置" class="table-of-contents__link toc-highlight">域名和路由级配置</a></li></ul></li><li><a href="#配置示例" class="table-of-contents__link toc-highlight">配置示例</a><ul><li><a href="#对特定路由或域名开启" class="table-of-contents__link toc-highlight">对特定路由或域名开启</a></li><li><a href="#常见错误码说明" class="table-of-contents__link toc-highlight">常见错误码说明</a></li></ul></li><li><a href="#机制说明" class="table-of-contents__link toc-highlight">机制说明</a><ul><li><a href="#1基于token的认证" class="table-of-contents__link toc-highlight">1、基于token的认证</a></li><li><a href="#2用户系统如何应用jwt插件保护api" class="table-of-contents__link toc-highlight">2、用户系统如何应用JWT插件保护API</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">为用户提供一站式云原生网关解决方案.</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-higress">Higress是什么?</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Higress<br>浙公网安备 33011002016922号 浙ICP备12022327号-1119</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.5373e763.js"></script>
<script src="/zh-cn/assets/js/main.4ab561ca.js"></script>
</body>
</html>