<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Higress Blog</title>
        <link>https://higress.io/zh-cn/blog</link>
        <description>Higress Blog</description>
        <lastBuildDate>Fri, 27 Oct 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh-cn</language>
        <item>
            <title><![CDATA[通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能]]></title>
            <link>https://higress.io/zh-cn/blog/plugin-transformer</link>
            <guid>https://higress.io/zh-cn/blog/plugin-transformer</guid>
            <pubDate>Fri, 27 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能]]></description>
            <content:encoded><![CDATA[<blockquote><p>导读: 本文将和大家一同回顾 Spring Cloud Gateway 是如何满足 HTTP 请求/响应转换需求场景的，并为大家介绍在这种场景下使用 Higress 云原生网关的解决方案，同时还对比了两者的性能差异。</p></blockquote><h1>1. SCG 修改请求/响应</h1><p>在 <a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/" target="_blank" rel="noopener noreferrer">Spring Cloud Gateway</a> (以下简称为 SCG) 中，当我们需要对 HTTP 请求或响应进行修改时，SCG 提供了许多内置的 <a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreferrer">GatewayFilter</a> 来满足我们对这种应用场景的需求，例如 AddRequestHeader,AddRequestParameter, DedupeResponseHeader,MapRequestHeader, ModifyRequestBody 等。</p><p>考虑以下简单用例：</p><ul><li>添加请求头部 X-First，值从请求路径中获取，例如从 /response-headers?testKey=testValue 中获取 "response-headers"；</li><li>将请求头部 X-First 的值映射给 X-Second；</li><li>添加请求查询参数 k1=v1；</li><li>剔除重复的响应头部 X-Dedupe。</li></ul><p>在 SCG 中使用 GatewayFilter 我们可以这样配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># application.yaml:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//httpbin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> MapRequestHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestParameter=k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DedupeResponseHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RETAIN_FIRST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相信拥有 SCG 使用经验的同学对上述配置一定不陌生，那么本文将重点给出另一种能够<strong>满足上述需求并且性能更加优越的解决方案——使用 Higress 云原生网关的 Transformer 插件</strong>。</p><h1>2. Higress 插件与 SCG 性能比较</h1><p>我们在同一吞吐量水平（QPS）上，开启/关闭 <a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/transformer" target="_blank" rel="noopener noreferrer">Higress Transformer 插件</a> 和 SCG 相应 GatewayFilters，统计两者在 CPU 和内存资源上的开销。</p><p>经过<a href="https://gist.github.com/WeixinX/c24f4ded37832dd7e753b2d27470f0fc" target="_blank" rel="noopener noreferrer">测试</a>，我们得到的结论是：</p><ul><li>在 Higress 未启用 Transformer 插件，SCG 未启用 GatewayFilters 的条件下，SCG 的 CPU, 内存资源开销分别约为 Higress的 3.30, 4.88倍；</li><li>在 Higress 启用 Transformer 插件，SCG 启用相应 GatewayFilters 的条件下，SCG 的 CPU,内存资源开销分别约为 Higress 的 2.98, 3.19倍。</li></ul><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/61d3ec0b-b708-41e6-9f28-96108b4b55c6" alt="相同 QPS 下的 CPU 开销" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/a60415d5-bed6-47cf-a976-b8e55a818e14" alt="相同 QPS 下的内存开销" class="img_ev3q"></p><p><strong>可见 Higress Transformer 相比于 SCG GatewayFilter 有着相当不错的性能表现！</strong></p><p>接下来我们将进一步为大家介绍 Higress 云原生网关以及上述提到的 Higress Transformer 插件。</p><h1>3. Higress 简介</h1><p><a href="https://higress.io/zh-cn/" target="_blank" rel="noopener noreferrer">Higress</a> 是基于阿里内部的 Envoy Gateway 实践沉淀、以开源 Istio + Envoy 为核心构建的下一代云原生网关，实现了流量网关+微服务网关+安全网关三合一的高集成能力，深度集成 Dubbo、Nacos、Sentinel 等微服务技术栈，能够帮助用户极大地降低网关的部署及运维成本且能力不打折；在标准上全面支持 Ingress 与 Gateway API，积极拥抱云原生下的标准 API 规范；同时，Higress Controller 也支持 Nginx Ingress 平滑迁移，帮助用户零成本快速迁移到 Higress。
Higress 提供了一套 <a href="https://github.com/alibaba/higress/tree/main/plugins" target="_blank" rel="noopener noreferrer">Wasm (WebAssembly) SDK</a>，使得开发者能够轻松使用 C++，Golang，Rust 开发 Wasm 插件增强网关能力。下面将为大家介绍 Higress Transformer 插件的基本功能，最后简单说明 Transformer 插件的核心代码逻辑。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/c93bc55d-8cca-47ac-8b63-64168626f9a9" alt="Higress Architecture" class="img_ev3q"></p><h1>4. Transformer 插件介绍</h1><p>Higress Transformer 插件可以对请求/响应头部、请求查询参数、请求/响应体参数进行转换，支持的转换操作类型包括删除（remove）、重命名（rename）、更新（replace）、添加（add）、追加（append）、映射（map）和去重（dedupe）。</p><p>接下来我们复现最开始提到的 SCG GatewayFilter 简单用例，来演示如何使用该插件（以下使用 Higress 控制台可以很方便地部署插件，当然也可以使用 <a href="https://github.com/higress-group/higress-demo/tree/main/wasm-demo/wasm-plugin-transformer" target="_blank" rel="noopener noreferrer">K8s YAML Manifests 的方式</a>）：</p><ol><li>首先根据<a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">官方文档</a> 快速安装 Higress，结果如下：</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n higress-system get deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-grafana      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-prometheus   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-controller           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-gateway              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>通过 Higress 控制台添加域名（foo.bar.com）、路由配置（foo），将流量转发至后端的 <a href="https://httpbin.org/" target="_blank" rel="noopener noreferrer">httpbin</a> 服务：</li></ol><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/4a6b2ed0-f42b-4ffa-8b36-99f7444a9e5f" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/151442fd-b43a-40e3-8fcf-7afa49f69af9" alt="image" class="img_ev3q"></p><ol start="3"><li>为 foo 路由添加 Transformer 插件（当前未推送插件至官方镜像仓库，可以先使用 docker.io/weixinx/transformer:v0.1.0，或到代码仓库自行构建）：</li></ol><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/fb522095-ee88-4f77-89c2-8a8547a3a96f" alt="image" class="img_ev3q"></p><p>注：为了能够同时完成请求和响应转换的需求，我们需要为 foo 路由再添加一个 Transformer 插件，命名为 transformer-resp，用于处理响应方向。</p><ol start="4"><li>添加 Transformer 配置并开启该插件：</li></ol><ul><li>添加请求头部 X-First，值从请求路径中获取，例如从 /response-headers?testKey=testValue 中获取 "response-headers"；</li><li>将请求头部 X-First 的值映射给 X-Second；</li><li>添加请求查询参数 k1=v1；</li><li>剔除重复的响应头部 X-Dedupe。</li></ul><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># transformer:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request  </span><span class="token comment" style="color:#999988;font-style:italic"># 指定 Transformer 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 指定转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> add </span><span class="token comment" style="color:#999988;font-style:italic"># 指定转换操作类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 指定头部转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $1  </span><span class="token comment" style="color:#999988;font-style:italic"># 正则表达式捕获组 $1，支持 RE2 语法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path_pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ^\/(\w+)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">\</span><span class="token punctuation" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.</span><span class="token important">*$</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">querys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 指定查询参数转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># transformer-resp:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dedupe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RETAIN_FIRST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li>发送请求进行测试：</li></ol><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 验证请求方向转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">$ curl -v -H "host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com" "console.higress.io/get"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">"args"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了查询参数 k1=v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">"k1"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">"headers"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">"X-First"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"get"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了请求头部 X-First，值 "get" 来自请求路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">"X-Second"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"get"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 映射了请求头部 X-Second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了查询参数 k1=v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">"url"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http://foo.bar.com/get?k1=v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证响应方向转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">$ curl -v -H "host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">"console.higress.io/response</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe=1</span><span class="token important">&amp;X-Dedupe=2&amp;X-Dedupe=3"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">&lt; x-dedupe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 保留了响应头部 X-Dedupe 的第一个值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 通过查询参数传给 httpbin 的自定义响应头部</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">"X-Dedupe"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"3"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>❗️需要注意的是：</p><ul><li>与上述例子相同，若有同时处理请求和响应转换的需求，则需要为相应路由添加两个 Transformer 插件，分别处理请求方向和响应方向（正在优化）；</li><li>请求体支持的 Content-Type 有：application/json, application/x-www-form-urlencoded, multipart/form-data；而响应体仅支持 application/json；</li><li>更多说明详见<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/transformer" target="_blank" rel="noopener noreferrer">插件文档</a>。</li></ul><h1>5. Transformer 逻辑</h1><p>本节将简单说明 Higress Transformer 插件的核心代码逻辑，希望可以为有兴趣优化该插件或进行二次开发的同学提供一些帮助。</p><p>首先该插件代码位于Higress 仓库的 plugins/wasm-go/extensions/transformer 目录下，使用 Higress 提供的 <a href="https://github.com/alibaba/higress/tree/main/plugins" target="_blank" rel="noopener noreferrer">Wasm SDK</a> 进行开发（关于如何开发 Wasm 插件详见<a href="https://higress.io/zh-cn/docs/user/wasm-go" target="_blank" rel="noopener noreferrer">官方文档</a>）。</p><p>插件的配置模型 TransformerConfig：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 模型以插件配置的形式暴露给用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TransformerConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  typ   </span><span class="token builtin">string</span><span class="token plain">          # Transformer 类型，</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">TransformRule # 转换规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  trans Transformer # Transformer 实例，不对用户暴露配置，用于实际的转换操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TransformRule </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  operate </span><span class="token builtin">string</span><span class="token plain">   # 转换操作类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  headers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # header 参数 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  querys  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # query 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  body    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # body 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Param </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key         </span><span class="token builtin">string</span><span class="token plain"> # 表示字段的 key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       </span><span class="token builtin">string</span><span class="token plain"> # 表示字段的 value 或 key </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 或 strategy </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dedupe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  valueType   </span><span class="token builtin">string</span><span class="token plain"> # 为 application</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">json body 指定 value 的数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostPattern </span><span class="token builtin">string</span><span class="token plain"> # host 正则匹配模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pathPattern </span><span class="token builtin">string</span><span class="token plain"> # path 正则匹配模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 Transformer 作为接口分别有请求和响应两个实现（requestTransformer, responseTransformer），主要实现了 3 个接口方法 TransformHeaders,TransformerQuerys 和 TransformBody：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Transformer </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformQuerys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> Transformer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">requestTransformer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> Transformer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">responseTransformer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于头部（Headers）和查询参数（Querys）都是以 key-value 的形式存在，因此通过 kvHandler 对两者采用统一的处理逻辑；而 Body 由于请求、响应支持不同的 Content-Type，因此分别通过 requestBodyHandler (kvHandler, jsonHandler 组合)和 responseBodyHandler (jsonHandler) 进行处理。综上，在修改该插件逻辑时，主要对 kvHandler 和 jsonHandler 进行修改即可，其中 jsonHandler 依赖 <a href="https://github.com/tidwall/gjson" target="_blank" rel="noopener noreferrer">GJSON</a> 和 <a href="https://github.com/tidwall/sjson" target="_blank" rel="noopener noreferrer">SJSON</a> 工具库。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/fc08ff0c-12ec-4dfd-b946-4e83f8431174" alt="image" class="img_ev3q"></p><p>目前 handler 中的转换顺序是被硬编码的（remove -&gt; rename -&gt; replace -&gt; add -&gt; append -&gt; map -&gt; dedupe），我们对此有优化的打算，也欢迎感兴趣的同学参与进来 ~</p><h1>6. 总结</h1><p>本文带大家了解了 Higress Transformer 插件，并与 Spring Cloud Gateway 进行了性能比较，在文章的最后还说明了该插件的核心代码逻辑，希望能够为大家从 Spring Cloud Gateway 迁移至 Higress 提供帮助！</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/c2a47afd-5f29-4cfc-b5c5-571d2265ec19" alt="image" class="img_ev3q"></p><p>如果您觉得 Higress 对您有帮助，欢迎前往 <a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">Github: Higress</a> 为我们 star⭐️ 一下！期待与您在 Higress 社区相遇 ~</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress在2023 KubeCon China的分享]]></title>
            <link>https://higress.io/zh-cn/blog/2023-kubecon</link>
            <guid>https://higress.io/zh-cn/blog/2023-kubecon</guid>
            <pubDate>Thu, 28 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[看K8s资深运维如何选型Ingress网关]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分享简介">分享简介<a href="#分享简介" class="hash-link" aria-label="分享简介的直接链接" title="分享简介的直接链接">​</a></h2><p>在9月26日的2023 KubeCon阿里云云原生开放日，Higress的分享内容分为两部分：</p><p>Part 1. 由上海费芮网络科技系统运维副总监戴喜军，带来费芮在选型企业版Higress作为K8s Ingress替代Nginx Ingress的介绍</p><p>Part 2. 由Higress开源社区负责人澄潭，带来Higress开源项目的介绍</p><p>开源版和企业版是Higress的一体两面，通过本次分享，相信大家会对Higress有更全面的了解。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-1-费芮互动使用higress作为kubernetes-ingress实现稳定性和性能提升">Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升<a href="#part-1-费芮互动使用higress作为kubernetes-ingress实现稳定性和性能提升" class="hash-link" aria-label="Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升的直接链接" title="Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升的直接链接">​</a></h2><p>费芮通过Higress解决了原本Nginx Ingress网关的诸多痛点，性能提升90%，响应时间下降50%，并大幅提升业务入口的稳定及安全性，高效支撑每日1亿+粉丝交互， 4万+线下门店、每月3000万+笔的移动支付需求。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="费芮业务场景">费芮业务场景<a href="#费芮业务场景" class="hash-link" aria-label="费芮业务场景的直接链接" title="费芮业务场景的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/0d4f761d-1471-49b6-a03c-38b11304262d" alt="image" class="img_ev3q">
<img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/dba8ae2a-93c8-4368-af3d-739f97090d39" alt="image" class="img_ev3q"></p><p>费芮专注于移动营销、O2O、社交媒体、移动电商领域的创新与研发。费芮互动自主研发的自媒体平台运维超过2亿粉丝 ； 有超过4万家线下门店采用费芮O2O解决方案。费芮的主要客户包括优衣库，必胜客，肯德基，星巴克，SPG，欧莱雅，Innisfree，迪卡侬，顶新集团等。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/61791bae-b40c-4b90-bc4d-c23bc052911c" alt="image" class="img_ev3q"></p><p>费芮内部业务系统的日均发布次数达到100次之多，会涉及到400多条Ingress路由规则的日常更新，且网关每天需要承载的PV流量达到了1个亿。Ingress网关的性能和稳定性至关重要。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-ingress-痛点">Nginx Ingress 痛点<a href="#nginx-ingress-痛点" class="hash-link" aria-label="Nginx Ingress 痛点的直接链接" title="Nginx Ingress 痛点的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/1d8a178e-05de-4114-96b3-7d4e11240374" alt="image" class="img_ev3q"></p><p>配置变更频繁，导致Nginx进程频繁重启，大量连接瞬时断开后并发重连会导致后端服务产生压力，严重时造成大量请求失败。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/52e6ff5a-7374-4fe9-b001-ff6d3ac97744" alt="image" class="img_ev3q"></p><p>Nginx Ingress的Controller组件和Nginx组件运行在同一个POD中，控制面资源使用还会影响到数据面的性能。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/b09a3db4-465b-46b8-8e35-bd274388f143" alt="image" class="img_ev3q"></p><p>Nginx Ingress还缺少面向服务限流的能力，只能实现面向单个来源IP限流，对于后端服务保护来说没有意义。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-收益">Higress 收益<a href="#higress-收益" class="hash-link" aria-label="Higress 收益的直接链接" title="Higress 收益的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/48388f01-7796-4f7d-b7d1-fb7bd1522925" alt="image" class="img_ev3q"></p><p>Higress企业版采用了全托管架构，与业务集群分离，无需自己运维，稳定性有更好保障。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/5e689364-fb08-4ec1-9d71-49539da561b8" alt="image" class="img_ev3q"></p><p>配置更新都是动态加载，无需重启数据面，保障业务平稳发布，websocket连接的业务收益也特别明显，长连接可以始终保持不会断开。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/29ae8168-e84d-41fb-bb4f-a258c4200a7e" alt="image" class="img_ev3q"></p><p>开启了TLS硬件加速，TLS握手时延直接减半，QPS吞吐提升86%。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/4ace2996-5b5a-4331-90cb-8448c65042d5" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/8664f436-c058-42bc-82c9-7355d24592ad" alt="image" class="img_ev3q"></p><p>开启WAF对吞吐影响还是比较明显的，下降了30%，但相比Ingress Nginx直接下降了90%，性能提升还是很明显，而且更大的优势是基于阿里云WAF产品，防护规则是实时更新的，而非Modsecurity的静态规则。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/10fca63d-a0bb-45a1-82ee-de115bf577e7" alt="image" class="img_ev3q"></p><p>Higress集成了Sentinel限流的能力，可以直接面向服务的QPS吞吐上限/并发数上线进行限流，并且相比Nginx只能配置单机限制阈值，需要关注网关节点数量，Higress这里的配置是全局阈值，不受网关扩缩容影响。</p><p>触发限流后可以自定义响应内容或者重定向到指定地址，都是很实用的能力。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-2-higress开源之路扎根开源生态定义云原生网关">Part 2. Higress开源之路：扎根开源生态，定义云原生网关<a href="#part-2-higress开源之路扎根开源生态定义云原生网关" class="hash-link" aria-label="Part 2. Higress开源之路：扎根开源生态，定义云原生网关的直接链接" title="Part 2. Higress开源之路：扎根开源生态，定义云原生网关的直接链接">​</a></h2><p>开源是云原生生态的基石，Higress也是借助了开源生态的力量，站在Istio/Envoy的肩膀上开发出了更多实用的功能，我们选择将MSE Higress（企业版）中的核心能力全部开源，决心扎根在开源生态中，让Higress变得更普惠，有更多人使用，从而让Higress更加强大。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/438dcf9a-96fa-4d0d-89ed-e810746c61ab" alt="image" class="img_ev3q"></p><p>Higress实际上有三次诞生过程：第一次是在阿里集团内部业务需求驱动下诞生；第二次是随着内部使用逐渐成熟沉淀为阿里云上的MSE Higress云原生网关产品；第三次是随着云产品成熟，2022年11月在云栖大会上正式宣布开源。2023年5月Release了第一个GA版本，意味着开源版本也走入成熟阶段。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/783b96cc-b628-4784-a6cf-c2cf10e11f3f" alt="image" class="img_ev3q"></p><p>从配置流转的过程来看Higress的架构：</p><ol><li>首先用户可以通过UI控制台/命令行工具多种方式来下发配置</li><li>到了控制面，如果是K8s下，配置持久化基于CRD，如果不是K8s，配置持久化基于Nacos</li><li>除了用户下发的路由配置，实现服务路由还需要的服务IP地址信息，支持从K8s service/Nacos/Eureka/Consul/ZooKeeper/DNS/固定IP等多种方式获取</li><li>Higress数据面是基于Envoy，配置通过xDS下发，这里复用了Istio的配置下发机制，因为是内置了这个机制，无需单独部署Istio</li><li>最终配置下发到数据面生效，Higress基于Envoy扩展了很多能力，而且基于Wasm扩展机制，可以很方便开发自定义插件，且具备全局/域名/路由维度的生效粒度</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心能力">核心能力<a href="#核心能力" class="hash-link" aria-label="核心能力的直接链接" title="核心能力的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/be02b599-f82f-42be-a8e5-82f69b9196b8" alt="image" class="img_ev3q">
<img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/4dc3cc2b-d6fe-4717-a53a-3e75c5f826ca" alt="image" class="img_ev3q"></p><p>高集成：同时集成经典微服务生态和K8s开源生态能力，可以帮助业务从传统架构迁移到云原生架构，基于流量灰度等能力，可以保障这一过程的平滑</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/87f8eacd-39b6-4a26-a7a1-b78f6a5abb4f" alt="image" class="img_ev3q"></p><p>标准化：兼容Nginx Ingress常用注解，基于统一的Ingress标准可以轻松实现Nginx到Higress这一技术鸿沟的跨越，Higress也已经支持Gateway API，路由标准本身也能借助Higress实现平滑升级</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/33776d12-baf3-4d09-ae42-a5cadb655bef" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/b9e4a718-c985-4ac4-9b7b-46a427ccb987" alt="image" class="img_ev3q"></p><p>易扩展：借助Higress的Wasm SDK，很少的业务代码就可以开发一个灵活的插件；并且支持基于OCI镜像标准分发，可以让插件的文档，配置约束等跟随插件本身一起被分发和共享；和传统Nginx类网关最大的差别，在于插件的分发集成阶段，实现了插件版本更新跟网关自身版本更新的解耦。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/d037bd1d-89c1-4f9c-b489-857b46de31ca" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/65f71cee-09d9-4e7b-aa6e-bd4c9a60de83" alt="image" class="img_ev3q"></p><p>热更新：Envoy相比Nginx更合理的配置系统抽象，让Higress具备了Nginx Ingress无法实现的配置热更新能力</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="回顾与展望">回顾与展望<a href="#回顾与展望" class="hash-link" aria-label="回顾与展望的直接链接" title="回顾与展望的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/f46c4d68-8e31-44bb-afc6-c02c9fccb105" alt="image" class="img_ev3q"></p><p>Higress开源的前半年，专注于开源生态的打通和易用性的提升，并基于Github Action构建了开源的集成测试体系，来保障项目质量，在今年5月份发布第一个GA稳定版本后，在多个核心社区开发者的努力下，我们又很快发布了1.1和1.2两个大版本，推出了非K8s部署/Knative支持等重量级功能。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/3ba10a71-b3f0-4ede-a150-c64e0b1003c4" alt="image" class="img_ev3q"></p><p>未来的RoadMap，Higress会聚焦在Gateway API/插件生态/API管理三个方向上，随着社区开发团队的不断壮大，Higress已经建立了多个不同方向的<a href="https://github.com/alibaba/higress/issues/547" target="_blank" rel="noopener noreferrer">SIG</a> 并行推进核心功能演进，未来将不断有重量级功能推出，尽请期待。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="直播回看">直播回看<a href="#直播回看" class="hash-link" aria-label="直播回看的直接链接" title="直播回看的直接链接">​</a></h2><p><a href="https://www.aliyun.com/activity/middleware/CloudNative_Meetup" target="_blank" rel="noopener noreferrer">https://www.aliyun.com/activity/middleware/CloudNative_Meetup</a></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[基于文件配置实现 Higress 极简独立部署]]></title>
            <link>https://higress.io/zh-cn/blog/config-with-file</link>
            <guid>https://higress.io/zh-cn/blog/config-with-file</guid>
            <pubDate>Fri, 25 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[介绍如何使用文件来管理 Higress 配置信息并实现独立部署]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前置准备">前置准备<a href="#前置准备" class="hash-link" aria-label="前置准备的直接链接" title="前置准备的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装-docker-compose">安装 Docker Compose<a href="#安装-docker-compose" class="hash-link" aria-label="安装 Docker Compose的直接链接" title="安装 Docker Compose的直接链接">​</a></h3><p>请参考 Docker 官方文档来安装 Docker Engine，其中已经内置了 Docker Compose 组件：<a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/engine/install/</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境验证">环境验证<a href="#环境验证" class="hash-link" aria-label="环境验证的直接链接" title="环境验证的直接链接">​</a></h3><ol><li>启动终端；</li><li>执行 <code>docker compose version</code> 命令，确认可以正常输出 Docker Compose 的版本。<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Docker Compose version v2.20.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-higrees">安装 Higrees<a href="#安装-higrees" class="hash-link" aria-label="安装 Higrees的直接链接" title="安装 Higrees的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="确定配置目录">确定配置目录<a href="#确定配置目录" class="hash-link" aria-label="确定配置目录的直接链接" title="确定配置目录的直接链接">​</a></h3><p>由于这次我们准备使用文件来管理 Higress 的配置数据，所以需要先确定保存配置文件的目录。下面我们将以 <code>~/higress/conf</code> 目录为例进行介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="执行安装">执行安装<a href="#执行安装" class="hash-link" aria-label="执行安装的直接链接" title="执行安装的直接链接">​</a></h3><p>启动终端，并执行以下命令：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -fsSL https://higress.io/standalone/get-higress.sh | bash -s -- -c file://~/higress/conf -p &lt;你的密码&gt; -a</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请耐心等待安装过程执行完毕。Higress 的执行文件将被安装在当前目录下的 <code>higress</code> 子目录内。配置数据则将被写入 <code>~/higress/conf</code> 目录内。</p><p>在安装完成后，脚本会自动启动 Higress。当终端输出如下信息时，则说明 Higress 已安装完成并成功启动。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Higress is now started. You can check out its status by executing /home/ch3cho/higress/bin/status.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Higress Gateway is listening on:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http://0.0.0.0:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://0.0.0.0:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Visit Higress Console: http://localhost:8080/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-路由配置">Higress 路由配置<a href="#higress-路由配置" class="hash-link" aria-label="Higress 路由配置的直接链接" title="Higress 路由配置的直接链接">​</a></h3><p>为了着重说明基于文件的路由配置方式，这里将不再展开介绍使用 Higress 控制台来进行配置的具体步骤。如有需要，大家可以查阅其他文档。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建服务来源">创建服务来源<a href="#创建服务来源" class="hash-link" aria-label="创建服务来源的直接链接" title="创建服务来源的直接链接">​</a></h4><p>使用文本编辑器将以下内容写入 <code>~/higress/conf/mcpbridges/default.yaml</code> 文件中：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建域名配置">创建域名配置<a href="#创建域名配置" class="hash-link" aria-label="创建域名配置的直接链接" title="创建域名配置的直接链接">​</a></h4><p>使用文本编辑器将以下内容写入 <code>~/higress/conf/configmaps/domain-foo.bar.com.yaml</code> 文件中：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> domain</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foo.bar.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">enableHttps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"off"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建服务路由">创建服务路由<a href="#创建服务路由" class="hash-link" aria-label="创建服务路由的直接链接" title="创建服务路由的直接链接">​</a></h4><p>使用文本编辑器将以下内容写入 <code>~/higress/conf/ingresses/route-foo-bar.yaml</code> 文件中：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin.dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/ignore-path-case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"false"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> route</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ingressClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="请求验证">请求验证<a href="#请求验证" class="hash-link" aria-label="请求验证的直接链接" title="请求验证的直接链接">​</a></h3><p>在终端中执行以下命令：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://localhost/get?foo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bar -H </span><span class="token string" style="color:#e3116c">'Host: foo.bar.com'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请求应返回一段包含请求信息的 JSON 数据：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"args"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"foo"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bar"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"headers"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Accept"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*/*"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Host"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"foo.bar.com"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Original-Host"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"foo.bar.com"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Req-Start-Time"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1693049173053"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"User-Agent"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"curl/8.1.2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-Amzn-Trace-Id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Root=1-11111111-111111111111111111111111"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-B3-Sampled"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-B3-Spanid"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2222222222222222"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-B3-Traceid"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"33333333333333333333333333333333"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-Envoy-Attempt-Count"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-Envoy-Decorator-Operation"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"httpbin.dns:80/*"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"X-Envoy-Internal"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"true"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"origin"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"192.168.16.1, 123.123.123.123"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"url"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http://foo.bar.com/get?foo=bar"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="已知问题">已知问题<a href="#已知问题" class="hash-link" aria-label="已知问题的直接链接" title="已知问题的直接链接">​</a></h2><p>在 Windows 操作系统中，直接修改挂载到 Docker 容器中的本地文件后，容器内的进程无法收到通知（详情请查看 <a href="https://github.com/fsnotify/fsnotify/issues/292" target="_blank" rel="noopener noreferrer">fsnotify/fsnotify #292</a>）。如果要使用文件来保存配置数据的话，在直接修改配置文件后，Higress 无法立即加载到新的配置。如果需要在 Windows 上独立部署 Higress 网关，可以考虑通过 Higress Console 来管理配置信息，或使用 Nacos 保存网关配置。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文档">参考文档<a href="#参考文档" class="hash-link" aria-label="参考文档的直接链接" title="参考文档的直接链接">​</a></h2><p>更多相关信息与 Higress 的其他部署方式可查阅以下文档：</p><ul><li><a href="/zh-cn/docs/user/quickstart">快速开始</a></li><li><a href="/zh-cn/docs/ops/deploy-by-helm">使用 Helm 进行云原生部署</a></li><li><a href="/zh-cn/docs/ops/deploy-by-docker-compose">基于 Docker Compose 进行独立部署</a></li></ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Windows 下 Higress 部署实践]]></title>
            <link>https://higress.io/zh-cn/blog/DeployOnWindows</link>
            <guid>https://higress.io/zh-cn/blog/DeployOnWindows</guid>
            <pubDate>Fri, 28 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Windows部署Higress]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前置准备">前置准备<a href="#前置准备" class="hash-link" aria-label="前置准备的直接链接" title="前置准备的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-wsl2">配置 WSL2<a href="#配置-wsl2" class="hash-link" aria-label="配置 WSL2的直接链接" title="配置 WSL2的直接链接">​</a></h3><p>详情参看步骤1-5,顺便在微软商店中下载Terminal。</p><p><a href="https://learn.microsoft.com/zh-cn/windows/wsl/install-manual" target="_blank" rel="noopener noreferrer">WSL手动安装步骤</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载-docker-desktop">下载 Docker Desktop<a href="#下载-docker-desktop" class="hash-link" aria-label="下载 Docker Desktop的直接链接" title="下载 Docker Desktop的直接链接">​</a></h3><ol><li><p><strong>访问 Docker Desktop 官方下载页面</strong></p><p>在浏览器中打开 <a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener noreferrer">Docker Desktop 的官方下载页面</a></p></li><li><p><strong>下载 Docker Desktop</strong></p><p>在下载页面，找到适用于 Windows 的 Docker Desktop 版本，然后点击下载。</p></li><li><p><strong>运行安装程序</strong></p><p>下载完成后，找到下载的安装程序（通常在你的 "下载" 文件夹中），然后双击运行。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装-cygwin">安装 Cygwin<a href="#安装-cygwin" class="hash-link" aria-label="安装 Cygwin的直接链接" title="安装 Cygwin的直接链接">​</a></h3><p><a href="http://www.cygwin.com/" target="_blank" rel="noopener noreferrer">cygwin官网</a></p><p>选择setup-x86_64.exe，等待安装完成。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="验证-cygwin-安装是否成功">验证 Cygwin 安装是否成功<a href="#验证-cygwin-安装是否成功" class="hash-link" aria-label="验证 Cygwin 安装是否成功的直接链接" title="验证 Cygwin 安装是否成功的直接链接">​</a></h4><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cygcheck -c cygwin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="7.png" src="/zh-cn/assets/images/7-f31de94adfaa4fac24dbf1d410079a70.png" width="595" height="377" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为-cygwin-配置环境变量">为 Cygwin 配置环境变量<a href="#为-cygwin-配置环境变量" class="hash-link" aria-label="为 Cygwin 配置环境变量的直接链接" title="为 Cygwin 配置环境变量的直接链接">​</a></h4><p><img loading="lazy" alt="8.png" src="/zh-cn/assets/images/8-0edaba7a8d7beee2abf67ed25756fe11.png" width="776" height="627" class="img_ev3q"></p><p><img loading="lazy" alt="9.png" src="/zh-cn/assets/images/9-e13e9c70896872ee5ba92afcdb4e5c34.png" width="493" height="605" class="img_ev3q"></p><p><img loading="lazy" alt="10.png" src="/zh-cn/assets/images/10-f7ca28c3f9f21b743a80b5d989dd74ae.png" width="632" height="666" class="img_ev3q"></p><p><img loading="lazy" alt="11.png" src="/zh-cn/assets/images/11-70aebeb53894ffb9cfffd3bfade7d8ee.png" width="541" height="570" class="img_ev3q"></p><p>点击确定即可添加成功</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-higrees">安装 Higrees<a href="#安装-higrees" class="hash-link" aria-label="安装 Higrees的直接链接" title="安装 Higrees的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="准备-nacos">准备 Nacos<a href="#准备-nacos" class="hash-link" aria-label="准备 Nacos的直接链接" title="准备 Nacos的直接链接">​</a></h3><p><a href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start-docker.html" target="_blank" rel="noopener noreferrer">nacos官网手册</a></p><p>我们这里选择nacos-docker的模式安装</p><p><img loading="lazy" alt="A.png" src="/zh-cn/assets/images/A-321115aaea59ff9a6e4a07b9393b9207.png" width="1076" height="564" class="img_ev3q"></p><p>下载解压zip文件,进入 nacos-docker-master 文件夹右键选择终端打开，执行命令，我们这里选择单机模式部署</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    docker-compose -f example/standalone-derby.yaml up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等待出现界面，即安装成功</p><p><img loading="lazy" alt="B.png" src="/zh-cn/assets/images/B-f819ffcf4f15baa1010207f2726bb032.png" width="1731" height="1195" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-higrees-对接-nacos">使用 Higrees 对接 Nacos<a href="#使用-higrees-对接-nacos" class="hash-link" aria-label="使用 Higrees 对接 Nacos的直接链接" title="使用 Higrees 对接 Nacos的直接链接">​</a></h3><p><strong>安装命令：使用独立部署的 Nacos</strong></p><p>当访问docker容器互相访问时候本地回环地址并不是真正的地址，所以需要在cygwin中执行获取本地网卡地址</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ipconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="C.png" src="/zh-cn/assets/images/C-c0ee57511e3244545ceebb126834c3d3.png" width="1993" height="1209" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -fsSL https://higress.io/standalone/get-higress.sh | bash -s -- -c nacos://192.168.0.1:8848 --nacos-username=nacos --nacos-password=nacos -p &lt;你的密码&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请将 <code>192.168.0.1</code> 替换为 Nacos 服务器的 IP（如果 Nacos 部署在本机，请不要使用如 <code>localhost</code> 或 <code>127.0.0.1</code> 的 Loopback 地址），并按需调整 <code>--nacos-username</code> 和 <code>--nacos-password</code> 的取值。如果 Nacos 服务未开启认证功能，则可以移除这两个参数。</p><p>在这里未开启授权服务，直接使用WLANIP替换对应的IP</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -fsSL https://higress.io/standalone/get-higress.sh </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> -s -- -c nacos://10.30.0.225:8848</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>输入命令等待部署，即可看到生成的用户名与密码</p><p><img loading="lazy" alt="D.png" src="/zh-cn/assets/images/D-42927806049c82e382d903d50a93841b.png" width="606" height="662" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-控制台配置">Higress 控制台配置<a href="#higress-控制台配置" class="hash-link" aria-label="Higress 控制台配置的直接链接" title="Higress 控制台配置的直接链接">​</a></h3><p><strong>访问 <code>http://localhost:8080/</code>, 使用用户名 admin 和安装时设置的密码登录 Higress 控制台。</strong></p><p><img loading="lazy" alt="13.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhgAAAFKCAYAAABfKiZxAAAgAElEQVR4nO3dfXSU1bn+8WsYQ1IkQwokBkgiIMVJKDWGChhtjW9terSQUivVikUtFi1ITj1WpLZVawOec9pfPL5Ra5VKS2urGF+OHcViPLVDwBpi1SQCBgwhCQHiZAI0Qxye3x8zGfIyExPYdDLJ97MWy+SZ/TyzzVqSy3vfe4/NsixLAAAABg2L9gQAAMDgQ8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAgAg67Pn4EDAAAIrDZbNGeQswiYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAJ0nCVClxpvTnv4Z//Yhf+vJvLE2939Kqv1qh620+qeQlaeMbkmVZ4W8GgAGOgAGcJP42qf1Q72N8fsn3cddrTz0rfeMG6cvfkF4ptZ28CQLASUTAAAYYz+FjXx/8KHrzAIATcUq0JwCgq4VXWpJsShohXXZZtGcDAMeHgAEMMKNG2rTs+mjPAgBODAEDOElOGyvt90nbtktFVZY+2h24PvaoTTd80dL5020abrdJ6trI2eaTPtgV+PqMiVJC/LHX/H6/Pqyt0+7aPfr4qF+TJmYoPW28mpr2qc13RGPGfFpJo0ZJkpr27VNr6yElJp4qSXrn3WqNPDVeZ5wxRWPHjA49b099g2p379E/Dx9UymmpmjB+XOj1zjree+euWjU3f6SJp6dr0qTTw45taNyrD2p2qaFhr8aNO02TTk/X+PHjZLPRUwIMFQQM4CT50oXSOpf0s99Li26x6bHKQJBo+MjSskdtOsUr/fw/LP1XW9f73G8GGjwlqaJUmnZm4GvLsnTLrT/UljfLQ7tLbDabUlNP06kjPqUPanbpxhsWaNH1CyRJ9z/4K73yaqlSU09Tc/NH8vl8kqT5V8zVbd9fIkk9nidJ8fHxKrprhS64ILfLvH58z3165dXSHmMf/p/7dNb0aaFra9b+QY88ukZ+vz90zW6367prv6nFixYe748TQIyhyRM4SVLOCvzzny3S63+WbrnQplsutGlOTuD/4ts+lm7+kU3/9qm+/V/9vSt/oc1b3pJlWfp8Tra++51rdd65M9XYuFc7PtgZdkurZVlqaGiU3W7XrJkzFB8fr69/7auyLEs//EmRNm95S5J0fu4sfee6b+n0jDT5fD794M57VFVVHXrO5i1b9MqrpRo2bJgK5nxFS266QVPOmCSfz6el/75CDY17Q2PXrvuT/H6/PvvZTBUu/a5mzZwhv9+vx574nd5wbz7eHyeAGEMFAzhJyj62tOhbNv1mg/SPKqlyr5Q8wdKENOnWa21a8zup8ZD00nppzf/0HjIOHjyoDRv/T5J0zdXf0NKbbpDdbpff79fadX/SQ6sfj3hmxogRI/Tr1f9Pn5kyWZ6WFiWNGqWGxr0q/T+3JOlbV12hwiU3SpIWXP0NLV5ym6re365nnntJd2Y6JUn/ePd9WZalpKRRuuXmRXI4ElUw5ytavOQ2SdK7776rcamnydPSopYWr2w2m1be80ONSz1NV135NRXdV6z3qt7Xu+9V6fzcWUZ+vgAGNgIGcJLs/Ejyj7V067dt+u1L0gG/tL9F8gyTag5Zuv82m675nrStUvLUSsqI/KyNpW/o8OHDGjNmdCgMSIGlh4ULvqkX/vdlfVhbF/benOzp+syUyZIU6s/4oGZXaMlk3779unfVL0LjTz010LOxteKd0LXsz31WdrtdBw4061vX3azL8i/WjLPP0oPFqzRm9KdDvRVJo0ZpzJjROnCgWfOvuVFfuuQCfeHc2frO9dcoJXms7HZ7/3+QAGISAQM4iWpbpfO/ZuknC22qb5He2X2sUpE6Rpo0XtrmkUr/Ll10fuTnvL9thyQpZeyYsK+npp4WMWCMHduzCXN3XX3o65c3vBb2vsa9+0Jfn/P5s3XTjQv14CO/VkNDox574nd67InfSZLmXp6vO+/4fihk3PuT5Sq87Uc6fPiwSp7/s0qe/7Mk6fSMNP36l8WhkANgcCNgAP8i40cF/nRo73SCp/9Q4OyLSBITR0qSDv/zn2Ffb/tnW9jrkZw64lOSAssnjz7887Bj7MO6tmgtXPBN/Vv+xWpobNI771bp5Vc2qur97XruRZfS0ydo4YJvSgqEkZdf+IN2767T9g92aWPpG/rbpi36sLZOd/30v1T83/f2a64AYhNNnkAMOHf2OZICVYWanR92ea2hca+2f7CzX8/LdE6V3W7X4cOH1eptlXPqlNAfn8+nv76xSZvfLJcUaBT90zPPa/Wv1qhs81v63GezdM1VV2jNYw8o88zPSJIq3n5XkrTh1b9o9a/W6IWXNigz06k5l+er+L/v1Q+Cu1Y2bf77Cf0cAMQOKhhADDhr+jSdnpGmD2vrtHDRLSq6Z4Uy0ido7959uvPuVTp8+PAnP6ST8eNSlZKSrIaGRt2z8he6+87va+zYZNXu3qPbf/hT+Xw+Fcz5iqTAVtiKf7yrlze8JrvdLm/rQU3/bKY8zS3atqNGkjRm9KclScPsw/XrNetkWZa2bduhr152ifx+yfXKRklSSkqywZ8KgIGMgAHEiB98/yYt+fc7dfjwYRX+x51dXuvYUdJXp546Qr9e/Qt9dd4CNTQ06sbv/aDH85bcdEPo+3t+fLv+Xv62DhxoVvEDv+wy1maz6Yqvz5EkXXzhFzTznBxt3vKWXnjpFb3w0itdxi667lt9niOA2MYSCXCSXDAx8GdsL+dcXDBTuniWNPWMY2NGJ0lfuiTwZ0TisbGzZs7UM394XLNmzgg1VH4+J1u/f/KXysyc2uPZn5kyWbNmztAZkyeFfe+U5GT9ad1jmn/F3NC1ESNG6LvfuVYvv/hUl2ZMu92u3615RLcW3qwRI0aErs29PF8lf1wTWiqRpJ+vukv3/ezHGhM84dNms+ms6dP06EP/qa9e9uXefmQABhGbFWnzPIAB5dChQ7IsSyNHjuxykqckLbjuZlW9v123Ft6sq678Wr+f3VH9GDZs2Cce521Zlo4ePdqvsWxPBYYeKhhAjJj3zet18Veu0Ouvu2Wz2UK/3H0+n+qDJ2lmhalk9IXdbpfdbu/TZ4XYbLZ+jwUw9BAwgBiReeZn5Pf79aOf3qftO2rU1tYmr7dVy269Uy0tXo0ZM7rLZ4IAQDSxRALEiNrddbruxmVqafHKbrcrPj5efr8/dCLnj1fcqjmX50d5lgAQQMAAYsiePfV67Infyb357zp48JDsdruynFN1zdVX8BkfAAYUAgYAADCOHgwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYd0q0JzBU+Xw+1dfXq729PdpTAYABIS4uTmlpaYqLi4v2VGCAzbIsK9qTGIp27typMWPGyuFIjPZUAGBA8HpbdeDAfk2aNCnaU4EBLJFESXt7O+ECADpxOBKp6g4iBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8CIYZu3bFFBQYHOPPNMnXnmmSooKNDmLVuiPS0AAAgYsWrDq3/RtQsWaPz48XrwoYf14EMPa/z48bp2wQJtePUvUZxZrcpLS1Veezy3luv1192q9BifFADgX4xPU42Sbdu2aerUqcd1r9fbqosuulDz5s3TihUrurxWVFSk9evXa+PG1/rwYWq1Ki+tkbc/bz48Rdm5WUrqZYin0q2390nJZ+Uqq7eBXW+Su6JJSslWbp9vAjDYnMjfjRhYTon2BNB/VdVVam1t1ZIlS3u8tmTJUv3mN79RVXWVZs2c2afnOSbnKSej04XacpXWJfQIEp5Ktyq6VBc8qnRXqOlI+Oc2VZSqqdu14eECRDBcHAncpNLuNwXZbMP7F1oAAFFDwIhB1VVVkhS2QtFxrbqq7wHjRPUIKGEFwkiP1Y+OcOGYrLxID+mobiRnES4AIEbQgxGDZs6cJUlhGzo7rnWMGcg8lW6VBpdF8sbuV2mYxo2OMQmT81g6AYAYQgUjBmVmOuV0OrWyqEgPPfSwJkwYL0nas6deK4uK5HQ6lZnp7PPzvDWlKq3pcVUV4dYqhh//vLuoLVdFU4Im5+UqQ5LHM1YpdTUqdR8MLs109Ic4QmMAALGDgBGjVq26TwsWXKO5c+coKytLklRZWSlJWrv2t/161vH3YJyAjBzldXrPpKQMJeU6JHdFKNgMT8lWHlULAIhJBIwY5PW26tln16u1tVWJiYnqvBGotTXw2oQJS/uwi8TQfMJWQMKLXADptKOlt34MAEBMIGDEGK+3Vddeu0B1dXVauXKl5s2b1+X19evXq6ioSFu2bNGTT67tQ8gYrgTHcc9GbUdOrMnTU+lWRfdtKN4alYZNLA5NzsthuQQAYgABI8YUFf1MdXV1Wrv2t2H7LObNm6fMzCwtWHCNiop+plWrVkV+mOeg2nRE3jDbSfveg9HXgJKkrNy80He15aWq8QaWQbJTKlXRltZ71cJTKXdFW1/eCAAwABAwYkhVVbWeffZZrVy5stcmzsxMp1asWKE77rhDS5feEmoC7cHbpiPhqgJ97cHwHFSbEjT2ONokMnLyQu/pqez//QCAgY1tqjHk1Vc3aMKECT2WRcKZN2+eJkyYoPXrn4k4pna/VxqeoONdIfHUe3TkBO4HAAxeBIwYsmXLFk2YMKHP4ydMmKCq4KFcPXgqVeeVHGm9H/vdQ8LI4HiP6j1HNDxpfP/uBwAMCSyRxJC1a9caG++p9+iIY7JyP6FjsnsTpmNy8IbaGjUdcWiyqW2kERs7O6NWAgCxgoAxRCVl5Sov0oudz6jIylVeVs8htfu9ckzOM7ej45O2ptLkCQAxhU9TjRI+MRAAeuLvxsGDHgwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQSMKImLi5PX2xrtaQDAgOH1tiouLi7a04AhnOQZJT6fT/X19Wpvb4/2VABgQIiLi1NaWhohY5AgYAAAAONYIgEAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGDcKdGewFDl8/lUX1+v9vb2aE8FAAaEuLg4paWlKS4uLtpTgQE2y7KsaE9iKNq5c6fGjBkrhyMx2lMBgAHB623VgQP7NWnSpGhPBQawRBIl7e3thAsA6MThSKSqO4gQMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxfBZJDPN6W1VVXdXlWqYzkxNCAQBRR8CIUTfffLP+8pe/hH3t4osv1sMPP/wvnhEABPh8Pj333HPKu/BCpSQnR3s6iBICRgxav369tmzZogcferhHtcLrbdUdy2/X+vXrNW/evON4eq3KS2vUlpKt3KwkMxMGMKj4fD69V1mppr175fV6JUnx8fGaMmWK0tMz9NxzJWppaYnyLBFtBIwYtGfPHmVmZurSSy4O+/qTmZnas2fPcT49Q5NT6lTRVKParBxlRBpWW67SGm+Py8NHT1bSwRo1HQl/m2NynnIiPhTAQFe+das2ud2yLEvp6elKT0+XJLW0tOi1116Tz+dTfHy8rpw/n+rFEEfAGKo8lXJXNClCDpB0RDWlparpdtVmG67ks3KVlZGjvAxJ8qjSXaG2tM7BIUNZPd9Qle5KyWFo/gD+5Vwul9577z3l5uYqJydH8fHx8npbJUnx8cO1b98+tbS0aM7cAn2wYwcBY4gjYAxpDk3O61al8FTKXTtSuZ8LV2aoVXlpXddLnnp5jjiU1nm4p1LuijaldXm2V21HEjSWVRcgJpVv3aodO3YoPz9f06ZNk8/n09q1a9XU1CRJSkhIkGVZunL+fEmS2+1WfEKCcs4+O5rTRhSxTXWoSspSbt5kHXSXqrS8Vp5Kt0rLayV/utIS9qu0tFy1kgKVh8AYKUM5ebnq3JrhqffoiGNsj6UU/4iErsWK2v3yDk+ggAHEIK+3VZvcbuWed56mTZsmSXruueeUnJysRYtuVEpKSihcpCQnKyU5WRdedJE2ud2hCgeGHioYMaSqqlorVxZpz549amlp0bXXXhthXJXq6+v15ptv6o47Vigz0xn+gbU12tc+XClZGVJ9sDIxJlEZY3KUkVIpd3CJxDE5T3kZHm1750NNnX565weopklKye4WL7xt8n+c0OWS52CblDBWFDCA2ON2/00OhyNUjWjat0+7d+/WkiVL9Mc//lEtLS26cv58vexyacGCBZKknLPP1nvvviu3+2/Kz8+P5vQRJQSMGOJt9Wrz5s1asmRJr+POOeccSdKDDz4ob2vPRsyAWpXXeBWXkq2sJMlTL9k/PqhKd6majgR7LbLzlJUk1ZaXyr0/RQltTSp1H1J2bpaSJNWW18gryVtRqkCRNLDk4ugRJjyq9xyRI43uTmAwGOUI1CI7hwtJoeUSQCJgxKSlS5d2+b6jBNl9y+qDDz7Yy1MylJOXoUBfRYUCMaRJTY7JysvtHARqtd8rJUzOUk5GlmrLS1VZOV65I2sU2EQS7OMI9l0cm1SNSku7tYjWlKq0hp0kQKzJzT1PTz75G5Vv3RqqYiQkJHQJF6WvvaYZM2aE7infujXw+pVXRmXOiD4CxiDwve/dLElau3Zt328K7iJpD1YqcoKVippwwWB4ijpWQTJy8pQhqbbcK8eoUfK2WD0enZSVq7ye20jUccYGgNjicCQq97zz9NrGjUpMHKWyTX+TZVmaM7dAL7tcampq0pQpU3TuuedKkt577z29tnGjLrzoIsXHx0d59ogWAsYgkJmZ2e97apvalJWX16UnoiM89EVGTp4yastV2p+zdDwH1abhSqLTE4g5OWefraa9e/X8c892Oedi7twCxccPV3x8vHw+nzZt2iS3260ZM2awg2SII2AMAhdfckm/78mYmhPxtdryUtUlHOdJntvKVVrfs+/DZhuu5Em0eAKxyufzad++fYqPj9ecuQXa5HYrPj5eo0aNkhTov6irq5NlWaGtrBjaCBgxaPOWLf26Hlm4Q7IiqC1XaY16npvR3dQc5U2N9HaVcvdzhgCiz+fzdWnoHOVwaMqUKdqxY4d2794tSXI4HDo3N1fTsrJYFoEkAkZMuja4DWxg8HY68bP3tQ9PvUdHlKCRFDKAmBIfH6/09HR9OT8/dDrntGnTqFKgVwSMGDJr5kyVlDzXy9bTrhyJjshnYHTiDe7u6HqxQqU9dpyFCxARdpEEBRpHj30/PCWrz30eAAaOvLy8aE8BMcZmWVbPbQA46bZt26apUyOtJQxAfV0iAYATEHN/NyIiKhjom9CHmwEA8Mn4LBIAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQSMKImLi5PX2xrtaQDAgOH1tiouLi7a04AhHBUeJe3t7aqrq1N7e3u0pwIAA0JcXJzS0tIIGYMEAQMAABjHEgkAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIw7JdoTGKp8Pp/q6+vV3t7er/vi4uKUlpamuLi4kzQzAABOnM2yLCvakxiKdu7cqTFjxsrhSOzXfV5vqw4c2K9JkyadpJkBAHDiqGBESXt7e7/DhSQ5HIlqbGw4rvesXuNUgUpUvdB5XPdLkjwuFd4l3VWcr6SuT9caZ4FWdRu+vKRMqatnq3FxtRY6JVWvkXN1qsq63B/+3h6Wn+DcgUHugful9KulguTIY0oel9Kvl2ZIUqU0bkMvD0yU3r5eSunlWTc5pIYrIgwI9/xEabmkVa09h+dPl564qJf5IKYQMAaz6jVyFnT/tV0gZ5jf5MtLggFAHrkKZ6vQ1WPAJ/xyd2phdbUWdnlvKdeZpKmLl8tZ4AwEiPxild19bu/3Rvp3KettAICll0rjXpByewkFBbOlcfdLLy6TZmRJDVkRBlZK48o6fR0piLQGntfdikulpR3P3ydd94J0X6d5Les2vmmj9FRqL/9yiDkEjMEuv7hbtaC7QKBoDH2fpPzialX39308LhXOLlR2SbUWKhBslpdUa6okOReqZPkqrU4tU3F+UmCsMzi2t1DT3fKS/s4KGJTeelq6fE/k188K8ws/VI3Ikt5ulG7f2M9qQZhqxgNPS0s7qhf7pOvWSXOvltJfl9ydxjW9I2lip3vDBA73Lil9ej/mgwGPgIG+6VYNcXUqZuQXl6k4P1/F1WVyFTrldEl33HGHVnZULUJmK3Dbcj1fHQwfkvoUaqhgACEzrpAaFAga7qxApaA/Ui6SnujPDVlSQ7J03f2BALF7nTTrKml+VtfqxYvLpN2PS7u/Ki3ttEzz1DuB+3qzu1XK7WVpB7GHgDHYuQo1uw9tC8sXf8IA50JVVy/s0UNRvcap1cEh1Wtmq9C1XM9XL9RUSd/+9re7PSRYqVBq6P9aPK5Czf7E0kWnaaxSH6oyAMIpeVy6Kdj78OKyQB9G00bprHci3NCpTeyBdZKmB/o7HpBkT5Ge+n3gtUeulgoUCCA3XSU9sk5SsBekaaNUlCi93Tk87JNcjk4hp1IqmhAITRg8CBiDXX+XSML2bQQsL4nUJ9EiV+FsufLLVFZ8l2Y7e080+csbdZfTKVd+scqKi1UdpnThcRVqduNimjoBgwquDwSBB7otoYRtruzcgyFp6bJAxSRUsQj2cTR0Gu9KlO5LkZ64VBr3ulRwgXR7MLx0LNusuFSa3yhpT8/ejXH3H+vdQOwjYKCrjkpFhN0iHleFlL04eM2jXRVS9uLTlV9crXxJHlfHkkn4SONxFeouFai4ulNUCbuzRNKqMm1b6AwtpQTuvSvis4GhqGhD4E9vjmt3RqcG0I6ejxWXBneMBJs+L+8WEFZcGuypCN771tNSzgTJpcB9JY9LuxVYomkIM5+O1zE4EDAGu+NcIqkuKVT24uoelY/GRpfyU+8yNj1JknOhyvILNdvpUnFZsY7lh1V62FWg4vykwBbbimKVGH5rIJZ19GJ0KHlc2j3bfAWg+/uot90n3e5L3ygVNZudD2IDAWOw6/cuEkkel1ZXFOuuhepWXahW2ap85Zf1XkFwFXY0c0aaUs+UkJRfrOoylwpLXFKFS43ZkpYXK981W85CBbbJFrNcAnRo2iid1Rz4RT+uMlAhKLg+EDKuawxWLII7O5YE+y36LbhM8vb1UkqYZzVtlG5X1+rIJ4acRum6DYGqRmf506WcMGdjIHYRMNBDdYlL+XcVK8njUmGwH6Okulqzywq0anmJqkP5olGNLkmdqh9J+cWqLlkjZ9nsbv0TwSDTceBW2PctlGuVlF1SrYJdhVrVOFH5xSVa7ixQn8owwFCxL9Db8MjVga876+izkAKNmZefFVjKeDFMyHhmvTR+jCX5bWHfpqlRkiPymRrHJTXycs0D70jp7CQZNAgYg11/l0g8Lq1e5ZJrlTNQ/aiuVrHHpcLZTq3Scj1f3f1h+UrtfjiOc6FKypxyFnZUT4K7R7JL1ON2BU8YXRXo3agOphfPrtDDtDC0/fXYDhVgKCt5QaEdHd0DRkhlcPdGntSQIo17uuuJm5ffHwgoZ7xjkyvCEsbuZil/dNdr3fsuJGlct10oK7oP6NTQ2eO1DvukcknpkV5HzCFgDHb9XSJJyldx920dSROVrXzllwV+uXfZWppfrLKkYyGhq27hxtXtFNH8Yj2ZXah1qR3BolprnLNDZ2csLynumEDgnAyPS4Wh3SdsU8XQ1blKoSxpxYbIp2l2brqUdCx4dBxyNV3KXxf+fiVKb3eEkmTpie7Hb4YRtlFzQtcmz84euF8q6jTuCSoYgwYfdhYlfNgZAGAwI2BECR/XDgAYzAgYAADAuGHRngAAABh8CBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMC4U6I9gaGqvkW67Gmp8WC0ZwIAA0PqSOl/r5DGj4r2TGCCzbIsK9qTGIrO/jXhAgC6Sx0pbb0h2rOACSyRRAnhAgB64u/GwYOAAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBgAAMA4AgYAADCOgAEAAIwjYAAAAOMIGMAg5m/e1eV7y7crwkgAMItPUwViWpv8zY1hrn9a9tGj9MbdE2WrlL64IRA2Hlg2UTmNge97Y/k8OnrI07cpJE6UPa7fE584qvoAAASZSURBVAcwyBEwgFiWnaDtF0xUuE+33vS6pa3NNs0/rVX+5qN64+6Jmtos/XjfUfm97bI74iM+dtFVSfppelLf5tAsjVt7fNMHMHjxce1RMu7+aM8Ag0Ob/F5bp7DQpuIFCZp/6lH9+JFh+tXZUvUF0ihJ2yulL25ok3+qtP0rCXIVS4W2E3v378yTfnoqAQNmNSyL9gxgAhUMIJZlJ2j7rDb9588tPT7Sp6NfjNP80dJTxcP0K5ukCsk1XZpvteoLL/p1dHqCtn8lQar7pHARaemlK+vjDNHKBSAcAgYQ4973JujeFZacr8Rrztk2uV/dpaUfHXt96f0Opa8YrfdvtjRqpC1YyfiEh/ay9NJD8wlMHsCgxRJJlLBEAlMs3y4tumqifpoe6LuwZtuU2629oqVO2psm6Z0PdX5Jaq/9F/3BEglOBpZIBgcqGEAM8zc3q2TFROXqqO78Sa0elaSNkUY7VLLidDX94KjuLNqlR8Pu/ujb0kgH6+MMyTokf/MBdexcAQCJCkbUUMGACa8vU2Abqiw1ZH1yx6ZlWVr/uk2X5Emjwu3+yD7WFHo8Nr1uaV7FCXaOYsijgjE4UMEAYtgFHUH1Ukm+4M6RSL/fs6XqC2z6uEJyvh1hTIXkrAgsuxw9FLzWUenoCB+d3ic0LlQNIVwACCBgAIOFdURHP2qUP9Lrh1MlJfTpUfd/Z6Lmjw5+0yylPrZLNk2UJG1pGaZrLv5Qq5+29MCy4DjOwgDQDQEDGCwSEnTv3RN1r4FHvffOUY2rGBY8atyhkhUTNe5A4LWd66T0m05X092B5tFxayVlS4ssRa6eABhyCBjAYLDBpnEbAj0ZW3scoNWmG+YM121xw+R8Rn1YxWjT6o2N0injAqd/KnBIV+4+qXp8YMTXV0vPLJam+Zvlb7bLXjGKcAGgC07IAQaRrc3S/MVtWtSpdfto5jDdNqmv/6m36WjmMG2/e6KafhSvA69bSvnJLp331C75D7d1Gfn11ZIrcbSa7h6lZ6btkt/rM/cvAiDmsYskSthFAhO6NGNKCixnjNbYbR/q/Ket0PfTGpv1mce9XW8Ot0310sBulNBukG67SlrqFKiCdPPMYik3XnrKwPHjALtIBgcCRpQQMGBCxy/24xEpLADRRsAYHOjBAGLY11dHewYAEB49GAAAwDgCBgAAMI6AAQAAjCNgAAAA4wgYAADAOAIGAAAwjoABAACMI2AAAADjCBhRkpzAAaoA0B1/Nw4eBIwo+e3lh/kPCQA6SU6w9NvLD0d7GjCEzyKJkra2Nvn9/mhPAwAGFLvdroSEhGhPAwZQwYiSuLg42e32aE8DAAYMu92uuLjuH/GLWEUFAwAwIFiWJZvNFu1pwBAqGACAAYFwMbgQMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMYRMAAAgHEEDAAAYBwBAwAAGEfAAAAAxhEwAACAcQQMAABgHAEDAAAYR8AAAADGETAAAIBxBAwAAGAcAQMAABhHwAAAAMb9f89fh/kzukK1AAAAAElFTkSuQmCC" width="536" height="330" class="img_ev3q"></p><p><strong>点击左侧“服务来源”导航栏，然后点击页面右侧的“创建服务来源”按钮。按照下图所示内容填写表单并点击“确定”按钮。</strong></p><p><img loading="lazy" alt="14.png" src="/zh-cn/assets/images/14-38328e899b78267f27be2e99f8f7cb72.png" width="970" height="435" class="img_ev3q"></p><p><strong>点击左侧“域名管理”导航栏，然后点击页面右侧的“创建域名”按钮。按照下图所示内容填写表单并点击“确定”按钮。</strong></p><p><img loading="lazy" alt="15.png" src="/zh-cn/assets/images/15-a79679960f6542a80ae4626bb5741ce4.png" width="957" height="467" class="img_ev3q"></p><p><strong>点击左侧“路由管理”导航栏，然后点击页面右侧的“创建路由”按钮。按照下图片所示内容填写表单并点击“确定”按钮。</strong></p><p><img loading="lazy" alt="16.png" src="/zh-cn/assets/images/16-f68a4a744e7c6ef008ef7d0b44e03ce0.png" width="979" height="935" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="请求验证">请求验证<a href="#请求验证" class="hash-link" aria-label="请求验证的直接链接" title="请求验证的直接链接">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># should output a JSON object containing request data </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://localhost/get?foo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bar -H </span><span class="token string" style="color:#e3116c">'host: foo.bar.com'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="E.png" src="/zh-cn/assets/images/E-bef754877d8c43a714b121f04b4e3071.png" width="465" height="307" class="img_ev3q"></p><p>更多详情与部署方案可参考 <a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">quick start</a></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress 全局配置控制面原理分析]]></title>
            <link>https://higress.io/zh-cn/blog/configmap</link>
            <guid>https://higress.io/zh-cn/blog/configmap</guid>
            <pubDate>Sun, 23 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Higress 全局配置控制面原理分析]]></description>
            <content:encoded><![CDATA[<p>Higress 有个全局配置 ConfigMap 对象 higress-config，参考配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">higress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sampling</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">skywalking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> skywalking</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">oap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server.op</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>具体配置说明请参考 <a href="https://higress.io/zh-cn/docs/user/configmap" target="_blank" rel="noopener noreferrer">Higress 全局配置说明文档</a>，
本文介绍以 Tracing 为例，详细说明 Tracing 全局配置是如何转成 EnvoyFilter 和如何同时实现实时下发到 Higress Gateway过程。</p><p>本文涉及整体架构流程、初始化过程和启动、higress-config 变更和处理流程、通知 XDSUpdater、构建 EnvoyFilter 和下发以及如何扩展全局配置等内容。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="整体架构流程">整体架构流程<a href="#整体架构流程" class="hash-link" aria-label="整体架构流程的直接链接" title="整体架构流程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-整体架构">1. 整体架构<a href="#1-整体架构" class="hash-link" aria-label="1. 整体架构的直接链接" title="1. 整体架构的直接链接">​</a></h3><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/configmap1-f2447fa1bd9826e78e29bcdf1f38a4ca.png" width="2704" height="1196" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-核心组件">2. 核心组件<a href="#2-核心组件" class="hash-link" aria-label="2. 核心组件的直接链接" title="2. 核心组件的直接链接">​</a></h3><ul><li>IngressConfig</li></ul><p>IngressConfig 是 Higress 一个核心结构体, 负责监控 Ingress， McpBridge, Http2Rpc, WasmPlugin 等 k8s 资源， 同时集成 ConfigStore Interface，通过 List 接口下发 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源。</p><ul><li>ConfigmapMgr</li></ul><p>ConfigmapMgr 结构体负责整个核心流程，包括通过 Informer List/Watch 机制监控 higress-config 的变更，同时遍历 ItemControllers 下发变更通知，提供构建 EnvoyFilter 列表等功能。</p><ul><li>TracingController</li></ul><p>TracingController 结构体负责具体的 Tracing 数据校验，构建 Tracing EnvoyFilter, 以及通过 ItemEventHandler 下发变更通知等。</p><ul><li>HigressConfig</li></ul><p>HigressConfig 是 higress-config Configmap 所对应数据的结构体。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-核心流程">3. 核心流程<a href="#3-核心流程" class="hash-link" aria-label="3. 核心流程的直接链接" title="3. 核心流程的直接链接">​</a></h3><ul><li>用 Informer List/Watch 机制监控 higress-config 变更，校验变更，同时保存变更后数据。</li><li>用变更数据构建 EnvoyFilter。</li><li>通知 XDSUpdater，EnvoyFilter 有变更，重新拉取新的 EnvoyFilter 列表。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="初始化过程">初始化过程<a href="#初始化过程" class="hash-link" aria-label="初始化过程的直接链接" title="初始化过程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-初始化入口">1. 初始化入口<a href="#1-初始化入口" class="hash-link" aria-label="1. 初始化入口的直接链接" title="1. 初始化入口的直接链接">​</a></h3><p>初始化过程入口在 NewIngressConfig， 初始化 IngressConfig 时同时构建 HigressConfigController 和 ConfigmapMgr。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/config/ingress_config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewIngressConfig(localKubeClient kube.Client, XDSUpdater model.XDSUpdater, namespace, clusterId string) *IngressConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建 controller 和 configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higressConfigController := configmap.NewController(localKubeClient, clusterId, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.configmapMgr = configmap.NewConfigmapMgr(XDSUpdater, namespace, higressConfigController, higressConfigController.Lister())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-higressconfigcontroller-初始化">2. HigressConfigController 初始化<a href="#2-higressconfigcontroller-初始化" class="hash-link" aria-label="2. HigressConfigController 初始化的直接链接" title="2. HigressConfigController 初始化的直接链接">​</a></h3><p>通过 Higress 提供 NewCommonController 初始化 HigressConfigController 用于监听 higress-system 命名空间下 Configmap 的变化。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type HigressConfigController controller.Controller[listersv1.ConfigMapNamespaceLister]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewController(client kubeclient.Client, clusterId string, namespace string) HigressConfigController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    informer := client.KubeInformer().Core().V1().ConfigMaps().Informer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return controller.NewCommonController("higressConfig", client.KubeInformer().Core().V1().ConfigMaps().Lister().ConfigMaps(namespace),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        informer, GetConfigmap, clusterId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func GetConfigmap(lister listersv1.ConfigMapNamespaceLister, namespacedName types.NamespacedName) (controllers.Object, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return lister.Get(namespacedName.Name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-configmapmgr-初始化">3. ConfigmapMgr 初始化<a href="#3-configmapmgr-初始化" class="hash-link" aria-label="3. ConfigmapMgr 初始化的直接链接" title="3. ConfigmapMgr 初始化的直接链接">​</a></h3><p>ConfigmapMgr 初始化具体步骤如下：</p><ul><li>构建 ConfigmapMgr</li><li>设置 HigressConfigController configmap 新增或者更新回调函数为 configmapMgr.AddOrUpdateHigressConfig</li><li>设置 HigressConfig 结构体默认值</li><li>初始化 TracingController</li><li>把 tracingController 添加到 configmapMgr itemControllers 数组里</li><li>初始化 ItemEventHandler， 同时遍历 itemControllers，设置 ItemEventHandler</li></ul><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  构建 ConfigmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr := &amp;ConfigmapMgr{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        XDSUpdater:              XDSUpdater,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Namespace:               namespace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HigressConfigController: higressConfigController,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HigressConfigLister:     higressConfigLister,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        higressConfig:           atomic.Value{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置 HigressConfigController configmap 新增或者更新回调函数 configmapMgr.AddOrUpdateHigressConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.HigressConfigController.AddEventHandler(configmapMgr.AddOrUpdateHigressConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置 HigressConfig 结构体默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.SetHigressConfig(NewDefaultHigressConfig())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 初始化 TracingController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracingController := NewTracingController(namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 把 tracingController 添加到 configmapMgr itemControllers 里</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.AddItemControllers(tracingController)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 初始化 itemEventHandler， 同时遍历 itemControllers，设置 itemEventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.initEventHandlers()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 返回 configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动">启动<a href="#启动" class="hash-link" aria-label="启动的直接链接" title="启动的直接链接">​</a></h2><p>在 IngressConfig 添加 HigressConfigController Run() 和 HasSynced() 控制流程。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/config/ingress_config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (m *IngressConfig) Run(stop &lt;-chan struct{}) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动 HigressConfigController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    go m.configmapMgr.HigressConfigController.Run(stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (m *IngressConfig) HasSynced() bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !m.configmapMgr.HigressConfigController.HasSynced() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-config-变更和处理流程">higress-config 变更和处理流程<a href="#higress-config-变更和处理流程" class="hash-link" aria-label="higress-config 变更和处理流程的直接链接" title="higress-config 变更和处理流程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-configmapmgr-变更处理">1. configmapMgr 变更处理<a href="#1-configmapmgr-变更处理" class="hash-link" aria-label="1. configmapMgr 变更处理的直接链接" title="1. configmapMgr 变更处理的直接链接">​</a></h3><p>ConfigmapMgr 通过收到 HigressConfigController 通知来处理变更请求。</p><p>具体变更流程如下：</p><ul><li>判断是否 higress-system 命名空间下 name 为 higress-config Configmap 发生了变化，如果不是就返回。</li><li>获取 higress-config 内容。</li><li>遍历 ItemControllers, 校验 higress-config 配置是否合法，如果有一个返回不合法，就返回。</li><li>和上次保存在本地 higressConfig 比对, 检查这次数据是否有变化，如果没有变化就返回。</li><li>如果数据有变化，就遍历 ItemControllers 通知每个 itemController 数据有变化，同时保存这次变化到本地 higressConfig。</li></ul><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (c *ConfigmapMgr) AddOrUpdateHigressConfig(name util.ClusterNamespacedName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 只监听 higress-system 命名空间下 name 为 higress-config Configmap 的变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if name.Namespace != c.Namespace || name.Name != HigressConfigMapName {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取 higress-config 内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higressConfigmap, err := c.HigressConfigLister.Get(HigressConfigMapName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 通过 yaml.Unmarshal 转成 HigressConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newHigressConfig := NewDefaultHigressConfig()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err = yaml.Unmarshal([]byte(higressConfigmap.Data[HigressConfigMapKey]), newHigressConfig); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Errorf("data:%s,  convert to higress config error, error: %+v", higressConfigmap.Data[HigressConfigMapKey], err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 遍历 ItemControllers, 校验配置是否合法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if itemErr := itemController.ValidHigressConfig(newHigressConfig); itemErr != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Errorf("configmap %s controller valid higress config error, error: %+v", itemController.GetName(), itemErr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 和上次比对这次数据是否有变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oldHigressConfig := c.GetHigressConfig()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result, _ := c.CompareHigressConfig(oldHigressConfig, newHigressConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果数据有变更，就遍历 ItemControllers 通知每个 itemController 数据有变更，同时保存这次变更到本地。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if result == ResultReplace || result == ResultDelete {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof("configmap %s controller AddOrUpdateHigressConfig", itemController.GetName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if itemErr := itemController.AddOrUpdateHigressConfig(name, oldHigressConfig, newHigressConfig); itemErr != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                IngressLog.Errorf("configmap %s controller AddOrUpdateHigressConfig error, error: %+v", itemController.GetName(), itemErr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 保存这次变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.SetHigressConfig(newHigressConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-tracingcontroller-变更处理">2. TracingController 变更处理<a href="#2-tracingcontroller-变更处理" class="hash-link" aria-label="2. TracingController 变更处理的直接链接" title="2. TracingController 变更处理的直接链接">​</a></h3><p>TracingController 变更处理就比较简单：</p><ul><li>检查 Tracing 这部分数据是否有变更。</li><li>如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知。</li></ul><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/tracing.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (t *TracingController) AddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 检查 Tracing 部分数据是否有变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result, _ := compareTracing(old.Tracing, new.Tracing)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch result {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ResultReplace:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if newTracing, err := deepCopyTracing(new.Tracing); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof("tracing deepcopy error:%v", err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.SetTracing(newTracing)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof("AddOrUpdate Higress config tracing")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.eventHandler(higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof("send event with filter name:%s", higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ResultDelete:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.SetTracing(NewDefaultTracing())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof("Delete Higress config tracing")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.eventHandler(higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof("send event with filter name:%s", higressTracingEnvoyFilterName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="通知-xdsupdater">通知 XDSUpdater<a href="#通知-xdsupdater" class="hash-link" aria-label="通知 XDSUpdater的直接链接" title="通知 XDSUpdater的直接链接">​</a></h2><p>在 ConfigmapMgr 初始化时候调用 configmapMgr.initEventHandlers()， 这个 func 会创建 ItemEventHandler, 同时遍历 ItemControllers 设置 ItemEventHandler。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ItemEventHandler = func(name string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (c *ConfigmapMgr) initEventHandlers() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    itemEventHandler := func(name string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c.XDSUpdater.ConfigUpdate(&amp;model.PushRequest{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Full: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigsUpdated: map[model.ConfigKey]struct{}{{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Kind:      gvk.EnvoyFilter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name:      name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Namespace: c.Namespace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }: {}},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Reason: []model.TriggerReason{ModelUpdatedReason},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        itemController.RegisterItemEventHandler(itemEventHandler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 XDSUpdater 是从 IngressConfig 初始化传入， XDSUpdater.ConfigUpdate() 用于更新通知下发。</p><p>进一步跟踪可以发现在 Higress controller server 启动时执行 s.initXdsServer 函数创建 s.xdsServer，具体逻辑不在本文讨论范围, 有兴趣可以进一步阅读源码。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/bootstrap/server.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewServer(args *ServerArgs) (*Server, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s := &amp;Server{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerArgs:      args,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        httpMux:         http.NewServeMux(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        environment:     e,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        readinessProbes: make(map[string]readinessProbe),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server:          server.New(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.environment.Watcher = mesh.NewFixedWatcher(&amp;v1alpha1.MeshConfig{})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.environment.Init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initFuncList := []func() error{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initKubeClient,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initXdsServer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initHttpServer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initConfigController,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initRegistryEventHandlers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s.initAuthenticators,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, f := range initFuncList {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if err := f(); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return s, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/bootstrap/server.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (s *Server) initXdsServer() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.Info("init xds server")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.xdsServer = xds.NewDiscoveryServer(s.environment, nil, PodName, PodNamespace, s.RegistryOptions.KubeOptions.ClusterAliases)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return s.initGrpcServer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="构建和下发-envoyfilters">构建和下发 EnvoyFilters<a href="#构建和下发-envoyfilters" class="hash-link" aria-label="构建和下发 EnvoyFilters的直接链接" title="构建和下发 EnvoyFilters的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-ingressconfig-list-下发-envoyfilters-列表">1. IngressConfig List 下发 EnvoyFilters 列表<a href="#1-ingressconfig-list-下发-envoyfilters-列表" class="hash-link" aria-label="1. IngressConfig List 下发 EnvoyFilters 列表的直接链接" title="1. IngressConfig List 下发 EnvoyFilters 列表的直接链接">​</a></h3><p>IngressConfig List 用于 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源下发， 这里主要关注 EnvoyFilter CR 资源下发。</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/config/ingress_config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (m *IngressConfig) List(typ config.GroupVersionKind, namespace string) ([]config.Config, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if typ != gvk.Gateway &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.VirtualService &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.DestinationRule &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.EnvoyFilter &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.ServiceEntry &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typ != gvk.WasmPlugin {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil, common.ErrUnsupportedOp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if typ == gvk.EnvoyFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        m.mutex.RLock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defer m.mutex.RUnlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var envoyFilters []config.Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configmapEnvoyFilters, err := m.configmapMgr.ConstructEnvoyFilters()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Errorf("Construct configmap EnvoyFilters error %v", err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for _, envoyFilter := range configmapEnvoyFilters {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                envoyFilters = append(envoyFilters, *envoyFilter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof("Append %d configmap EnvoyFilters", len(configmapEnvoyFilters))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(envoyFilters) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Infof("resource type %s, configs number %d", typ, len(m.cachedEnvoyFilters))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m.cachedEnvoyFilters, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 需要下发 configmap EnvoyFilter 列表 和 m.cachedEnvoyFilters 列表聚合一下下发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        envoyFilters = append(envoyFilters, m.cachedEnvoyFilters...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof("resource type %s, configs number %d", typ, len(envoyFilters))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return envoyFilters, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表， 同时和 m.cachedEnvoyFilters 列表聚合一下再下发。</p><p>这里 m.cachedEnvoyFilters 是在构建 VirtualService 时生成，有兴趣可以进一步阅读 IngressConfig 源码。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-configmapmgr-构建-envoyfilter-列表">2. ConfigmapMgr 构建 EnvoyFilter 列表<a href="#2-configmapmgr-构建-envoyfilter-列表" class="hash-link" aria-label="2. ConfigmapMgr 构建 EnvoyFilter 列表的直接链接" title="2. ConfigmapMgr 构建 EnvoyFilter 列表的直接链接">​</a></h3><p>这里比较简单，遍历一下 ItemControllers，聚合每个 itemController 返回的 EnvoyFilters.</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// /pkg/ingress/kube/configmap/controller.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (c *ConfigmapMgr) ConstructEnvoyFilters() ([]*config.Config, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configs := make([]*config.Config, 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, itemController := range c.ItemControllers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IngressLog.Infof("controller %s ConstructEnvoyFilters", itemController.GetName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if itemConfigs, err := itemController.ConstructEnvoyFilters(); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IngressLog.Errorf("controller %s ConstructEnvoyFilters error, error: %+v", itemController.GetName(), err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configs = append(configs, itemConfigs...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configs, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-tracingcontroller-构建-envoyfilters">3. TracingController 构建 EnvoyFilters<a href="#3-tracingcontroller-构建-envoyfilters" class="hash-link" aria-label="3. TracingController 构建 EnvoyFilters的直接链接" title="3. TracingController 构建 EnvoyFilters的直接链接">​</a></h3><p>这里就比较简单，根据保存的 Tracing 数据构建对应的 EnvoyFilter</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/tracing.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (t *TracingController) ConstructEnvoyFilters() ([]*config.Config, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracingConfig := t.constructTracingTracer(tracing, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if len(tracingConfig) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return configs, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config := &amp;config.Config{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Meta: config.Meta{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            GroupVersionKind: gvk.EnvoyFilter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name:             higressTracingEnvoyFilterName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Namespace:        namespace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Spec: &amp;networking.EnvoyFilter{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigPatches: []*networking.EnvoyFilter_EnvoyConfigObjectPatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApplyTo: networking.EnvoyFilter_NETWORK_FILTER,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Match: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Context: networking.EnvoyFilter_GATEWAY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ObjectTypes: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            Listener: &amp;networking.EnvoyFilter_ListenerMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                FilterChain: &amp;networking.EnvoyFilter_ListenerMatch_FilterChainMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Filter: &amp;networking.EnvoyFilter_ListenerMatch_FilterMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Name: "envoy.filters.network.http_connection_manager",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Patch: &amp;networking.EnvoyFilter_Patch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Operation: networking.EnvoyFilter_Patch_MERGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value:     util.BuildPatchStruct(tracingConfig),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApplyTo: networking.EnvoyFilter_HTTP_FILTER,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Match: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Context: networking.EnvoyFilter_GATEWAY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ObjectTypes: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            Listener: &amp;networking.EnvoyFilter_ListenerMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                FilterChain: &amp;networking.EnvoyFilter_ListenerMatch_FilterChainMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    Filter: &amp;networking.EnvoyFilter_ListenerMatch_FilterMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Name: "envoy.filters.network.http_connection_manager",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        SubFilter: &amp;networking.EnvoyFilter_ListenerMatch_SubFilterMatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            Name: "envoy.filters.http.router",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Patch: &amp;networking.EnvoyFilter_Patch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Operation: networking.EnvoyFilter_Patch_MERGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value: util.BuildPatchStruct(`{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            "name":"envoy.filters.http.router",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            "typed_config":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                "@type": "type.googleapis.com/envoy.extensions.filters.http.router.v3.Router",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                "start_child_span": true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configs = append(configs, config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configs, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何扩展全局配置">如何扩展全局配置<a href="#如何扩展全局配置" class="hash-link" aria-label="如何扩展全局配置的直接链接" title="如何扩展全局配置的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-higressconfig-结构体添加对应的扩展配置">1. HigressConfig 结构体添加对应的扩展配置<a href="#1-higressconfig-结构体添加对应的扩展配置" class="hash-link" aria-label="1. HigressConfig 结构体添加对应的扩展配置的直接链接" title="1. HigressConfig 结构体添加对应的扩展配置的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type HigressConfig struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tracing *Tracing `json:"tracing,omitempty"`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在这里添加对应的数据结构来扩展配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-增加扩展配置默认值">2. 增加扩展配置默认值<a href="#2-增加扩展配置默认值" class="hash-link" aria-label="2. 增加扩展配置默认值的直接链接" title="2. 增加扩展配置默认值的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// pkg/ingress/kube/configmap/config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewDefaultHigressConfig() *HigressConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    higressConfig := &amp;HigressConfig{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tracing: NewDefaultTracing(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在这里增加扩展配置默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return higressConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-实现-itemcontroller-interface">3. 实现 ItemController interface<a href="#3-实现-itemcontroller-interface" class="hash-link" aria-label="3. 实现 ItemController interface的直接链接" title="3. 实现 ItemController interface的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type ItemController interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GetName() string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidHigressConfig(higressConfig *HigressConfig) error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConstructEnvoyFilters() ([]*config.Config, error)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegisterItemEventHandler(eventHandler ItemEventHandler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-初始化扩展配置同时添加到-itemcontrollers">4. 初始化扩展配置，同时添加到 ItemControllers<a href="#4-初始化扩展配置同时添加到-itemcontrollers" class="hash-link" aria-label="4. 初始化扩展配置，同时添加到 ItemControllers的直接链接" title="4. 初始化扩展配置，同时添加到 ItemControllers的直接链接">​</a></h3><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracingController := NewTracingController(namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.AddItemControllers(tracingController)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在这里初始化扩展配置，同时添加到 ItemControllers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr.initEventHandlers()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return configmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参与社区贡献">参与社区贡献<a href="#参与社区贡献" class="hash-link" aria-label="参与社区贡献的直接链接" title="参与社区贡献的直接链接">​</a></h2><p>Higress 开源贡献小组正在火热招募贡献者。早期参与开源更容易成为项目 Committer，并有更多机会成为 Higress PMC(Project Management Committee) 的一员，参与主导 Higress 社区的前进方向。
欢迎加入 Higress 社区群：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN0166Gkdt1cRTVjJ2skL_!!6000000003597-2-tps-720-405.png" class="img_ev3q"></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress助力AI大模型企业级应用落地]]></title>
            <link>https://higress.io/zh-cn/blog/ai_plugin</link>
            <guid>https://higress.io/zh-cn/blog/ai_plugin</guid>
            <pubDate>Wed, 12 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[介绍Higress如何通过AI proxy plugin对接AI大模型并实现网关级API管理]]></description>
            <content:encoded><![CDATA[<p>以 ChatGPT 为代表的 AIGC 技术为企业生产带来了巨大的变化，并在企业应用开发领域占据一席之地。AI 大模型凭借其强大的学习能力，可以帮助人们完成各种复杂的任务，例如帮助开发人员编写与调试代码、研究人员快速了解科研领域、营销人员撰写产品描述、设计人员设计新作品等等。许多企业探索如何降低 AI 大模型的使用成本。通过网关进行 AI 大模型的 API 管理成为了很常规的需求。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-如何降低-ai-大模型使用成本">Higress 如何降低 AI 大模型使用成本？<a href="#higress-如何降低-ai-大模型使用成本" class="hash-link" aria-label="Higress 如何降低 AI 大模型使用成本？的直接链接" title="Higress 如何降低 AI 大模型使用成本？的直接链接">​</a></h2><p>Higress GitHub： <a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress</a></p><p>以 OpenAI 为例，OpenAI 的 API 调用并不是基于请求量或者订阅时间来计费，而是基于每个请求的使用量来计费。对于 AI 大模型来说，模型输入与输出的 token 数可以比较好的衡量当前模型进行推理任务的复杂度。因此基于 token 作为请求使用量进行计费是 OpenAI-API 的标准计费策略。对于不同的模型 token 的计费标准也不同，越复杂的模型会生成越好的结果，但也会带来更高的计费。OpenAI 通过为用户分发 API 密钥来完成用户的鉴权与收费等功能。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01U3c6nD1grokneioDi_!!6000000004196-2-tps-3392-1436.png" alt="image.png" class="img_ev3q"></p><p>对于组织来说，为每位成员申请 AI 大模型的访问权限（ API-Key ）显然是不现实的。分散的 API 密钥将不利于组织进行 API 的用量计算、管理与付费，从而增加 AI 大模型的使用成本。其次，对于组织来说，AI 模型的选型、使用频率和成员使用权限、以及向 AI 大模型暴露哪些数据都是在管理中需要着重关注的功能。</p><p>Higress 基于丰富的插件能力，提供了认证鉴权、请求过滤、流量控制、用量监测和安全防护等功能，能够帮助组织与 AI 大模型的 API 交互变得更加安全、可靠和可观察：基于 Higress 提供的认证鉴权能力，组织可以实现通过统一的 API 密钥进行 AI 模型的调用量管理和付费，并为团队成员授予不同的 AI 模型访问权限；基于 Higress 提供的流量控制能力，组织能为不同的模型与用户设置差异化的访问速率限制，有效降低 AI 模型的使用成本；基于 Higress 提供的请求拦截能力，组织能够有效过滤含敏感信息的访问请求，防护部分内部站点资源不对外暴露，从而有效保障内部数据安全；基于<a href="https://www.alibabacloud.com/product/microservices-engine?spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer">商业版 Higress</a>提供的开箱即用的指标查询和日志记录的能力，组织能够完成对不同用户的 AI 模型调用的用量观测与分析，从而制定更加合理的 AI 模型使用策略。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01439pNf1OX3ia9UQ4Z_!!6000000001714-2-tps-2962-1688.png" alt="image.png" class="img_ev3q">                           </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-对接-openai-大语言模型实战">Higress 对接 OpenAI 大语言模型实战<a href="#higress-对接-openai-大语言模型实战" class="hash-link" aria-label="Higress 对接 OpenAI 大语言模型实战的直接链接" title="Higress 对接 OpenAI 大语言模型实战的直接链接">​</a></h2><p>下面我们将以 Higress 对接 OpenAI 大语言模型为例，介绍 Higress 如何无缝对接 AI 大模型。整体方案如图所示，我们基于 WASM 拓展了 Higress 插件，实现了对 OpenAI 语言模型的请求代理转发。基于 Higress 提供的 Key-Auth 认证插件的能力，我们实现统一 API-Key 下的多租户认证。基于 Higress 提供的 Request-Block 请求过滤的能力，我们将实现含敏感信息的请求拦截，保障用户数据安全。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01WjbLBi23A451Ip2xp_!!6000000007214-2-tps-1544-368.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前提条件">前提条件：<a href="#前提条件" class="hash-link" aria-label="前提条件：的直接链接" title="前提条件：的直接链接">​</a></h3><ol><li>安装 Higress ，参考<a href="https://higress.io/zh-cn/docs/ops/deploy-by-helm/#%E6%94%AF%E6%8C%81-istio-crd%E5%8F%AF%E9%80%89" target="_blank" rel="noopener noreferrer">Higress 安装部署文档</a>。</li><li>准备 Go 语言开发 WASM 插件的开发环境，参考<a href="https://higress.io/zh-cn/docs/user/wasm-go" target="_blank" rel="noopener noreferrer">使用 GO 语言开发 WASM 插件</a>。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于-wasm-的-ai-proxy-plugin">基于 WASM 的 AI Proxy Plugin<a href="#基于-wasm-的-ai-proxy-plugin" class="hash-link" aria-label="基于 WASM 的 AI Proxy Plugin的直接链接" title="基于 WASM 的 AI Proxy Plugin的直接链接">​</a></h3><p>下文将给出基于 Higress 与 WASM 实现的 AI 大模型 API 代理插件方案。Higress 支持基于 WASM 实现对外扩展的能力。WASM 插件提供的多语言生态和热插拔机制为插件的实现和部署提供了便利。Higress 同时支持在插件中请求外部服务，为 AI 代理插件的实现提供了高效的解决路径。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="实现示例">实现示例：<a href="#实现示例" class="hash-link" aria-label="实现示例：的直接链接" title="实现示例：的直接链接">​</a></h4><p>我们给出 OpenAI-API 的代理插件的实现示例，详情请参考<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/chatgpt-proxy" target="_blank" rel="noopener noreferrer">AI proxy plugin</a>。下列代码实现了插件相关配置完成之后，基于 HTTP 自动将请求代理转发到 OpenAI-API ，并接收来自 OpenAI-API 的响应，从而完成 AI 模型的调用，具体实现步骤如下：</p><ol><li>通过 RouteCluster 方法指定具体的 OpenAI-API 的 host ，确认用户请求转发的具体路径，并新建用于请求代理转发的 HTTP Client 。</li></ol><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parseConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json gjson</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">MyConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chatgptUri </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"chatgptUri"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> chatgptHost </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> chatgptUri </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ChatgptPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/v1/completions"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        chatgptHost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"api.openai.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//请求默认转发到 OpenAI-API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewClusterClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RouteCluster</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> chatgptHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//通过 RouteCluster 方法确认请求转发的具体 host</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>对用户请求进行 OpenAI-API 的格式封装，通过 HTTP Client 进行请求转发与响应接受，并将响应转发给用户。</li></ol><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//OpenAI API 接收的请求体模版，详见： https://platform.openai.com/docs/api-reference/chat</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bodyTemplate </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"model":"%s",</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"prompt":"%s",</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"temperature":0.9,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"max_tokens": 150,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"top_p": 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"frequency_penalty": 0.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"presence_penalty": 0.6,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"stop": ["%s", "%s"]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onHttpRequestHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HttpContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config MyConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Action </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//根据用户的请求内容进行 OpenAI-API 请求体封装 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    body </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bodyTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prompt</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HumanId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AIId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//通过 HTTP Client 进行转发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ChatgptPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Content-Type"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"application/json"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Authorization"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Bearer "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ApiKey</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statusCode </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> responseHeaders http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> responseBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> headers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> responseHeaders </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//接收来自于 OpenAI-API 的响应并转发给用户</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendHttpResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">uint32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statusCode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> responseBody</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 Higress 中启用自定义的 AI-Proxy-Wasm 插件流程如下：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN012qI5vq1gOVPEwxqRr_!!6000000004132-2-tps-2000-1064.png" class="img_ev3q"></p><p>本示例提供已经编译好的 AI-proxy-plugin-wasm 文件并完成对应 docker 镜像的构建和推送，推荐配置如下所示：</p><table><thead><tr><th>名称</th><th>推荐配置</th></tr></thead><tbody><tr><td>镜像地址</td><td>oci://registry.cn-hangzhou.aliyuncs.com/zwj_test/chatgpt-proxy:1.0.0</td></tr><tr><td>插件执行阶段</td><td>鉴权阶段</td></tr><tr><td>插件执行优先级</td><td>1</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="插件配置说明">插件配置说明：<a href="#插件配置说明" class="hash-link" aria-label="插件配置说明：的直接链接" title="插件配置说明：的直接链接">​</a></h4><p>插件配置简单，支持全局/域名级/路由级的代理转发。推荐进行路由级配置：选中对应的<strong>路由配置</strong>-选中<strong>对应路由</strong>-<strong>策略</strong>-<strong>启用插件</strong>。配置字段包括：</p><table><thead><tr><th>名称</th><th>数据类型</th><th>填写要求</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>model</td><td>string</td><td>选填</td><td>text-davinci-003</td><td>调用的模型名称</td></tr><tr><td>apiKey</td><td>string</td><td>必填</td><td>-</td><td>OpenAI-API 密钥，详情可参考</td></tr><tr><td>promptParam</td><td>string</td><td>选填</td><td>prompt</td><td>prompt 的来源字段名称，URL 参数</td></tr><tr><td>chatgptUri</td><td>string</td><td>选填</td><td>api.openai.com/v1/completions</td><td>调用 AI 模型服务的 URL 路径，默认值为 OpenAI 的 API 调用路径</td></tr></tbody></table><p>示例配置如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiKey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"xxxxxxxxxxxxxxxxxx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">model</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"curie"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">promptParam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"text"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据该配置，网关代理到 OpenAI-API 下的 curie 模型，用户通过 text 关键字在 url 中输入文本。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http://{GatewayIP}/?text=Say,hello"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>得到 OpenAI-API 的响应：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN010ZHdxO1ZOmKXfjVaV_!!6000000003185-2-tps-3170-520.png" alt="image.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于-key-auth-的多租户认证">基于 Key Auth 的多租户认证<a href="#基于-key-auth-的多租户认证" class="hash-link" aria-label="基于 Key Auth 的多租户认证的直接链接" title="基于 Key Auth 的多租户认证的直接链接">​</a></h3><p>不同于为每位成员颁发 OpenAI-API 密钥的形式，企业可以基于 Higress 网关提供的认证鉴权能力，依靠内部授权（如 Key Auth 等）来管理成员对 AI 模型对访问权限，从而限制成员可以使用的服务和模型，并依靠统一的 AI-API 密钥进行请求代理转发实现对 API 用量的统一管理。接下来以 Key Auth 为例介绍 Higress 的多租户认证能力。</p><p>Key Auth 插件实现了基于网关内 API Key 进行认证和鉴权的功能，支持从 HTTP 请求的 URL 参数或者请求头解析 API Key ，同时验证该 API 是否有权限访问。通过在<strong>Higress 控制台</strong>-<strong>插件市场</strong>-<strong>Key Auth</strong>进行<strong>全局配置</strong>和<strong>路由级配置</strong>，即可实现 Higress 网关的多租户认证。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01qaQxNw1DIthKfowWi_!!6000000000194-2-tps-2773-1350.png" class="img_ev3q"></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">consumers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">credential</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"xxxxxx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"consumer1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">credential</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"yyyyyy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"consumer2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">global_auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">in_header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"apikey"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01Or1jY41SYDAyTJ6ve_!!6000000002258-2-tps-2018-951.png" class="img_ev3q"></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">allow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">consumer1</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上配置定义了指向 AI 模型服务的消费者组<code>consumers</code>，并且只有<code>consumer1</code>具备访问当前路由下 AI 模型服务的权限。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl "http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">GatewayIP</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">text=Say</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">hello"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#请求未提供 API-Key ，返回 401</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl "http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">GatewayIP</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">text=Say</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">hello" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">H "apikey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">zzzzzz"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#请求提供的 API-Key 未在消费者组内，无权访问，返回 401</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl  "http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">GatewayIP</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">text=Say</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">hello" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">H "apikey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">yyyyyy"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#根据请求提供的 API-Keyy 匹配到的调用者无 AI 模型服务的访问权限，返回 403</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl "http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">GatewayIP</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">text=Say</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">hello" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">H "apikey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">xxxxxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#请求合法且有 AI 模型服务访问权限，请求将被代理到 AI 模型，正常得到 OpenAI-API 的响应</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Higress 除了提供网关级多租户认证外，还能提供限流等能力。Key Rate Limit 插件可以根据用户在消费组中的成员资格对用户请求速率进行限制，从而限制应用程序对高成本 AI 大模型服务的消耗。基于多租户认证与限流等功能，Higress 可以完全控制 AI 大模型 API 的访问权限、访问数量与调用成本。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于-request-block-保障数据安全">基于 Request Block 保障数据安全<a href="#基于-request-block-保障数据安全" class="hash-link" aria-label="基于 Request Block 保障数据安全的直接链接" title="基于 Request Block 保障数据安全的直接链接">​</a></h3><p>对于 AI 大模型尤其是语言模型来说，要得到良好的返回往往需要用户提供足够的提示（ prompt ）作为模型输入。这也意味着组织和个人可能会在提供提示的过程中面临数据泄漏的风险。因此如何在使用 AI 模型的过程中保障数据安全也是 API 调用方面临重要问题。保护数据安全涉及到对 AI 模型的 API 调用渠道进行严格的控制。一种方式是使用特定的经批准的模型与其发布的 API 。另一种方式是对含敏感信息的用户请求进行拦截。这可以通过在网关级别设置特定的请求拦截来实现。Higress 基于 Request Block 插件提供请求拦截能力，既能防止未经授权的模型访问用户信息，又能防止含敏感信息的用户请求暴露到外网。</p><p>Request Block 插件基于 URL 、请求头等特征屏蔽 HTTP 请求，可以用于防护站点资源不对外暴露。 通过在<strong>Higress 控制台</strong>-<strong>插件市场-Request Block</strong>进行屏蔽字段配置，即可防止含敏感字段的请求对外发送。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01mqWHos1XDD5yRxOeX_!!6000000002889-2-tps-2905-914.png" class="img_ev3q"></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">blocked_code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> pw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">case_sensitive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上配置定义了当前路由下基于 URL 的屏蔽字段，其中含敏感信息（如 password 、pw ）的请求将被屏蔽。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl "http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">GatewayIP</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">text=Mypassword=xxxxxx" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">H "apikey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">xxxxxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl "http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">GatewayIP</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">text=pw=xxxxxx" </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">H "apikey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">xxxxxx"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#上述请求将被禁止访问，返回 404</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于商业版-higress-的用量观测与分析">基于商业版 Higress 的用量观测与分析<a href="#基于商业版-higress-的用量观测与分析" class="hash-link" aria-label="基于商业版 Higress 的用量观测与分析的直接链接" title="基于商业版 Higress 的用量观测与分析的直接链接">​</a></h3><p>对于组织来说，对各用户进行 AI 模型调用的用量观测和分析有助于了解其使用情况与产生的成本。对于个人用户，了解自己的调用量和开销也是必要的。因此，在网关层进行调用的观测和分析对于 AI 大模型的 API 管理是必要的能力。<a href="https://www.alibabacloud.com/product/microservices-engine?spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer">商业版 Higress</a>与各种指标与日志系统进行了深度集成，提供了开箱即用的用量观测分析报告构建机制，可以实时查看各种 API 的使用情况，并根据各类参数进行过滤，从而更好的了解 API 使用情况。</p><p>以观察各用户对 OpenAI-Curie 模型的调用量为例，用户可通过<strong>MSE 管理控制台</strong>-<strong>云原生网关</strong>-<strong>网关实例</strong>-<strong>参数配置-日志格式调整</strong>中设置区分用户的可观测性参数请求头：<code>x-mse-consumer</code>，将其列入观测列表。之后进入<strong>观测分析-日志中心</strong>中设置使用统计图表功能即可完成对 API 的用量观测和分析。如下图所示，用户<code>consumer1</code>与用户<code>consumer2</code>的对 OpenAI-Curie 模型的调用量以饼状图形式呈现。
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01OuAcQD24P0cStcIJE_!!6000000007382-2-tps-2362-864.png" alt="image.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入-higress-社区">加入 Higress 社区<a href="#加入-higress-社区" class="hash-link" aria-label="加入 Higress 社区的直接链接" title="加入 Higress 社区的直接链接">​</a></h2><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01Ahr6qi1vL2e1xPJEy_!!6000000006155-2-tps-1685-1091.png" alt="image.png" class="img_ev3q"></p><p>如果您觉得 Higress 对您有帮助，欢迎前往<a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">github: Higress</a>为我们 star 一下！</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[美洽智能客服使用 Higress 统一网关落地实践]]></title>
            <link>https://higress.io/zh-cn/blog/user-mq</link>
            <guid>https://higress.io/zh-cn/blog/user-mq</guid>
            <pubDate>Mon, 10 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[美洽在阿里云上采用Higress企业版，在其他云采用Higress开源版，统一了网关架构]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于美洽">关于美洽<a href="#关于美洽" class="hash-link" aria-label="关于美洽的直接链接" title="关于美洽的直接链接">​</a></h2><p>美洽是一家全球智能云客服服务商，提供一站式智能客服解决方案，旗下拥有在线客服、工单系统、呼叫中心、客服机器人、语音机器人、营销机器人等产品及服务。美洽成立于2014年，总部位于成都，目前服务企业用户已超过40万家，覆盖多个行业领域。美洽的客服系统支持多平台使用，包括Web 网页端、手机客户端、PC 客户端，同时美洽也提供了开放 API 平台。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="需求背景">需求背景<a href="#需求背景" class="hash-link" aria-label="需求背景的直接链接" title="需求背景的直接链接">​</a></h2><ol><li>多条业务线使用了了不同编程语言，在微服务化演进的路上困难重重；</li><li>历史架构使用多个流量转发中间件导致流量路径冗长、复杂且故障排查困难（LB + OpenResty + Nginx + Caddy + SpringCloud-Gateway）；</li><li>WebSocket 长连接服务在多重路由层上不支持热更新，维护成本高。</li></ol><p><strong>历史架构的流量拓扑图如下：</strong></p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01AJitLM1kgbW6yGLmV_!!6000000004713-0-tps-627-517.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="需求目标">需求目标<a href="#需求目标" class="hash-link" aria-label="需求目标的直接链接" title="需求目标的直接链接">​</a></h2><ol><li>找到一个统一网关，能够一次性解决流量网关和业务网关的路由转发需求；</li><li>支持路由规则热更新，解决 WebSocket 连接在路由更新或网络抖动时产生的重连风暴；</li><li>前置API 请求权限校验、签名校验、WAF 拦截、CC 拦截；</li><li>可视化统一网关的后台操作，让普通员工也能上手；</li><li>多云架构下私有化部署支持。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="方案横向对比">方案横向对比<a href="#方案横向对比" class="hash-link" aria-label="方案横向对比的直接链接" title="方案横向对比的直接链接">​</a></h2><p>通过对目前市面上流行的网关产品进行详细的横向对比，再结合美洽对统一网关的需求目标，我们从对比的表格当中，看到了 Higress 所带来的最佳对比结果。</p><p>同时美洽重点关注的几个点：K8S Ingress 支持、WebSocket支持、Nacos 服务发现、路由配置热更新、WASM 插件都得到了很好的支持。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01bjoMSi1arSkPgWvVV_!!6000000003383-0-tps-750-470.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么选择-higress">为什么选择 Higress<a href="#为什么选择-higress" class="hash-link" aria-label="为什么选择 Higress的直接链接" title="为什么选择 Higress的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="面向多云架构友好">面向多云架构友好<a href="#面向多云架构友好" class="hash-link" aria-label="面向多云架构友好的直接链接" title="面向多云架构友好的直接链接">​</a></h3><p>Higress 在阿里云上有成熟的企业版产品：MSE 云原生网关，我们从 2021 年开始使用这款产品，这是一款全托管，完全免运维的 SaaS 网关产品，并且具备强劲的性能和丰富的功能，相比自建同吞吐的网关，整体成本是更低的，因此我们在阿里云上直接使用了这款产品。</p><p>美洽除了阿里云，在其他云上也有部署业务，我们希望能统一多云的统一网关技术架构，开源版 Higress 正好符合我们的需求，相比商业版，在控制台功能上，开源版目前的能力相对较少，但大部分功能也都可以通过自己定义 K8s CRD 配置的方式来实现，完全满足我们的需求。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="原生支持-k8s-ingress">原生支持 K8s Ingress<a href="#原生支持-k8s-ingress" class="hash-link" aria-label="原生支持 K8s Ingress的直接链接" title="原生支持 K8s Ingress的直接链接">​</a></h3><p>美洽从 2021 年便已经全面迁移到 Kubernetes 进行资源调度，遇到最大的困难是历史的网关中间件，在容器化的架构里面，各种水土不服，要么需要借助 Nginx-Ingress-Controller，要么需要外部的 SLB 进行服务之间的负载均衡与网络通信。这导致了比容器化之前更加复杂的流量路径，一度让我们下定决心，必须、必须、必须要解决统一网关的问题，还必须云原生的。</p><p>2021 年底开始，我们开始尝试使用阿里云 MSE 网关 SaaS 产品，开始将部分服务从 Nginx 路由迁移到 MSE 网关上，很快解决了Ngxin Configuration 配置维护复杂，故障频发的问题，尝到甜头后，我们便开始计划进一步扩大 MSE 网关的使用，结合 Nacos 和 K8S 的服务发现，将 80% 大部分容器化服务路由转发全部迁移到了云原生网关上。</p><p>这带来的收益就包括：</p><ol><li>简化了流量路径，公网流量通过 SLB 直接到达网关，网关路由直达容器 Pod；</li><li>释放了使用 ECS 自建的 Nginx 、OpenResty 、Caddy 服务，降低了大量服务器成本；</li><li>服务发现和服务治理，以及各个服务当前的健康状态都以可视化的 Dashborad 呈现出来；</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="控制面和数据面解耦的架构">控制面和数据面解耦的架构<a href="#控制面和数据面解耦的架构" class="hash-link" aria-label="控制面和数据面解耦的架构的直接链接" title="控制面和数据面解耦的架构的直接链接">​</a></h3><p>控制面和数据面解耦是一种很好的设计模式，把管理控制逻辑和运行处理逻辑分开，这样可以更好地管理和扩展系统。</p><ol><li>Console 负责管理 和 Gateway 负责处理请求，灵活可扩展，互补干扰；</li><li>整个系统的性能和可用性可以得到很好的保障；</li><li>即使控制面出现问题，数据面仍然可以继续处理请求，反之亦然。</li></ol><p>在美洽客服自己的产品中，也大量试用了控制面和数据面分离的这种架构设计模式，在选择 Higress 统一网关的落地实践中，也更好的可以和美洽产品的架构进行配合，例如控制台采用微前端技术统一美洽运维控制台，Higress 控制台，Nacos 控制台。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="容易上手的后台-dashboard">容易上手的后台 Dashboard<a href="#容易上手的后台-dashboard" class="hash-link" aria-label="容易上手的后台 Dashboard的直接链接" title="容易上手的后台 Dashboard的直接链接">​</a></h3><p>在早期，美洽在 2021 年开始使用阿里云 MSE 云原生网关时，就已经对网关的控制台使用有了很多的经验基础，团队中 QA 同学也能熟练使用了。目前在其他云上的项目，私有化部署的开源版Higress，在控制台方面功能与操作和阿里云 MSE 产品的交互保持一致，团队使用很快便上手了。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01SgNYtt1NcizsTgB5w_!!6000000001591-0-tps-750-300.jpg" class="img_ev3q"></p><p>插件方面，美洽使用了 JWT Auth 鉴权，Key Rate Limit 限流，HMAC Auth 请求签名，Bot Detect 和 WAF 功能有涉及。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN015fP9mx1lv5ewluuvs_!!6000000004880-0-tps-750-420.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="美洽的落地实践">美洽的落地实践<a href="#美洽的落地实践" class="hash-link" aria-label="美洽的落地实践的直接链接" title="美洽的落地实践的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="采用-helm-在-k8s-node-上-一键部署">采用 Helm 在 K8s node 上 一键部署<a href="#采用-helm-在-k8s-node-上-一键部署" class="hash-link" aria-label="采用 Helm 在 K8s node 上 一键部署的直接链接" title="采用 Helm 在 K8s node 上 一键部署的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> higress.io </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">https://higress.io/helm-charts</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> higress higress.io/higress -n higress-system --create-namespace</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="完全替代了-nginx-openrestycaddy-slb-intranet">完全替代了 Nginx 、OpenResty、Caddy 、SLB-Intranet<a href="#完全替代了-nginx-openrestycaddy-slb-intranet" class="hash-link" aria-label="完全替代了 Nginx 、OpenResty、Caddy 、SLB-Intranet的直接链接" title="完全替代了 Nginx 、OpenResty、Caddy 、SLB-Intranet的直接链接">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01ElAB4A1ijgxDUXf9g_!!6000000004449-0-tps-630-532.jpg" class="img_ev3q">
<img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN011wDPMy1vpGmaT06Tq_!!6000000006221-0-tps-631-532.jpg" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="彻底解决-websocket-断线重连问题">彻底解决 WebSocket 断线重连问题<a href="#彻底解决-websocket-断线重连问题" class="hash-link" aria-label="彻底解决 WebSocket 断线重连问题的直接链接" title="彻底解决 WebSocket 断线重连问题的直接链接">​</a></h3><p>美洽的智能客服产品侧试用了 WebSocket 进行长连接保持和消息通信，所以非常依赖网络的稳定，以及更新网关配置所带来的副作用。在使用 Nginx + OpenResty 方案的期间，每一次的配置变更都会带来极大的代价，断线重连风暴时常发生。一次配置变更 Pendding 或者变更失败带来的瞬时断联是及其痛苦的。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01rvv5Mc1hoRRlBhdO2_!!6000000004324-0-tps-750-440.jpg" class="img_ev3q"></p><p>在迁移到 Higress 上之后，路由配置热更新特性，不在需要像 Nginx 一样需要 Reload Gateway，解决配置更新 reload 带来的断线重连风暴问题。</p><p>另外，在 WebSocket Server 服务升级过程中，通过给 Pod 打上 stage 标签，在 Higress 侧通过标签路由进行新老版本无损流量切换，给产品快速迭代升级带了巨大的杠杆效应。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="熔断限流">熔断限流<a href="#熔断限流" class="hash-link" aria-label="熔断限流的直接链接" title="熔断限流的直接链接">​</a></h3><p>在面向 2B 的 SaaS 产品业务场景中，经常会发生某一个客户突发海量流量，占据大量带宽，影响其他客户正常使用的情况，这时我们需要针对客户规模对单个客户的 API 并发上限做灵活的动态限流，使用 Higress 的插件Key Rate Limit 就很好的解决了这个问题，根据流量大盘随时调整限流水位红线，做到精准，灵活的限流。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01QhTG261lZZ2kbT1qe_!!6000000004833-0-tps-750-467.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="经验总结">经验总结<a href="#经验总结" class="hash-link" aria-label="经验总结的直接链接" title="经验总结的直接链接">​</a></h2><p>Higress 网关的落地，给企业全面落地云原生微服务架构提供强有力的支持，对我们技术人员来说，这绝对是一个杠杆级别的开源产品，另外，在阿里云上又有对等的 SaaS 产品，这样的配合，将公有云和私有化部署的统一网关一次性全部解决，对企业来说是绝对的利好。</p><ol><li>统一流量网关+业务网关能力，实现了给企业降本，为研发增效；</li><li>为云原生架构提供很好的基座，在异构语言服务化层面排除了网络通信难题；</li><li>路由热更新、无损升级、可视化 Console、开放的插件、基于 Kubernetes 和 Istio，给技术演进带来了更多的可能性。</li></ol><p>最后，我们祝愿 Higress 在云原生的道路上越走越远，大家一起用开源、开放、分享的心态将 Higress 建设地越来越好。</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress 集成 Skywalking 可观测性探索]]></title>
            <link>https://higress.io/zh-cn/blog/skywalking</link>
            <guid>https://higress.io/zh-cn/blog/skywalking</guid>
            <pubDate>Tue, 20 Jun 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Higress 集成 Skywalking 可观测性探索]]></description>
            <content:encoded><![CDATA[<p><a href="https://higress.io/zh-cn/" target="_blank" rel="noopener noreferrer">Higress</a> 一个遵循开源Ingress/Gateway API标准，提供流量调度、服务治理、安全防护三合一的高集成、易使用、易扩展、热更新的下一代云原生网关。</p><p><a href="https://skywalking.apache.org/" target="_blank" rel="noopener noreferrer">Skywalking</a> 是一个开源的可观测平台，用于从服务和云原生基础设施收集，分析， 聚合及可视化数据。</p><p><a href="https://github.com/2456868764/httpbin" target="_blank" rel="noopener noreferrer">Httpbin</a> 是基于 Gin 开发，用于快速测试基于云原生微服务可观测性和流量管理等功能。</p><p>本文介绍 Higress 集成 Skywalking 实现可观测性，主要内容涉及整体架构、Skywalking 调用链路跟踪原理、Higress 架构、业务应用集成 Skywalking、本地测试环境搭建、Higress 配置、应用安装、调用链路跟踪配置以及 Higress gateway 指标和监控面板。</p><p>这次可观测性探索相关 manifests <a href="https://gitcode.net/-/snippets/3612" target="_blank" rel="noopener noreferrer">下载地址</a> </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一整体架构图">一、整体架构图<a href="#一整体架构图" class="hash-link" aria-label="一、整体架构图的直接链接" title="一、整体架构图的直接链接">​</a></h2><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress-d2e17031336b9178c2668d80ff818c5b.png" width="2855" height="1318" class="img_ev3q"></p><p>整体包含四大块内容：</p><ul><li>Higress 组件：    higress-gateway, higress-console, higress-controller</li><li>Skywalking 组件： skywalking dashboard ui, skywalking aop server</li><li>业务应用组件：      bff, middle service, backend service</li><li>Ingress 组件：    console.higress.io, skywalking.higress.io, httpbin.example.com</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二skywalking-调用链路跟踪原理">二、Skywalking 调用链路跟踪原理<a href="#二skywalking-调用链路跟踪原理" class="hash-link" aria-label="二、Skywalking 调用链路跟踪原理的直接链接" title="二、Skywalking 调用链路跟踪原理的直接链接">​</a></h2><p>SkyWalking为服务(service)，服务实例(service instance)，以及端点(endpoint)提供了可观测能力。</p><ul><li>服务(service)：表示对请求提供相同行为的一组工作负载。在使用打点代理或 SDK 的时候，可以定义服务的名字。</li><li>服务实例(Service Instance)：一组工作负载中的每一个工作负载称为一个实例。</li><li>端点(Endpoint)： 对于特定服务所接收的请求路径，如 HTTP 的 URI 路径和 gRPC 服务的类名 + 方法签名。</li><li>进程（Process）： 操作系统进程. 在某些场景下，一个服务实例和进程不是一一对应， 在k8s部署下，一个POD对应多个进程。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="skywalking-整体架构">Skywalking 整体架构<a href="#skywalking-整体架构" class="hash-link" aria-label="Skywalking 整体架构的直接链接" title="Skywalking 整体架构的直接链接">​</a></h3><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/skywalking1-b2464b380f61dc6e13853ec4ad648e8a.png" width="2160" height="721" class="img_ev3q"></p><p>主要由四个核心组件组成：</p><ul><li>探针: 探针用于收集监测数据包括指标，链路跟踪，日志和事件</li><li>数据接收和聚合: 平台后端支持数据聚合，数据分析以及驱动数据流从探针到用户界面的处理</li><li>存储: 通过开放接口支持后端存储系统支持ElasticSearch, H2, MySQL, TiDB, BanyanDB等</li><li>UI:  一个定制化的Web系统，用户可以可视化查看和管理 SkyWalking 数据</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式链路追踪原理分析">分布式链路追踪原理分析<a href="#分布式链路追踪原理分析" class="hash-link" aria-label="分布式链路追踪原理分析的直接链接" title="分布式链路追踪原理分析的直接链接">​</a></h3><ol><li>分布式链路介绍</li></ol><p>分布式链路追踪是记录来源于用户请求在各个系统或者服务中所传播的路径。</p><blockquote><p>A distributed trace, more commonly known as a trace, records the paths taken by requests (made by an application or end-user) as they propagate through multi-service architectures, like microservice and serverless applications.</p></blockquote><p>分布式链路追踪图示如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress13-213da6eb6d44a461df9b933067002f4e.png" width="910" height="240" class="img_ev3q"></p><ol start="2"><li>Skywalking 分布式链路追踪</li></ol><p>主要包含四个内容：</p><ul><li>Trace: 一个完整的链路由多个 Segment 组成</li><li>Segment: 一个请求在一个进程内的轨迹</li><li>Span: 一个请求在某个进程里的一个组件逻辑内的轨迹, 有 Entry Span， Local Span 和 Exit Span 三类</li><li>Span context: 跨进程或者服务 Trace 传递，这里讨论 http 传递头 sw8</li></ul><p>基本组件图示如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/skywalking_trace-ae4a862a6abced391f00069e9ed32f26.png" width="2370" height="929" class="img_ev3q"></p><p>从上图可以看出：</p><ul><li>一个 Trace 内的所有 span 的 Trace ID 是相同的</li><li>一个 Segment 中有一个 EntrySpan，是 Segment 内其他 Span 的根 Parent</li><li>后一个 Segment的 Entryspan 总是与前一个 Segment 中的某个 ExitSpan 关联</li></ul><ol start="3"><li>Skywalking Trace 的数据协议</li></ol><p>具体数据协议参考 <a href="https://skywalking.apache.org/docs/main/next/en/api/trace-data-protocol-v3/" target="_blank" rel="noopener noreferrer">Skywalking Trace Data Protocol</a>, 这里主要讲一下 sw8 格式和组成。</p><p>sw8 格式: XXXXX-XXXXX-XXXX-XXXX，以 - 分割。
样例: 1-MzYzMzM1NDctNTc0YS00MzZlLTgzNWEtNTY1YTQyNzk3YTY3-ZWQ3ODA2ZjYwNTI0MTFlZWE5ZDdmZTFhNTA5YTRmYTk=-1-bWlkZGxl-bWlkZGxlLTZmNGRkN2JmNmMtcWJ4cm0=-L0dFVC9zZXJ2aWNl-aHR0cDovL2JhY2tlbmQv</p><p>具体内容如下：</p><ul><li>采样标记(Sample):  0 或者 1， 0 表示不采样 1 表示采样</li><li>跟踪ID(Trace ID): 字符(BASE64 编码)</li><li>父Sengment ID (Parent trace segment ID): 字符(BASE64 编码)</li><li>父 Span ID（Parent span ID): 整型</li><li>父服务名称(Parent service): 字符(BASE64 编码)</li><li>父服务实例(Parent service instance): 字符(BASE64 编码)</li><li>父Endpoint(Parent endpoint): 字符(BASE64 编码)</li><li>目标地址：字符(BASE64 编码)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三higress-架构">三、Higress 架构<a href="#三higress-架构" class="hash-link" aria-label="三、Higress 架构的直接链接" title="三、Higress 架构的直接链接">​</a></h2><p>Higress是基于阿里内部的Envoy Gateway实践沉淀、以开源 Istio + Envoy 为核心构建的下一代云原生网关，实现了流量网关 + 微服务网关 + 安全网关三合一的高集成能力，深度集成Dubbo、Nacos、Sentinel等微服务技术栈，能够帮助用户极大的降低网关的部署及运维成本且能力不打折；</p><p>在标准上全面支持 Ingress与 Gateway API，积极拥抱云原生下的标准API规范；</p><p>同时，Higress Controller也支持Nginx Ingress平滑迁移，帮助用户零成本快速迁移到Higress。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress12-cfd41d730d22a7648fcc1f6d06765fb8.png" width="2483" height="2024" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四业务应用集成-skywalking">四、业务应用集成 Skywalking<a href="#四业务应用集成-skywalking" class="hash-link" aria-label="四、业务应用集成 Skywalking的直接链接" title="四、业务应用集成 Skywalking的直接链接">​</a></h2><p>业务应用通过与 <a href="https://github.com/SkyAPM/go2sky" target="_blank" rel="noopener noreferrer">go2sky</a> 项目集成 SkyWalking 监控 Golang 应用程序，主要通过 Gin middleware 和 Http 请求手动埋点。</p><p>1、集成 Gin middleware</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func middleware(engine *gin.Engine, tracer *go2sky.Tracer) gin.HandlerFunc {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if engine == nil || tracer == nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return func(c *gin.Context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c.Next()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return func(c *gin.Context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if strings.HasPrefix(c.Request.URL.String(), skipProbPrefix) || strings.HasPrefix(c.Request.URL.String(), skipMetricsPrefix) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c.Next()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span, ctx, err := tracer.CreateEntrySpan(c.Request.Context(), getOperationName(c), func(key string) (string, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return c.Request.Header.Get(key), nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c.Next()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span.SetComponent(componentIDGINHttpServer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span.Tag(go2sky.TagHTTPMethod, c.Request.Method)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span.Tag(go2sky.TagURL, c.Request.Host+c.Request.URL.Path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span.SetSpanLayer(agentv3.SpanLayer_Http)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.Request = c.Request.WithContext(ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.Next()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(c.Errors) &gt; 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            span.Error(time.Now(), c.Errors.String())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span.Tag(go2sky.TagStatusCode, strconv.Itoa(c.Writer.Status()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span.End()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func getOperationName(c *gin.Context) string {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fmt.Sprintf("/%s%s", c.Request.Method, c.FullPath())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2、Http请求手动埋点</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func traceHttpCall(c *gin.Context, req *http.Request, url string, fn func(req *http.Request) (*http.Response, error)) (*http.Response, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracer := go2sky.GetGlobalTracer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if tracer == nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resp, err := fn(req)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resp, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqSpan, err := go2sky.GetGlobalTracer().CreateExitSpan(c.Request.Context(), "invoke", url, func(headerKey, headerValue string) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        req.Header.Set(headerKey, headerValue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqSpan.SetComponent(2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqSpan.SetSpanLayer(v3.SpanLayer_Http)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resp, err2 := fn(req)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqSpan.Tag(go2sky.TagHTTPMethod, http.MethodGet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqSpan.Tag(go2sky.TagURL, url)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqSpan.End()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return resp, err2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五本地测试环境搭建">五、本地测试环境搭建<a href="#五本地测试环境搭建" class="hash-link" aria-label="五、本地测试环境搭建的直接链接" title="五、本地测试环境搭建的直接链接">​</a></h2><ol><li>本地安装 kubectl, kind, helm</li></ol><p>可以参考 Higress <a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">快速开始</a>安装 kubectl, kind。
helm 安装参考<a href="https://helm.sh/zh/docs/intro/install/" target="_blank" rel="noopener noreferrer">安装文档</a></p><ol start="2"><li>安装 higress 和 istio CRD</li></ol><p>可以参考 higress <a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">快速开始</a> 和 <a href="https://higress.io/zh-cn/docs/ops/deploy-by-helm" target="_blank" rel="noopener noreferrer">安装部署</a> 来部署，这里需要安装  Istio CRD。</p><p>这里提供一键安装脚本 local-env-setup.sh，运行 local-env-setup.sh 安装 Higress</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./local-env-setup.sh --crd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>部署 Skywalking，业务应用和 Ingress</li></ol><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${</span><span class="token variable environment constant" style="color:#36acaa">HOME</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain">/.kube/config_higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f skywalking.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f app.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f ingress.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>检查 POD 运行状态和 Ingress 状态</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${</span><span class="token variable environment constant" style="color:#36acaa">HOME</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain">/.kube/config_higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n higress-system </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                         READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-6f554978dc-cclg7             </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-grafana-7495766db4-4flq5     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          131m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-prometheus-6d7bdccfb-hxtsq   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          131m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-controller-689c5b965f-7wsmt          </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">/2     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          131m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-gateway-59966b45d9-z7ltd             </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          131m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n op-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skywalking-oap-dashboard-65f496ccc9-dr96l   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skywalking-oap-server-859694656b-p8vcq      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n app-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend-6b9549bc64-f98tr   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend-6b9549bc64-x2btl   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bff-766967f8db-8ght7       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bff-766967f8db-gflbh       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">middle-6f4dd7bf6c-qdjqj    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">middle-6f4dd7bf6c-stzf4    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n app-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend   ClusterIP   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.179.140   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP    99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bff       ClusterIP   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.121.62    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP    99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">middle    ClusterIP   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.55.8      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP    99m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ingress -n higress-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         CLASS     HOSTS                   ADDRESS   PORTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console              higress   console.higress.io                </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-grafana      higress   console.higress.io                </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-prometheus   higress   console.higress.io                </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">httpbin                      higress   httpbin.example.com               </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skywalking-dashboard         higress   skywalking.higress.io             </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>测试 Higress Console, Skywalking Dashboard, Bff 服务</li></ol><p>1）编辑 /etc/hosts 文件添加以下三个域名</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 console.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 skywalking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 httpbin.example.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）打开 higress-gateway 端口转发</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${</span><span class="token variable environment constant" style="color:#36acaa">HOME</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain">/.kube/config_higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n higress-system port-forward service/higress-gateway </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3）通过浏览器打开访问上面三个域名</p><p>Higress 控制台: <a href="http://console.higress.io:8080" target="_blank" rel="noopener noreferrer">http://console.higress.io:8080</a>，用户名为 admin，登录密码为安装时设定的管理员密码。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress1-67659805b3a2379e1b1763bded3a578f.png" width="2698" height="1142" class="img_ev3q"></p><p>Skywalking Dashboard: <a href="http://skywalking.higress.io:8080" target="_blank" rel="noopener noreferrer">http://skywalking.higress.io:8080</a></p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress2-c487b42954d302305876710cc8b52dce.png" width="2814" height="1420" class="img_ev3q"></p><p>Bff 服务： <a href="http://httpbin.example.com:8080/hostname" target="_blank" rel="noopener noreferrer">http://httpbin.example.com:8080/hostname</a></p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress3-be62e59d28067affe19a9bad51bca50a.png" width="2708" height="1156" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六higress-集成-skywalking-调用链路跟踪配置">六、Higress 集成 Skywalking 调用链路跟踪配置<a href="#六higress-集成-skywalking-调用链路跟踪配置" class="hash-link" aria-label="六、Higress 集成 Skywalking 调用链路跟踪配置的直接链接" title="六、Higress 集成 Skywalking 调用链路跟踪配置的直接链接">​</a></h2><p>通过修改 Higress configmap 全局配置 higress-config 来激活 Higress 集成 Skywalking 调用链路跟踪。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${</span><span class="token variable environment constant" style="color:#36acaa">HOME</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain">/.kube/config_higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl edit configmap higgress-config -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 data 下增加 higress 配置项然后保存，具体配置内容如下：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  higress: </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracing:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sampling: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      timeout: </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      skywalking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       service: skywalking-oap-server.op-system.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       port: </span><span class="token number" style="color:#36acaa">11800</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="七skywalking-链路跟踪">七、Skywalking 链路跟踪<a href="#七skywalking-链路跟踪" class="hash-link" aria-label="七、Skywalking 链路跟踪的直接链接" title="七、Skywalking 链路跟踪的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="运行压测脚本">运行压测脚本<a href="#运行压测脚本" class="hash-link" aria-label="运行压测脚本的直接链接" title="运行压测脚本的直接链接">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">seq</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">1000</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -v -H </span><span class="token string" style="color:#e3116c">"Host:httpbin.example.com"</span><span class="token plain"> http://127.0.0.1:8080/hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -v -H </span><span class="token string" style="color:#e3116c">"Host:httpbin.example.com"</span><span class="token plain"> http://127.0.0.1:8080/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -v -H </span><span class="token string" style="color:#e3116c">"Host:httpbin.example.com"</span><span class="token plain"> http://127.0.0.1:8080/service?services</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">middle,backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="调用-bff-服务-service-接口来模拟调用链路">调用 bff 服务 /service 接口来模拟调用链路<a href="#调用-bff-服务-service-接口来模拟调用链路" class="hash-link" aria-label="调用 bff 服务 /service 接口来模拟调用链路的直接链接" title="调用 bff 服务 /service 接口来模拟调用链路的直接链接">​</a></h3><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -v -H </span><span class="token string" style="color:#e3116c">"Host:httpbin.example.com"</span><span class="token plain"> http://127.0.0.1:8080/service?services</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">middle,backend</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>部分返回响应体情况如下：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"args"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"form"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"headers"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"accept-encoding"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"gzip"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"sw8"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1-MzYzMzM1NDctNTc0YS00MzZlLTgzNWEtNTY1YTQyNzk3YTY3-ZWQ3ODA2ZjYwNTI0MTFlZWE5ZDdmZTFhNTA5YTRmYTk=-1-bWlkZGxl-bWlkZGxlLTZmNGRkN2JmNmMtcWJ4cm0=-L0dFVC9zZXJ2aWNl-aHR0cDovL2JhY2tlbmQv"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"sw8-correlation"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"user-agent"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Go-http-client/1.1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"x-httpbin-trace-host"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bff-766967f8db-jwn2g/middle-6f4dd7bf6c-qbxrm/backend-6b9549bc64-8twnx"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"x-httpbin-trace-service"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bff/middle/backend"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"x-request-id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e5a1b250-ebe3-931d-91d7-90e3ee2fc867"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"method"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GET"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"origin"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"url"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"envs"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"NODE_NAME"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"higress-worker2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"PATH"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"POD_IP"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.244.1.7"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"POD_NAME"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"backend-6b9549bc64-8twnx"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"POD_NAMESPACE"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"app-system"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"SERVICE_ACCOUNT"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"backend"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"SERVICE_NAME"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"backend"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"VERSION"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"host_name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"backend-6b9549bc64-8twnx"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"body"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>响应头中和调用链路跟踪相关有如下：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"sw8"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1-MzYzMzM1NDctNTc0YS00MzZlLTgzNWEtNTY1YTQyNzk3YTY3-ZWQ3ODA2ZjYwNTI0MTFlZWE5ZDdmZTFhNTA5YTRmYTk=-1-bWlkZGxl-bWlkZGxlLTZmNGRkN2JmNmMtcWJ4cm0=-L0dFVC9zZXJ2aWNl-aHR0cDovL2JhY2tlbmQv"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">"x-httpbin-trace-host"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bff-766967f8db-jwn2g/middle-6f4dd7bf6c-qbxrm/backend-6b9549bc64-8twnx"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">"x-httpbin-trace-service"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bff/middle/backend"</span><span class="token plain">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中：</p><ul><li>sw8:  Skywalking 用于跟踪的 Http Header</li><li>x-httpbin-trace-host: 调用链路经过 POD_NAME</li><li>x-httpbin-trace-service: 调用链路经过 SERVICE_NAME</li></ul><p>在 Skywalking dashboard 中查看如下：</p><ul><li>服务截图</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress4-1-240819472e8b9f06168eaa65df92e264.png" width="2808" height="1422" class="img_ev3q"></p><ul><li>调用链路截图</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress4-a208c269e0dbade2c394ae0cce089e17.png" width="2876" height="1492" class="img_ev3q"></p><ul><li>调用链路拓扑截图</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress5-76307325468b090967c1bfaecf84af64.png" width="2800" height="1424" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="八higress-gateway-指标和监控面板">八、Higress gateway 指标和监控面板<a href="#八higress-gateway-指标和监控面板" class="hash-link" aria-label="八、Higress gateway 指标和监控面板的直接链接" title="八、Higress gateway 指标和监控面板的直接链接">​</a></h2><p>可以通过度量各个组件的性能指标，例如响应时间、吞吐量、错误率、资源使用率等指标来了解系统的状态和性能。</p><p>指标数据包含指标名称，指标标签，和指标值，下面是 envoy_cluster_upstream_cx_total upstream（总连接数）部分指标数据，</p><p>其中 envoy_cluster_upstream_cx_total 是指标名称，cluster_name 是指标标签，16 是指标值。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_cx_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">envoy_cluster_upstream_cx_total</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cluster_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"outbound|80||bff.app-system.svc.cluster.local"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Higress 指标数据大体可以分为三类:</p><ul><li>Downstream 下游: 指标与外来的连接/请求有关，主要由侦听器，HTTP连接管理器等</li><li>UpStream 上游: 指标与外向的连接/请求有关，主要由连接池，路由器，过滤器，熔断等</li><li>Server 负载: 指标信息记录 Higress gateway 服务器实例的负载等</li></ul><p>Higress 指标数据类型主要有三类:</p><ul><li>Counter: 无符号整数，只会增加而不会减少。例如，总请求</li><li>Gauge: 增加和减少的无符号整数。例如，当前活动的请求</li><li>Histogram: 作为指标流的一部分的无符号整数，然后由收集器聚合以最终产生汇总的百分位值(percentile，即平常说的 P99/P50/Pxx)。例如，Upstream 响应时间</li></ul><p>通过以下命令可以获取 Higress gateway 支持的指标和类型</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HIGRESS_GATEWAY_POD</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pods -l </span><span class="token variable assign-left variable" style="color:#36acaa">app</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">higress-gateway -o </span><span class="token variable string" style="color:#e3116c">'jsonpath={.items[0].metadata.name}'</span><span class="token variable" style="color:#36acaa"> -n higress-system</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$HIGRESS_GATEWAY_POD</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">  -n higress-system  -- </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -sS http://127.0.0.1:15020/stats/prometheus </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"# TYPE"</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>部分指标内容如下：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_cx_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_cx_tx_bytes_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_flow_control_backed_up_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_flow_control_drained_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_flow_control_paused_reading_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_flow_control_resumed_reading_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_internal_redirect_failed_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_internal_redirect_succeeded_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_101 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_200 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_201 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_301 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_302 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_304 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_401 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_404 counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_cancelled counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_completed counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_maintenance_mode counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_max_duration_reached counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_pending_failure_eject counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_pending_overflow counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_pending_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_per_try_idle_timeout counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_per_try_timeout counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_retry counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_retry_backoff_exponential counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_retry_backoff_ratelimited counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_retry_limit_exceeded counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_retry_overflow counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_retry_success counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_rx_reset counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_timeout counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_cluster_upstream_rq_tx_reset counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_cx_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_cx_tx_bytes_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_cx_upgrades_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_flow_control_paused_reading_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_flow_control_resumed_reading_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_completed counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_failed_path_normalization counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_header_timeout counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_http1_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_http2_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_http3_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_idle_timeout counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_max_duration_reached counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_non_relative_path counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_overload_close counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_redirected_with_normalized_path counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_rejected_via_ip_detection counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_response_before_rq_complete counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_rx_reset counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_timeout counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_too_large counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_total counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_tx_reset counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TYPE envoy_http_downstream_rq_ws_on_non_ws_route counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>具体指标定义参考如下：</p><ul><li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats" target="_blank" rel="noopener noreferrer">cluster manager</a></li><li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats" target="_blank" rel="noopener noreferrer">http connection manager</a></li><li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/stats" target="_blank" rel="noopener noreferrer">listeners</a></li><li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/statistics" target="_blank" rel="noopener noreferrer">server</a></li></ul><p>如何查看 Higress 指标数据：</p><ul><li>通过 <a href="http://console.higress.io:8080/dashboard" target="_blank" rel="noopener noreferrer">http://console.higress.io:8080/dashboard</a> 查看 Higress gateway 监控面板</li><li>通过 Skywalking Dashboard 查看 Higress gateway 监控数据</li></ul><p>通过 Skywalking Dashboard 查看 Higress gateway 监控数据部分截图如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress14-274da38a0b0af5a8fa09d20ab5a7bbb5.png" width="2176" height="854" class="img_ev3q">
<img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress15-63b1535591a4393a1b9a030856749790.png" width="2176" height="904" class="img_ev3q">
<img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress16-8236b7f058860b440ab64c2ec997f6d5.png" width="2170" height="1092" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文档">参考文档<a href="#参考文档" class="hash-link" aria-label="参考文档的直接链接" title="参考文档的直接链接">​</a></h2><ul><li><a href="https://istio.io/latest/docs/tasks/observability/distributed-tracing/skywalking/" target="_blank" rel="noopener noreferrer">https://istio.io/latest/docs/tasks/observability/distributed-tracing/skywalking/</a></li><li><a href="http://peter.bourgon.org/blog/2017/02/21/metrics-tracing-and-logging.html" target="_blank" rel="noopener noreferrer">http://peter.bourgon.org/blog/2017/02/21/metrics-tracing-and-logging.html</a></li><li><a href="https://skywalking.apache.org/docs/main/next/en/api/x-process-propagation-headers-v3/" target="_blank" rel="noopener noreferrer">https://skywalking.apache.org/docs/main/next/en/api/x-process-propagation-headers-v3/</a></li><li><a href="https://skywalking.apache.org/docs/main/next/en/api/trace-data-protocol-v3/" target="_blank" rel="noopener noreferrer">https://skywalking.apache.org/docs/main/next/en/api/trace-data-protocol-v3/</a></li></ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress 开源之夏项目报名]]></title>
            <link>https://higress.io/zh-cn/blog/ospp-2023</link>
            <guid>https://higress.io/zh-cn/blog/ospp-2023</guid>
            <pubDate>Tue, 09 May 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Higress 是基于阿里内部两年多的实践沉淀，以开源 Istio 与 Envoy 为核心构建的下一代云原生网关]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="开源之夏介绍">开源之夏介绍<a href="#开源之夏介绍" class="hash-link" aria-label="开源之夏介绍的直接链接" title="开源之夏介绍的直接链接">​</a></h2><p>开源之夏是由中科院软件所“开源软件供应链点亮计划”发起并长期支持的一项暑期开源活动，旨在鼓励在校学生积极参与开源软件的开发维护，培养和发掘更多优秀的开发者，促进优秀开源软件社区的蓬勃发展，助力开源软件供应链建设。</p><p>目前<a href="https://summer-ospp.ac.cn" target="_blank" rel="noopener noreferrer">开源之夏官网</a>已经开启了学生报名，只要你满足以下要求即可进行项目申请：</p><ul><li>本活动面向年满 18 周岁在校学生。</li><li>暑期即将毕业的学生，只要在申请时学生证处在有效期内，就可以提交申请。</li><li>中国籍学生参与活动需提供身份证、学生证、教育部学籍在线验证报告（学信网）或在读证明。</li><li>外籍学生参与活动需提供护照，同时提供录取通知书、学生卡、在读证明等文件用于证明学生身份。</li></ul><p>参与项目不仅可以为开源世界做出自己的贡献，还能获得丰厚的结项奖金（基础难度8000 RMB/进阶难度12000 RMB），项目经验也会成为你毕业简历上的亮点，快来报名吧！</p><p>报名截止时间为 6 月 3 日 15 点，具体参考官网活动流程和参与指南介绍：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01gxAj9N27FL4twpxbV_!!6000000007767-0-tps-2768-1114.jpg" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-介绍">Higress 介绍<a href="#higress-介绍" class="hash-link" aria-label="Higress 介绍的直接链接" title="Higress 介绍的直接链接">​</a></h2><p>Higress 是基于阿里内部两年多的实践沉淀，以开源 Istio 与 Envoy 为核心构建的下一代云原生网关。Higress 实现了安全防护网关、流量网关、微服务网关三层网关合一，可以显著降低网关的部署和运维成本。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01iO9ph825juHbOIg75_!!6000000007563-2-tps-2483-2024.png" class="img_ev3q"></p><p>Higress 在阿里内部的诞生和演进历程可以看这篇文章:</p><p><a href="https://mp.weixin.qq.com/s/dgvd9TslzhX1ZuUNIH2ZXg" target="_blank" rel="noopener noreferrer">阿里巴巴重磅开源云原生网关: Higress</a></p><p>Higress 开源半年时间，GitHub star 数已经破千，在上个月 Higress 已经 Release 出了第一个 RC 版本，作为正式 GA 的候选发布版本，详情可以查看这篇文章:</p><p><a href="https://mp.weixin.qq.com/s/ogy-xXXLEgzw6otaIAT6Dw" target="_blank" rel="noopener noreferrer">上线控制台，降低使用门槛｜Higress 1.0.0 RC 版本发布</a></p><p>在本次开源之夏活动中，Higress 有两个进阶难度的项目可以申请，欢迎各位同学踊跃报名。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="项目介绍">项目介绍<a href="#项目介绍" class="hash-link" aria-label="项目介绍的直接链接" title="项目介绍的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="项目一higress-wasm-插件构建调试部署的命令行实现">项目一：Higress Wasm 插件构建/调试/部署的命令行实现<a href="#项目一higress-wasm-插件构建调试部署的命令行实现" class="hash-link" aria-label="项目一：Higress Wasm 插件构建/调试/部署的命令行实现的直接链接" title="项目一：Higress Wasm 插件构建/调试/部署的命令行实现的直接链接">​</a></h3><p>Higress 提供了很方便的 Wasm 插件扩展框架，具体可以查看这篇文章： <a href="https://higress.io/zh-cn/blog/30-line-wasm" target="_blank" rel="noopener noreferrer">30行代码写一个Wasm Go插件</a></p><p>更详细的插件开发和调试流程可以查看这篇文章：<a href="https://higress.io/zh-cn/docs/user/wasm-go" target="_blank" rel="noopener noreferrer">使用 Go 语言开发 WASM 插件</a></p><p>这里对插件的生效机制简单做个说明：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01PO4HYC1h7qYHonHHZ_!!6000000004231-2-tps-1100-537.png" class="img_ev3q"></p><ol><li>用户将代码编译成 wasm 文件</li><li>用户将 wasm 文件构建成 oci 镜像</li><li>用户将 oci 镜像推送至镜像仓库</li><li>用户创建 WasmPlugin 资源</li><li>Istio watch 到 WasmPlugin 资源的变化</li><li>Higress Gateway 中的 xDS proxy 进程从 Istio 获取到配置，发现插件的镜像地址</li><li>xDS proxy 从镜像仓库拉取镜像</li><li>xDS proxy 从镜像中提取出 wasm 文件</li><li>Higress Gateway 中的 envoy 进程从 xDS proxy 获取到配置，发现 wasm 文件的本地路径</li><li>envoy 从本地文件中加载 wasm 文件</li></ol><p>这里 envoy 获取配置并加载 wasm 文件使用到了 ECDS (Extension Config Discovery Service)的机制，实现了 wasm 文件更新，直接热加载，不会导致任何连接中断，业务流量完全无损。</p><p>这个项目的初衷是希望能基于 Higress 的 CLI 命令行工具(hgctl) 来进一步简化 Higress Wasm 插件的开发调试和安装部署步骤，使之更容易上手使用。</p><p>需要实现的 hgctl 命令如下：</p><ul><li>hgctl plugin build：构建 wasm OCI 镜像并推送到指定仓库</li><li>hgctl plugin test：启动 docker compose 测试插件功能</li><li>hgctl plugin install/uninstall ：在当前higress集群中安装或卸载插件</li><li>hgctl plugin config：修改制定插件的配置</li></ul><p>Higress Wasm 插件配置基于 Openapi Specification （OAS 3.0）进行约束，需要能从代码中解析出插件配置字段格式，自动生成对应的 OAS 约束，用于添加到 OCI 镜像中，并同时用于 install/uninstall/config 等命令的参数配置校验</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="项目二基于-wasm-实现-oidc-认证插件">项目二：基于 Wasm 实现 OIDC 认证插件<a href="#项目二基于-wasm-实现-oidc-认证插件" class="hash-link" aria-label="项目二：基于 Wasm 实现 OIDC 认证插件的直接链接" title="项目二：基于 Wasm 实现 OIDC 认证插件的直接链接">​</a></h3><p>Higress 作为一个云原生网关，需要实现 OIDC 认证的能力，方便用户对接外部认证服务。</p><p>OIDC （OpenID Connect） 是基于 OAuth 2.0 的身份认证协议，可以用于实现 SSO（Single Sign On）单点登录，即通过网关统一完成用户的身份认证，在身份认证成功后，再将资源请求转发给后端服务。</p><p><img loading="lazy" src="https://summer-resource.obs.cn-north-4.myhuaweicloud.com/image_1682322347641.png?AccessKeyId=PVWAQ81YUWFDVEUNOSXR&amp;Expires=1768722347&amp;Signature=uaKg4CAupPRGPdz%2BtRT1qcc5SeI%3D" class="img_ev3q"></p><p>流程简介如下：</p><ol><li>客户端向网关发起认证请求。</li><li>网关将认证请求直接转发到给认证服务。</li><li>认证服务读取请求中的验证信息（例如用户名、密码）进行验证，验证通过后返回Code给网关。</li><li>网关将携带Code的应答返回给客户端。</li><li>客户端向网关请求回调接口，请求中携带Code。</li><li>网关请求认证服务颁发Token，请求中携带Code、Client ID、Client Secret。</li><li>认证服务验证合法性，并返回ID Token。</li><li>认证成功，网关将携带ID Token的应答返回给客户端。</li><li>客户端向网关发起业务请求，请求中携带ID Token，网关校验请求中是否携带ID Token和合法性。</li><li>网关校验客户端的业务请求合法，将请求透传给业务服务。</li><li>业务服务进行业务处理后应答。</li><li>网关将业务应答返回给客户端。</li></ol><p>目前 Higress 也可以基于 Envoy 的 Ext Authz 机制对接外置的 oauth2-proxy 来实现鉴权，不过这个方案一方面有额外的请求开销，另一方面 oauth2-proxy 只能作一组 OIDC 配置，无法对接多个不同的认证服务</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入社区">加入社区<a href="#加入社区" class="hash-link" aria-label="加入社区的直接链接" title="加入社区的直接链接">​</a></h2><p>GitHub：<a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress</a></p><p>官网: <a href="https://higress.io" target="_blank" rel="noopener noreferrer">https://higress.io</a></p><p>对于报名方式有任何疑问，或者对某一个任务非常感兴趣，并且想要深入了解的同学，欢迎扫码添加微信，备注开源之夏</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01bkpHik1yZBhbnhyTf_!!6000000006592-2-tps-500-500.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="相关项目推荐">相关项目推荐<a href="#相关项目推荐" class="hash-link" aria-label="相关项目推荐的直接链接" title="相关项目推荐的直接链接">​</a></h2><ul><li>对于<strong>微服务注册发现和配置管理</strong>有兴趣的同学，可以尝试填报 <a href="https://nacos.io/zh-cn/blog/iscas2023.html" target="_blank" rel="noopener noreferrer">Nacos</a> 开源之夏；</li><li>对于<strong>微服务分布式事务</strong>有兴趣的同学，可以尝试填报 <a href="https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh" target="_blank" rel="noopener noreferrer">Seata</a> 开源之夏；</li><li>对于<strong>微服务框架和RPC框架</strong>有兴趣的同学，可以尝试填报 <a href="https://summer-ospp.ac.cn/org/orgdetail/41d68399-ed48-4d6d-9d4d-3ff4128dc132?lang=zh" target="_blank" rel="noopener noreferrer">Spring Cloud Alibaba</a> 和 <a href="https://summer-ospp.ac.cn/org/orgdetail/a7f6e2ad-4acc-47f8-9471-4e54b9a166a6?lang=zh" target="_blank" rel="noopener noreferrer">Dubbo</a> 开源之夏；</li><li>对于<strong>分布式高可用防护</strong>有兴趣的同学，可以尝试填报 <a href="https://summer-ospp.ac.cn/org/orgdetail/5e879522-bd90-4a8b-bf8b-b11aea48626b?lang=zh" target="_blank" rel="noopener noreferrer">Sentinel</a> 开源之夏；</li><li>对于<strong>微服务治理</strong>有兴趣的同学，可以尝试填报 <a href="https://summer-ospp.ac.cn/org/orgdetail/aaff4eec-11b1-4375-997d-5eea8f51762b?lang=zh" target="_blank" rel="noopener noreferrer">OpenSergo</a> 开源之夏。</li></ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[上线控制台，降低使用门槛 ｜ Higress 1.0.0 RC 版本发布]]></title>
            <link>https://higress.io/zh-cn/blog/release-100</link>
            <guid>https://higress.io/zh-cn/blog/release-100</guid>
            <pubDate>Mon, 10 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[历时 5 个多月，Higress 云原生网关开源的第一个重要里程碑达成了]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>历时 5 个多月，Higress 推出了首个 RC （Release Candidate，即正式发布的候选）版本 1.0.0-rc，用户可以通过控制台，开箱即用地使用云原生网关。</p><p>选用 Higress 作为云原生网关的核心优势如下：</p><ul><li><p><strong>易用性</strong></p><p>“云原生”已经不再是一个新鲜词，但企业对云原生技术的学习使用成本仍有许多顾虑，对云原生新标准的追赶又有很多焦虑；</p><p>Higress 同时提供了本地安装/生产部署的 <a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">quickstart</a>，可以一键部署，并通过控制台操作快速上手；基于简单易用的控制台，Higress 可以封装 Ingress/Gateway API 的标准细节，根治技术追赶焦虑。</p></li><li><p><strong>标准化</strong></p><p>K8s 带来了云原生的路由标准 Ingress/Gateway API，如同 POSIX 定义 Unix 可移植操作系统标准，历时 35 年经久不衰，云原生的路由标准的生命周期一定会远超过 K8s 本身；</p><p>Higress 结合阿里内部实践以及阿里云产品沉淀，积累了基于 Ingress API 的丰富的路由策略扩展能力，同时还兼容大部分 Nginx Ingress 能力，这些能力后续也将在 Gateway API 上支持。</p></li><li><p><strong>高集成</strong></p><p>企业内有大量传统架构部署的服务，会成为向云原生架构演进的技术负担，要求云原生网关具备对接异构服务架构的能力；</p><p>基于 Higress 提供的多种服务发现机制，网关路由不仅可以转发到 K8s 服务，也可以直接配置 IP 转发到到物理机上的服务；基于 Nacos/ZooKeeper 等注册中心对接，还可以轻松实现 <a href="https://higress.io/zh-cn/docs/user/spring-cloud" target="_blank" rel="noopener noreferrer">Spring Cloud</a> 和 <a href="https://higress.io/zh-cn/docs/user/dubbo" target="_blank" rel="noopener noreferrer">Dubbo</a> 微服务的路由，无论其是否部署在 K8s 内。</p></li><li><p><strong>易扩展</strong></p><p>基于扩展机制进行二次开发的能力，是云原生网关在不同业务场景下都能适配落地的关键；</p><p>Higress提供了灵活的插件扩展机制，目前插件市场已经推出多个官方插件，并支持用户通过控制台直接上传自己开发的插件，同时开源社区的插件市场生态也在不断建设中。</p></li><li><p><strong>热更新</strong></p><p>传统 Nginx 更新规则需要 reload 会导致链接抖动，导致流量损失，对实时通信、视频、IOT无法容忍；</p><p>对于路由规则，Wasm 插件逻辑更新，以及证书改动等等，Higress 全部支持热更新，不会造成任何连接抖动。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="企业落地支持">企业落地支持<a href="#企业落地支持" class="hash-link" aria-label="企业落地支持的直接链接" title="企业落地支持的直接链接">​</a></h3><p>在 RC 版本阶段使用 Higress 的企业用户，社区会在落地阶段提供更多帮助，我们建立了 Higress 企业落地群，可以联系我(微信:nomadao 钉钉:chengtanzty)，会将你加进群，群里有社区核心研发同学，可以提供更及时的响应和帮助。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="安装升级方式">安装升级方式<a href="#安装升级方式" class="hash-link" aria-label="安装升级方式的直接链接" title="安装升级方式的直接链接">​</a></h3><p>安装 RC 版本，需要 helm <a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">安装</a>或<a href="https://higress.io/zh-cn/docs/ops/upgrade" target="_blank" rel="noopener noreferrer">升级</a>时需要指定<code>--devel</code>参数，例如：<code>helm upgrade higress -n higress-system --devel</code></p><p>1.0.0 RC 版本已经在社区小伙伴的协作下完成了多轮测试和修复工作，欢迎大家使用。最终的正式版本，也将在近期很快推出。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="控制台功能速览">控制台功能速览<a href="#控制台功能速览" class="hash-link" aria-label="控制台功能速览的直接链接" title="控制台功能速览的直接链接">​</a></h2><ul><li><p><strong>丰富的可观测</strong></p><p>提供开箱即用的可观测，Grafana&amp;Prometheus 可以使用内置的也可对接自建的，具体可以参考<a href="https://higress.io/zh-cn/docs/user/prometheus" target="_blank" rel="noopener noreferrer">文档</a></p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN016n7gBU1UCnrfOBOZC_!!6000000002482-1-tps-1778-1012.gif" class="img_ev3q">
</p></li></ul><ul><li><p><strong>插件扩展机制</strong></p><p>官方提供了多种插件，用户也可以<a href="https://higress.io/zh-cn/docs/user/wasm-go" target="_blank" rel="noopener noreferrer">开发</a>自己的插件，构建成 docker/oci <a href="https://higress.io/zh-cn/docs/plugins/custom" target="_blank" rel="noopener noreferrer">镜像</a>后在控制台配置，可以实时变更插件逻辑，对流量完全无损。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01t7XqQB1s6R8cM5ZRS_!!6000000005717-1-tps-1778-1012.gif" class="img_ev3q"></p></li></ul><ul><li><p><strong>多种服务发现</strong></p><p>默认提供 K8s Service 服务发现，通过配置可以对接 Nacos/ZooKeeper 等注册中心实现服务发现，也可以基于静态 IP 或者 DNS 来发现</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN0142CxRS1of0ZKg5soq_!!6000000005251-1-tps-1778-1012.gif" class="img_ev3q">
</p></li></ul><ul><li><p><strong>域名和证书</strong></p><p>可以创建管理 TLS 证书，并配置域名的 HTTP/HTTPS 行为，域名策略里支持对特定域名生效插件</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01eQhgZD1ggMonjdj9u_!!6000000004171-1-tps-1778-1012.gif" class="img_ev3q"></p></li></ul><ul><li><p><strong>丰富的路由能力</strong></p><p>基于上面配置的服务发现机制，发现的服务会出现在服务列表中；创建路由时，选择域名，定义路由匹配机制，再选择目标服务进行路由；路由策略里支持对特定路由生效插件</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01lExhus1IvR4Q8kGmY_!!6000000000955-1-tps-1778-1012.gif" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="进阶使用">进阶使用<a href="#进阶使用" class="hash-link" aria-label="进阶使用的直接链接" title="进阶使用的直接链接">​</a></h3><p>Higress 控制台的功能还在不断丰富和演进中，当前还有很多 Higress Ingress 注解的能力没有支持，如果有这部分深度使用的需求，可以参考<a href="https://higress.io/zh-cn/docs/user/annotation-use-case" target="_blank" rel="noopener noreferrer">这篇文档</a>进行进阶配置</p><p>如果希望使用 Istio 的能力进行流量治理，可以参考<a href="https://higress.io/zh-cn/docs/ops/deploy-by-helm" target="_blank" rel="noopener noreferrer">这篇文档</a>的支持 Istio CRD 一节。基于 Istio 的 <a href="https://istio.io/latest/docs/reference/config/networking/envoy-filter/" target="_blank" rel="noopener noreferrer">EnvoyFilter API</a> 可以实现更多细粒度的管控能力。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="社区">社区<a href="#社区" class="hash-link" aria-label="社区的直接链接" title="社区的直接链接">​</a></h2><p>欢迎认领 Higress Issue 任务：<a href="https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22help+wanted%22" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22help+wanted%22</a></p><p>完成一定数量的 Issues 就可以成为 Higress Committer，也有机会获得开源社区的礼物和荣誉🏆</p><p>欢迎加入 Higress 社区群，及时了解更多 Higress 动向：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN0171Hg8d1XMMz4eFo3b_!!6000000002909-0-tps-720-405.jpg" class="img_ev3q"></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[UU跑腿基于Higress的云原生网关实践]]></title>
            <link>https://higress.io/zh-cn/blog/user-uu</link>
            <guid>https://higress.io/zh-cn/blog/user-uu</guid>
            <pubDate>Thu, 30 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[介绍UU跑腿的云原生网关探索之路]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="uu跑腿介绍">UU跑腿介绍<a href="#uu跑腿介绍" class="hash-link" aria-label="UU跑腿介绍的直接链接" title="UU跑腿介绍的直接链接">​</a></h2><p>UU跑腿隶属于郑州时空隧道信息技术有限公司，是更专业的同城即时生活服务平台，以共享劳动力与时间为众包理念，人人都可注册成为跑腿师傅，并为附近的人提供帮取送、帮买、全能帮、帮排队等多样化同城即时服务，为中小企业、电商、本地商户提供安全专业的高端配送服务。UU跑腿秉承“让生活更美好”的理念，不断创新、不断进步，为用户提供更加优质的服务体验。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景需求">背景需求<a href="#背景需求" class="hash-link" aria-label="背景需求的直接链接" title="背景需求的直接链接">​</a></h2><p>UU跑腿对于云原生网关的要求是，能同时满足流量网关，微服务网关，以及安全网关的场景诉求，用一个网关来解决之前需要部署多个网关才能解决的问题：</p><ol><li>具备高可靠性和高性能，可以替代之前部署的 <strong>Nginx Ingress 流量网关</strong></li><li>同时支持 K8s 生态和传统微服务生态接入，支持（HTTP转Dubbo）协议转换，可以替代之前部署的 <strong>Spring Cloud Gateway 微服务网关</strong></li><li>能够支持在网关入口处完成鉴权，避免每个后端服务重复实现鉴权功能，实现<strong>安全网关</strong>的能力</li><li>具备易用的控制台进行 API 的治理，以及具备丰富的可观测指标</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="迁移-higress-前的架构">迁移 Higress 前的架构<a href="#迁移-higress-前的架构" class="hash-link" aria-label="迁移 Higress 前的架构的直接链接" title="迁移 Higress 前的架构的直接链接">​</a></h2><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN016p6RZz21KwDVA9Gz5_!!6000000006967-2-tps-1014-431.png" alt="old-arch" class="img_ev3q"></p><p>之前存在的主要痛点：</p><ol><li>Spring Cloud Gateway 自身参数调整改动需要重新部署影响流量，且动态路由需要进行复杂的配置，包括路由规则，容易出现配置错误导致系统异常</li><li>运维需要同时维护 Nginx Ingress 和 Spring Cloud Gateway，面对流量高峰进行进行扩容相关操作时，运维负担比较重，而且这样两层网关的请求的链路较长，可用性低、成本高</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="迁移-higress-后的架构">迁移 Higress 后的架构<a href="#迁移-higress-后的架构" class="hash-link" aria-label="迁移 Higress 后的架构的直接链接" title="迁移 Higress 后的架构的直接链接">​</a></h2><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01tCWvwN22sCbD7DmqA_!!6000000007175-2-tps-1014-420.png" alt="new-arch" class="img_ev3q"></p><p>Higress云原生网关实现负载均衡、路由、安全认证等功能。通过网关对外提供服务统一入口，并对请求进行鉴权、限流和监控等操作，用简单的架构保证了整体系统的稳定性和可靠性。</p><ol><li>合并流量网关（K8s Nginx Ingress）和微服务网关（Spring Cloud Gateway ），降低网关成本，高性能服务；</li><li>同时支持 K8s service 和 Nacos 服务注册发现，满足技术需求对 K8s 生态和传统微服务生态接入。</li><li>Nginx Ingress 完美迁移到 Higress，十分丝滑</li></ol>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress 0.7.0 版本发布：GA 进入倒计时]]></title>
            <link>https://higress.io/zh-cn/blog/release-070</link>
            <guid>https://higress.io/zh-cn/blog/release-070</guid>
            <pubDate>Mon, 20 Mar 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Higress 0.7.0 版本介绍]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="进展概要">进展概要<a href="#进展概要" class="hash-link" aria-label="进展概要的直接链接" title="进展概要的直接链接">​</a></h2><ol><li>Higress 控制台正式 release，涵盖 Higress 的服务/路由/域名/证书管理能力，并提供开箱即用的可观测功能</li><li>安装/升级 Higress 时支持自动安装对应版本的 Higress Console，避免版本不适配的问题</li><li>支持开启 Istio API，实现更多复杂的功能，并且也可以用于平滑替换 Istio Ingress Gateway</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="版本特性">版本特性<a href="#版本特性" class="hash-link" aria-label="版本特性的直接链接" title="版本特性的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-控制台">Higress 控制台<a href="#higress-控制台" class="hash-link" aria-label="Higress 控制台的直接链接" title="Higress 控制台的直接链接">​</a></h3><p>现在通过 helm 命令安装 Higress 时将自动安装对应版本的 Higress Console, 这里通过 <code>higress-console.domain</code> 参数，可以指定控制台的域名。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 已经添加过 repo 的，请执行 helm repo update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> higress.io https://higress.io/helm-charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> higress -n higress-system higress.io/higress --create-namespace --render-subchart-notes --set higress-console.domain</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">console.higress.io</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image" src="/zh-cn/assets/images/console-credentials-3f846851a9dfeed79cf5e782173eb20a.png" width="1240" height="250" class="img_ev3q"></p><p>注意：安装完成后会输出一段文本，其中包含获取控制台登录信息的命令。请执行该命令并记录用户名和密码。</p><p><img loading="lazy" alt="image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAFeCAMAAABEjx0wAAAABGdBTUEAALGPC/xhBQAAAwBQTFRF0tTyFs78b5+fn9fvt29vb7fg8Pf3n59vJydvb5+3J5+36dX/kr3/xc3VerL/Jm3+O2n/gJ//YXL/QYn+P3r/1eHVsMr/zcW/H37+159vGzH/RaD/z9P/1+/v7+/h1tja9PT1zb/N1cXFyZ8nuL7/r7X/JZD+RqD+//f3xbvfkqv/F4nv8PP+fcD98ODtFrn5rL//wsnVe37fK3z+El7+d6H/FUT/JFX/PJn+e979xdHhj5OZX2VtbIX/rK3/Tk5OXaz+QkJCd3d3QUFB0eT0orj+YJ3/3uX//+zyyen/oKCgfOL/nydv//j9DUD/Fm/+hLD/4dnN2dLgFbb3uNP/gIOKxb/Fio2T0Ob/FX7wSlz/YmZvQkhSoKf/3N3f5fD/GNX+EVL/FX7tqqyxgoWMfY//zb/FkJ3/b2+39/j/BB3/nycnFYL4Jyef2tX/FYv/t+//F4nfeoT+xsD+MJz/XGBpo6arDDX/2tvdtsL/V1xlvN3+pqmun6KnZ2t0P53+1NTUvL7C+vv/+fz/3d7gqO3/19nbLZj+aWlp9/f38OP/UldgsLCwsbO3LU//bycn5ufolJSUTFJc6+zthYWFra2tT09Pl5qfysvOByr//+3/0NLUByX/7/Dwqamp///XxsbGb3N7qI//xfj/GJD34eLjh8L+am93GMD/2f//5OTlw8XIRkxWxb+/zKv/uru8b7fv158nvcP/1Nj//++3J5/X77dvr+r/XV1dPUNOt7e3wMDFg4eN4c2//+r/8P//YJD/jIyMOkBLNjxHen6F/Pz81tbXt28noqKizP//mp2iGJ3/+vr6xb/N1e//zc7OYL3/GKv/8/Pz6f//zb+/kpD/r53/XFxcHoz+/v7+J2+3/9efv83hMzMzk5OT+Pj46erq6b3/NDpFn9f/BBj//9X/xdXvv7/N///hkpKSktX/1cW/8fHyzeH/3t7e/+/V/+HNv8XV79XF///v4f//FX7fJiYm7///yMnJJycnMzlEv7+/9PT02dnZGJD/////t6OdDwAADKFJREFUeNrt3QlUFdcBgOF03/d939vsS7Pve6NJs5mk2Rej1qYxJsa41KrRVhrXuAsGJRikihCBRFEQg/AEwaQB06ABhceixOWpBOLjOSTc3ntn3kaqx0bSw9z5/3OUefPgHA7fu3fuDIc3JwhydzX/+5ecwE/Ne4EOOoFOoBPoBDqBTqAT6AQ6gU6gE+gEOoFOoBPoBDroBDqBTqAT6AQ6gU6gE+gEOoFOoBPoBDp5EX3RqL/oj3//za//KcQjv3qpBmPj0f+80EF/+i2Jfv/Onb/E2GPog3fuvAxjj6GfOvj+RzD2GDp5Av37CwdfcPbZ37z2uh8o9EdeflmN9NJJ6yZOem3FA4uFaHigoWFiaK7cl56ZnTxXf03ppIkDkuzNWZkDMlfUgO6uvr7wvC/ffPM5/c+79hmJ/tLOnS/Ld1pb1mRZTXPGNG0WYmPTnBLLulMItc8qWae+ZqPeTJZb43xyy5cIurs6d+Gor95yy4b+N406N4I+0LLGb14iZRW6ZeUvK5lUs9FqWpI4zfKVCRFq8hWOG2PlzxLiPuuSkcssKxN0V/X0pTfd1P8r37jl/FHP7nfQ38i3Li4VpeOabPT80WKxmFViXSzEeyOsQiE2W1kBsXjMmGyx2GqaJUoHjkkE3VW9dcHXzu9/zs3f/faoRS856DOsLP3UNBt9idrOtKyNhYWF461pQiT5rDmJSXPVkTzLyi9cN6uU6d1l6G/9VTx4++233/XsokEO+p3WCP3UMhu9UG2PtZxK1JFcbw2U6kklamvaYtBdh67627OLnnTQE9Vwlt0bgz7Dyv+HbrR61JA8coRljZNbb5TNkAf/JaC7HT3ZKpmkzsbyY9BH+6wk+SF580hRMyBxRo0oHSGpsxPHyp0DLB/obkeXB/P8zPSkLCsG/adzrDmV6Zkl6tFGyzcyeZ3PGigmNll3VCbda80B3fXooSZ90PbFoIsGn71PHr5Ls/Rm00/UYV83A3RXdcUVd9nol95zvxA/vOee6+SDdHklZvzoSxT6uGVj7U9Mv1OesW/WS7a5Y/Mt38AVcmvKxCyr6d7KGtBd33tviBrpOMIaG7e7tDSCWxO7af4PxAvoWT51tdV/n5UsyCvoS+RVuCmB8c41GvIEevp9li+/xPz1GeixrbgjqyR/fCbaXkIn0EHnRwA6gU6gE+gEOoFOoBPoBDqBTqAT6AQ6gU6gE+gEOugEOoFOoB81/4H36bg78Jqr0A8EGE/HX+CAq9DfR6wX/xhBBx100EEHHXTQQQcddNAJdAKdQCcT0UMLgsEFIRi9hJ4dnJydPTmYffSv2v3m/tiHreteB9296IG6eerDvLpA1Lcz2jsdzt62WOaDL7Yw0l2MHgpq7UAwFD+oWzV3m/y/fV/Mi6DFNg8/9O6AdzX69UH7Y/D6I6NHZvb2fS3afAcD3tXoZfYQDwXLjhW9rbOlVau3de5nenfnQu7yBfLt1FcsuFwc6ZjeDb317XfFj/e907H7TbkBujvRy+rq1q6tqysTxzy96w3n8A66K1fv84J127bVBecFjn0hpyaDHazeXYseWFA3X32cX7cgrL77j6/HocecotsjvS36GvDuDO9m9KvC83pZ3VWRk/D4Y7r9Ioi0vrOlLTzMD/4LdPehlwXnhzfnB1fYG616+EZH+gdlQXc1+p6ro9tX73GGsuaOordFrsqBbgT6tm0x25Od2V0fwh30HdEVO+jmnLIdQVSiqwXbfme2j/8UFnKG/z59/X7BSPcaOoFOoIMOOuiggw466KCDDjrooIPeg/FGQz2Ry95oiLcU8+BbilFvDnTQCXQCnUAn0Al0Ap1AJ9AJdAKdQCfQCXQCnUAn0EEn0Al0Ap1AJ9D5Ywfun04fKu6f7sX4q1XQQQcddNBBBx100EEHHXTQQQcddNA/7HcbCMm4Nusp9MlB3WQcj54/pcEY9Pl12WqkZ9fNj9u9+80WnG3syoKUlOkTAuX15qDvcW7ds21P/P628O1ZWvXNWi5ybsPouVvqVs6un56aWlBfHG9uGHrcvfj0DdKjN1tt/7nX7pdeUJzqF4GAv7w+PdVkdH0znoMX2bO8uvui3qP/2/0zj92op7J+gvCXFxfPrm9oKK40eHpv37ejbUefW99+V27YM736cPCsjvDN2rxTYLaETimwj+eVswNmoJetvVLeSFtVd+Va566rreteV8xymt/f3k/E3XC3zWP3Ui4oF6KhWM7tDXJDlBeYgR4K7okUDEXW7W1n7VNH8/Vf+o6kXq9vuqe8Y+6k7h10f3G5mtuNQtezmJ63HHR9d3R9e3R1D+31La1SXB7Qw3dd9BR7oL5S+NXxPKVTHd/9JqHbd1x10A++qMZ4+D7a8g6MlRo9/Hrw1livLB4t1+3lxdP9YoIxCzkbfd68GPRbu6/VWmPQD/7BY+dsBer8POAX/tTiTmEUeigUN73r1rfEod9qn7V/y2Po6vx8ekFq6vTZ8tzNHPRQpDC6vVzT6PqOyh4e6Wrd7p8wPSWloNIvDEKP6UjoMbfMbvPYvbM7G47xcoerLs6URUd6WeTiTGfc/dEjI12t7vg1jAHoR6/17Xfh9Ro6gU6ggw466KCDDjrooIMOOuigg97D8UZDPZHL3mjoNd5SjPunU28KdNAJdAKdQCfQCXQCnUAn0Al0Ap1AJ9AJdAKdQCfQQSfQCXQCnUAn0Al0Ap2MRPcf+H/8TRb1KvT4v1r9qP76knoV+vtHe5i7uttnr/qTelPo5x89LPvEpmaxvbYj/FC12pQfdvUaZ2NrhdjVZffqv51dW+yPev+rg/VzVYagbz8cqVm0b7JNbXT99GMZ8jNqF8e+M/h2Y9B3hYV3dVVEd4X5dXuFeOV3zmc17jUFvdbxbJcjOn6kr5rZvF2+EkRujtp0XhGGjPSVsbCSvrEqBl2/FE6W2hvWrJTO6jkNv3WNuejO4M9RzNfb249lGDfSV+494uCX2NV9vyBfDRWaWR0ENHp1hYnTe+wrQY7vXMe6fZN8nHc4ptoOo9C3Sl/RGBn21VXSt7przSsb+m5YIxrVwN+1xf5n4Eh3XgHNGv1Tm3Ii0B+f6XxanjHH8/iRLgexPcPruV1N/hX2VL/llQ3qyN4YOcIbOL3bR3NJqx/m5djP6Y/6M/PU4A/vNuSoXhWLrp/Z66zllfHKk7eIrQ72VlPQ46f3XD3H5+b8F3SR99kn5CQvZ/3aHxky2qOIsejdajQQPW6ky4Eudzz/+ycc9PDrwcZf9blPfubzm8w4TW/cog7RW6vkqq0iDl3O6XqXfqiUFfoXN+gpodpI9O89sWrm4WZ1seb5R5vDC/XIuj73cHPeavsJtycX6M66rPpMdfiurrhseFV4YH8QfW+3izkmTe9SvLZj1Ux13FajXTnXdrRvWu2Q5zhH+7gTOJdO7FXOYlwv1iRn15pG+0WwUg3+2GszjZEFnHylmHqerrjz1FlZbtxJ2i9y9IVYvdqbWWvCfZarowty++w87jJs5CAeHuny0z+qczZ+4eLB+NUq6AQ6gU6gE+gEOoFOoBPoBDqBTqAT6AQ6gU6gE+igE+gEOoFOoBPoBDqBTqAT6ORS9Aef6qLj7qkHXYWOec+ouwodr54JdNBBBx100EEHHXTQQQcddNBBBx100EEH3XXoh+S/YaB7A33pIdXdXRlDuw4lDA3vPeVQpMdBNw59eZH+xoYn9Lk747nThjh7b4h+y8+Bbt5Il85LE24cJPGHLr2t6IXuz98AuoEj/dNPLv2YkNYJfU65rWhq3KSvuhB0A9H71lxbdJLUfTjtVDG026TP9G7o6n3YDWJ4mvrepmb0G/LBp5neDUR/OO3G3zozudp8PH5yl9N7H7m0B90s9IyhD0W+u5ozi57rNrnbS3vQTbs489CNg8IH8sjafZg6P19eJJ8Z1itP1EE/XvQTnfk95oQtQS7ghi0v6tvvUEKvXMmBfrzo0W8vgn5alzzCX1f0QpqY2rV8EOgGXnvPUNhLL5wac212SIYYqqb7tNPv7mKkm4iecKIczGdErsx0LT2jSAx3pvsEcdIQ0A1DH6bP1frJf6dHfr3ykFyvqxW8/SpIEy+AbhZ6Wvw3OLXLFYHuwUAHHXTQQQcddNBBBx100EEHHXTQP1TP4NUTPeMq9GtQ7wnza1yFPuU96oGmuAq9FPWeMC91FTr1RDUCdAKdQCfQCXQCHXQCnUAn0Al0Ap1AJ9AJdAKdQCfQCXQCnUAn0Al00PkRgE6gE+gEOoFOoBPoBDqBTqAT6AQ6gU6gE+gEOoEOOoFOoBPoBDqBTqAT6AQ6gU6gE+gEOoFOx9B/ACrRkgiipIxYAAAAAElFTkSuQmCC" width="500" height="350" class="img_ev3q"></p><p>正式环境部署时，建议控制台开启强制 HTTPS 访问，具体操作方式是，在 higress-system 命名空间下先创建好 TLS 证书和私钥对应的 secret，例如：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls.crt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">---</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">BEGIN CERTIFICATE</span><span class="token punctuation" style="color:#393A34">---</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tls.key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">---</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">BEGIN RSA PRIVATE KEY</span><span class="token punctuation" style="color:#393A34">---</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">tls</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后通过下面 helm 命令开启强制 HTTPS 访问</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade higress -n higress-system higress.io/higress --set higress-console.tlsSecretName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">my-tls-secret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果希望启用 Higress 自带的 Prometheus&amp;Grafana，可以通过下面 helm 命令进行安装：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade higress -n higress-system higress.io/higress --set higress-console.o11y.enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样 Higress 控制台就可以看到自带的可观测大盘了：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01bUCXjy275GLq7ralt_!!6000000007745-0-tps-3532-2022.jpg" alt="image" class="img_ev3q"></p><p>当然，你也可以对接已有的 Prometheus&amp;Grafana，使用这份 Higress 官方提供的 Dashboard 配置即可：<a href="https://higress.io/grafana/dashboard.json" target="_blank" rel="noopener noreferrer">https://higress.io/grafana/dashboard.json</a></p><p>可以登陆 Higress 控制台 Demo 试用现有所有功能: <a href="http://demo.higress.io" target="_blank" rel="noopener noreferrer">http://demo.higress.io</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="开启-istio-api">开启 Istio API<a href="#开启-istio-api" class="hash-link" aria-label="开启 Istio API的直接链接" title="开启 Istio API的直接链接">​</a></h3><p>通过开启 Istio API，可以实现使用 Higress 平滑替换 Istio Ingress Gateway，具体 helm 命令如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm upgrade higress -n higress-system higress.io/higress --set global.enableIstioAPI</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>基于 Istio API，可以实现目前 Higress 还未提供相应 Ingress 注解的能力，例如基于 Istio EnvoyFilter 来实现 HTTP to Dubbo 的协议转换配置方式：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> EnvoyFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dubbo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">transcoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">configPatches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">applyTo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP_FILTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GATEWAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">listener</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">filterChain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> envoy.filters.network.http_connection_manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">subFilter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> envoy.filters.http.router</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">patch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">operation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> INSERT_BEFORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> envoy.filters.http.http_dubbo_transcoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">typed_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">'@type'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> type.googleapis.com/udpa.type.v1.TypedStruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type_url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> type.googleapis.com/envoy.extensions.filters.http.http_dubbo_transcoder.v3.HttpDubboTranscoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">applyTo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP_ROUTE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GATEWAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routeConfiguration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">vhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">patch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">operation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MERGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">upgrade_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">connect_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">allow_post</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">upgrade_type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CONNECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">typed_per_filter_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">envoy.filters.http.http_dubbo_transcoder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">'@type'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> type.googleapis.com/udpa.type.v1.TypedStruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">type_url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> type.googleapis.com/envoy.extensions.filters.http.http_dubbo_transcoder.v3.HttpDubboTranscoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">request_validation_options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">reject_unknown_method</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">reject_unknown_query_parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">services_mapping</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">method_mapping</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sayName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">parameter_mapping</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">extract_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">extract_key_spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ALL_QUERY_PARAMETER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">mapping_type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> java.lang.String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">passthrough_setting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">passthrough_all_headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">path_matcher</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">match_http_method_spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ALL_GET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">match_pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dubbo/hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.alibaba.nacos.example.dubbo.service.DemoService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">url_unescape_spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ALL_CHARACTERS_EXCEPT_RESERVED</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述配置比较复杂，原因是为了方便 Envoy 数据面程序逻辑处理而设计的 Schema。目前 Higress 社区已经在设计更方便 Ingress 配置使用的 CRD，后续也会在 Higress 控制台上提供对应的配置功能。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ga-版本规划">GA 版本规划<a href="#ga-版本规划" class="hash-link" aria-label="GA 版本规划的直接链接" title="GA 版本规划的直接链接">​</a></h2><p>Higress 预计将在3月底/4月初发布首个 GA 版本, 这个版本的主要规划如下：</p><ol><li>实现 HTTP to Dubbo 协议转换的控制面配置简化</li><li>Higress 控制台提供 Wasm 插件能力，支持配置自定义插件</li><li>推出第一版 Higress Admin API，可以被其他平台/工具集成</li><li>全面完善 Higress 官网文档，覆盖 Higress 全部功能的详细说明</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-社区">Higress 社区<a href="#higress-社区" class="hash-link" aria-label="Higress 社区的直接链接" title="Higress 社区的直接链接">​</a></h2><p>欢迎认领 Higress Issue 任务：<a href="https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22help+wanted%22" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22help+wanted%22</a></p><p>完成一定数量的 Issues 就可以成为 Higress Committer，也有机会获得开源社区的礼物和荣誉🏆</p><p>欢迎加入 Higress 社区群，及时了解更多 Higress 动向：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01xutJV11aSGvdgBHpC_!!6000000003328-0-tps-720-405.jpg" class="img_ev3q"></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Higress + Nacos 微服务网关最佳实践]]></title>
            <link>https://higress.io/zh-cn/blog/nacos</link>
            <guid>https://higress.io/zh-cn/blog/nacos</guid>
            <pubDate>Tue, 10 Jan 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Higress：Nacos的最佳拍档]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>在去年11月的云栖大会上，我们开源了云原生网关 Higress，时隔数月，Higress 的 Github 项目(<a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress</a>)已经收获了近 1k+ star，以及大量社区小伙伴的关注。</p><p>在社区的交流中我们发现有不少微服务开发者在使用如 Spring Cloud Gateway/Zuul 等微服务网关对接 Nacos 注册中心实现微服务的路由，并且希望了解迁移到 Higress 网关能带来哪些好处。
本文将介绍 Higress 组合 Nacos 作为微服务网关能力，并介绍微服务网关发展的两个趋势，为网关的选型指明道路：</p><ul><li>趋势一：统一 API 标准，向云原生微服务架构演进</li><li>趋势二：合并安全&amp;流量网关，向 DevSecOps 演进</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higressnacos的最佳拍档">Higress：Nacos的最佳拍档<a href="#higressnacos的最佳拍档" class="hash-link" aria-label="Higress：Nacos的最佳拍档的直接链接" title="Higress：Nacos的最佳拍档的直接链接">​</a></h2><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01Ww9gDw1PwXJUlwwRy_!!6000000001905-2-tps-1200-475.png" alt="image.png" class="img_ev3q">
Higress 和 Nacos 其实是师出同门——阿里中间件团队。在 Higress 支撑阿里内部业务的阶段，Higress 就已经搭配 Nacos 作为微服务网关使用，凭借高性能支撑了双十一的洪峰流量；到了云产品商业化阶段，Higress 和 Nacos 继续基于阿里云 MSE（Microservices Engine）产品，紧密协作演进产品功能；Higress 开源之后，如果想要自建微服务网关，选择 Higress 配合 Nacos 使用，具备以下优势：</p><ol><li>对比 Spring Cloud Gateway/Zuul 等传统 Java 微服务网关性能高出 2-4 倍，可以显著降低资源成本</li><li>作为云原生网关，实现了 Ingress/Gateway API 标准，兼容 Nginx Ingress 大部分注解，支持业务渐进式向基于 K8s 的微服务架构演进</li><li>与 Dubbo/OpenSergo/Sentinel 等开源微服务生态深度整合，提供最佳实践</li></ol><p>这里默认已经安装好 Higress，搭配 Nacos 使用的具体方式如下：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置服务来源">配置服务来源<a href="#配置服务来源" class="hash-link" aria-label="配置服务来源的直接链接" title="配置服务来源的直接链接">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义一个名为 “production” 的服务来源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心类型是 Nacos 2.x，支持 gRPC 协议</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos2  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问地址，可以是域名或者IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.xxx.xx.32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问端口，Nacos 默认都是 8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 命名空间 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosNamespaceId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> d8ac64f3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">47a814ecf358    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 服务分组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DEFAULT_GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义一个名为 “uat” 的服务来源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> uat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心类型是 Nacos 1.x，只支持 HTTP 协议</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问地址，可以是域名或者IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.xxx.xx.31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册中心的访问端口，Nacos 默认都是 8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 命名空间 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosNamespaceId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 98ac6df3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ab98115dfde4    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Nacos 服务分组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacosGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DEFAULT_GROUP    </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们通过 McpBridge 资源配置了两个服务来源，分别取名 “production”和“uat”，需要注意的是 Higress 对接 Nacos 同时支持 HTTP 和 gRPC 两种协议，建议将 Nacos 升级到 2.x 版本，这样可以在上述配置的 type 中指定 “nacos2” 使用 gRPC 协议，从而更快速地感知到服务变化，并消耗更少的 Nacos 服务端资源。
基于 McpBridge 中的 registries 数组配置，Higress 可以轻松对接多个且不同类型的服务来源（Nacos/Zookeeper/Eureka/Consul/...），这里对于 Nacos 类型的服务来源，支持配置多个不同命名空间，从而实现不同命名空间的微服务可以共用一个网关，降低自建微服务网关的资源成本开销。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-ingress">配置 Ingress<a href="#配置-ingress" class="hash-link" aria-label="配置 Ingress的直接链接" title="配置 Ingress的直接链接">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">provider.DEFAULT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">GROUP.d8ac64f3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">47a814ecf358.nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>和常见的 Ingress 在 backend 中定义 service 不同，这里基于 Ingress 的 resource backend 将上面定义服务来源的 McpBridge 进行关联。并通过注解<code>higress.io/destination</code>指定路由最终要转发到的目标服务。对于 Nacos 来源的服务，这里的目标服务格式为：“服务名称.服务分组.命名空间ID.nacos”，注意这里需要遵循 DNS 域名格式，因此服务分组中的下划线'_'被转换成了横杠'-'。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="丰富的微服务网关能力">丰富的微服务网关能力<a href="#丰富的微服务网关能力" class="hash-link" aria-label="丰富的微服务网关能力的直接链接" title="丰富的微服务网关能力的直接链接">​</a></h3><p>Higress 在微服务发现的基础上，提供了多种实用的微服务网关能力，这里以“灰度发布”和“自定义扩展”进行举例，更多能力可以点击原文参考 Higress 官网文档进行了解。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="灰度发布">灰度发布<a href="#灰度发布" class="hash-link" aria-label="灰度发布的直接链接" title="灰度发布的直接链接">​</a></h4><p>Higress 完全兼容了 Nginx Ingress 的金丝雀（Canary）相关注解，如下所示，可以将带有HTTP Header为x-user-id: 100的请求流量路由到灰度服务中。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress.io/destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">provider.DEFAULT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">GROUP.98ac6df3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxxx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ab98115dfde4.nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/canary</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'true'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/canary-by-header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/canary-by-header-value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'100'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">uat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>您还可以基于 OpenKruise Rollout 让灰度发布和服务部署过程联动，从而实现渐进式交付，具体可以参考这篇文章<a href="https://mp.weixin.qq.com/s/vqwAUITNq9_twYHWX_5ZDg" target="_blank" rel="noopener noreferrer">《Higress &amp; Kruise Rollout: 渐进式交付为应用发布保驾护航》</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="自定义扩展">自定义扩展<a href="#自定义扩展" class="hash-link" aria-label="自定义扩展的直接链接" title="自定义扩展的直接链接">​</a></h4><p>作为微服务网关，需要在微服务架构中承担部分通用逻辑的处理，例如认证鉴权，安全防护等。通用的逻辑无法满足多样性的业务场景，Higress 可以支持开发者添加自定义处理逻辑。与 Spring Cloud Gateway 等传统微服务网关需要开发者自己在 Gateway 代码中加 Filter 不同，Higress 支持开发者使用多种语言编写 Wasm 插件，并动态加载生效，插件生效过程无需重启网关，变更插件逻辑对流量完全无损。
下例是一个屏蔽特定请求的 Wasm 插件，当请求 url 中出现 “swagger.html” 时将被直接拒绝访问，插件实现代码参考：<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/request-block" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/request-block</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> extensions.higress.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"swagger.html"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hangzhou.cr.aliyuncs.com/plugins/demo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Wasm 插件的开发&amp;编译&amp;镜像推送方式可以参考这篇文章<a href="https://mp.weixin.qq.com/s/eoPlaOgRm7u5wJAxhbVGGg" target="_blank" rel="noopener noreferrer">《Higress 实战：30 行代码写一个 Wasm Go插件》</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="微服务网关发展趋势">微服务网关发展趋势<a href="#微服务网关发展趋势" class="hash-link" aria-label="微服务网关发展趋势的直接链接" title="微服务网关发展趋势的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="趋势一统一-api-标准向云原生微服务架构演进">趋势一：统一 API 标准，向云原生微服务架构演进<a href="#趋势一统一-api-标准向云原生微服务架构演进" class="hash-link" aria-label="趋势一：统一 API 标准，向云原生微服务架构演进的直接链接" title="趋势一：统一 API 标准，向云原生微服务架构演进的直接链接">​</a></h3><p>基于一套 API 可以有不同的实现，既让用户不被具体实现锁定，又桥接了技术演进的鸿沟。API 可以说是整个云原生架构的基石，或许有一天 K8s 会消失，但是面向抽象的 API 标准定会长存。在流量网关领域，Ingress API 已经成为标准。而对于微服务网关等更复杂的使用场景，Ingress 受限于其简单的协议字段，需要通过 Ingress 注解等方式进行能力扩展，难以被标准化。因此诸如 Contour、Emissary、Kong、APISIX 等都定义了自己的 HTTP 路由等 CRD，网关的 API 定义开始呈现碎片化。
这一背景之下，Gateway API 应运而生，并且在过去的一年里从 alpha 演进到了 beta 阶段。虽然目前 Gateway API 还未定稿，协议仍会发生变动，不建议用于生产，但 API 统一趋势已经不可阻挡，只是时间的问题。下图是 Gateway API 的一个用例场景，不同于 Ingress API，将集群运维和业务运维的职责进行了划分，这样业务开发人员不再需要关心网站证书等集群级的细节，只专注于业务本身的 DevOps，集群运维任务可以交给 SRE 人员进行统一处理。
<img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01jDsDrv1zaqj82YkYP_!!6000000006731-2-tps-2735-1519.png" alt="image.png" class="img_ev3q">
Higress 目前采用 Ingress 注解的能力来实现能力扩展，并兼容了 Nginx Ingress 大部分常用注解，且具备平滑迁移到 Gateway API 的能力。
Higress 为传统微服务架构，提供了渐进式的方式，向基于 K8s 的云原生微服务架构演进：可以通过 Nacos 发现部署在 K8s 之外的服务，从而实现了网关后端微服务可以和 K8s 解耦，业务团队可以将微服务逐个迁移至 K8s，而不用担心网关层的流量影响。
从传统微服务网关迁移到 Higress，再渐进式完成整个微服务架构的云原生化，是一个明智的选择。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="趋势二合并安全流量网关向-devsecops-演进">趋势二：合并安全&amp;流量网关，向 DevSecOps 演进<a href="#趋势二合并安全流量网关向-devsecops-演进" class="hash-link" aria-label="趋势二：合并安全&amp;流量网关，向 DevSecOps 演进的直接链接" title="趋势二：合并安全&amp;流量网关，向 DevSecOps 演进的直接链接">​</a></h3><p>Higress 提出了将安全、流量、微服务网关三合一的概念，首先来看一个典型的多层网关架构：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN0178hdNj25QDDnqmISC_!!6000000007520-2-tps-1318-198.png" class="img_ev3q">
在这个架构中，用 WAF 网关实现安全能力，Ingress 网关实现集群入口网关能力（非 K8s 场景或会部署一层 Nginx），SCG（Spring Cloud Gateway） 实现微服务网关能力。这样的架构下，需要对每一层网关都进行容量评估，每一层网关都是潜在的瓶颈点，都可能需要进行扩容。这样造成的资源成本和运维人力成本都是巨大的。并且每多一层网关，就多一层可用性风险。一旦出现可用性问题，多层网关会导致问题定位复杂度显著上升，对应的平均故障恢复时间（MTTR）将大幅增加。
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01BnAVqH1SCE73I5l85_!!6000000002210-2-tps-1318-198.png" class="img_ev3q">
采用三合一的架构中，可以显著降低成本，并提高系统整体可用性。同时这也符合 DevSecOps 的微服务演进趋势，微服务开发者可以更多地从业务接口视角关注安全性，而不是采用所有路由一刀切的 WAF 防护模式。
技术架构演进的背后是组织架构演进，这也是微服务 DevOps 一直在强调的，要围绕开发者为核心，从而提升微服务开发效率。向 DevSecOps 演进并没有捷径，依然需要开发角色和运维角色之间的双向奔赴，打破传统开发与运维之间的壁垒，形成从开发、部署、安全运营这样一个全功能化的敏捷团队。
通过 Higress 将网关合并作为向 DevSecOps 演进的抓手，是一个明智的选择。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参与-higress-社区">参与 Higress 社区<a href="#参与-higress-社区" class="hash-link" aria-label="参与 Higress 社区的直接链接" title="参与 Higress 社区的直接链接">​</a></h2><p>Higress 开源贡献小组正在火热招募贡献者。如果您有时间，有热情，有意愿，欢迎联系社区加入开源贡献小组，一起共同完善 Higress，一起主导下一代云原生网关的设计和实现。
社区官网（点击“阅读原文”跳转）: <a href="https://higress.io" target="_blank" rel="noopener noreferrer">https://higress.io</a>
社区开发者群：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01Zc7yGt1p0zYq3OCwj_!!6000000005299-2-tps-979-1280.png" alt="image.png" class="img_ev3q">
社区交流群：
<img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01Ebh7P021yKGBaP35B_!!6000000007053-2-tps-720-405.png" alt="higress-comm.png" class="img_ev3q"></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[30行代码写一个Wasm Go插件]]></title>
            <link>https://higress.io/zh-cn/blog/30-line-wasm</link>
            <guid>https://higress.io/zh-cn/blog/30-line-wasm</guid>
            <pubDate>Tue, 22 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[对《Higress 开源背后的发展历程和上手 Demo 演示》直播演示 demo 的详细说明]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>在11月15号的直播 《Higress 开源背后的发展历程和上手 Demo 演示》中，为大家演示了 Higress 的 Wasm 插件如何面向 Ingress 资源进行配置生效，本文对当天的 Demo 进行一个回顾，并说明背后的原理机制。</p><p>本文中 Demo 运行的前提，需要在 K8s 集群中安装了 Higress，并生效了下面这份 quickstart 配置：
<a href="https://higress.io/samples/quickstart.yaml" target="_blank" rel="noopener noreferrer">https://higress.io/samples/quickstart.yaml</a>
这个 Demo 要实现的功能是一个 Mock 应答的功能，需要实现根据配置的内容，返回 HTTP 应答。
本文会按以下方式进行介绍：</p><ul><li>编写代码：代码逻辑解析</li><li>生效插件：说明代码如何进行编译打包并部署生效</li><li>测试插件功能：说明全局粒度，路由/域名级粒度如何生效</li><li>插件生效原理：对整体流程进行回顾，说明插件生效的原理</li><li>三个革命性的特性：介绍 Wasm 插件机制为网关插件开发带来的变革</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="编写代码">编写代码<a href="#编写代码" class="hash-link" aria-label="编写代码的直接链接" title="编写代码的直接链接">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    . "github.com/alibaba/higress/plugins/wasm-go/pkg/wrapper"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "github.com/tidwall/gjson"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SetCtx(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "my-plugin",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ParseConfigBy(parseConfig),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ProcessRequestHeadersBy(onHttpRequestHeaders),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type MyConfig struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func parseConfig(json gjson.Result, config *MyConfig, log Log) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.content = json.Get("content").String()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func onHttpRequestHeaders(ctx HttpContext, config MyConfig, log Log) types.Action {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxywasm.SendHttpResponse(200, nil, []byte(config.content), -1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return types.ActionContinue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面代码中可以看到三个函数：</p><ul><li><p>main：插件通过 main 函数定义插件上下文，包括插件名称，用于解析配置的函数，以及用于处理请求/应答的函数</p></li><li><p>parseConfig：这个函数通过在 SetCtx 中指定的 ParseConfigBy 被挂载到插件配置解析阶段，传入的三个参数分别是：</p><ul><li>json：传入插件的配置，将统一序列化为一个 json 字典对象，提供 parseConfig 进行解析</li><li>config：parseConfig 将解析后的插件配置输出到这个 MyConfig 对象</li><li>log：提供日志输出接口</li></ul></li><li><p>onHttpRequestHeaders：函数中调用的 proxywasm.SendHttpResponse，用于实现直接返回 HTTP 应答，这个函数通过在 SetCtx 中指定的 ProcessRequestHeadersBy 被挂载到解析请求 Header 的执行阶段，其他的挂载方式还有：</p><ul><li><p>ProcessRequestBodyBy：挂载到解析请求 Body 的执行阶段</p></li><li><p>ProcessResponseHeadersBy：挂载到构造应答 Header 的执行阶段</p></li><li><p>ProcessResponseBodyBy：挂载到构造应答 Body 的执行阶段</p><p> 传入的三个参数分别是：</p></li><li><p>ctx：用于获取请求上下文，如 scheme/method/path 等，通过 ctx 可以设置自定义上下文，能跨执行阶段访问</p></li><li><p>config：提供 parseConfig 解析好的自定义配置</p></li><li><p>log：提供日志输出接口</p></li></ul></li></ul><p>这个 30 行代码实现的插件功能比较简单，这里有一些功能相对复杂的例子：<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions</a>
这里有插件 sdk 的详细使用文档：
<a href="https://higress.io/zh-cn/docs/user/wasm-go.html" target="_blank" rel="noopener noreferrer">https://higress.io/zh-cn/docs/user/wasm-go.html</a>
这个插件 sdk 是基于 Tetrate 社区的 proxy-wasm-go-sdk 实现的，如果关注更底层的细节，可以查看：
<a href="https://github.com/tetratelabs/proxy-wasm-go-sdk" target="_blank" rel="noopener noreferrer">https://github.com/tetratelabs/proxy-wasm-go-sdk</a>
<a href="https://github.com/alibaba/higress/blob/main/plugins/wasm-go/pkg/wrapper/plugin_wrapper.go" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/blob/main/plugins/wasm-go/pkg/wrapper</a>
可以看到，Higress 的 wasm-go sdk 是通过 Go 1.18 引入的泛型特性封装了插件上下文处理细节，从而降低插件开发所需代码量，开发者只用关心配置解析和请求应答处理的逻辑。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="生效插件">生效插件<a href="#生效插件" class="hash-link" aria-label="生效插件的直接链接" title="生效插件的直接链接">​</a></h2><p>编写完成代码后，一共有三个步骤，实现插件逻辑的生效：</p><ol><li>编译：将 go 代码编译成 Wasm 格式文件</li><li>镜像推送：将 Wasm 文件打包成 docker 镜像，并推送至镜像仓库</li><li>下发配置：在 K8s 上创建 WasmPlugin 资源</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="编译">编译<a href="#编译" class="hash-link" aria-label="编译的直接链接" title="编译的直接链接">​</a></h3><p>将上面的 Go 文件 main.go 编译成 plugin.wasm</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tinygo build -o plugin.wasm -scheduler</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">none -target</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">wasi main.go</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="镜像推送">镜像推送<a href="#镜像推送" class="hash-link" aria-label="镜像推送的直接链接" title="镜像推送的直接链接">​</a></h3><p>编写 Dockerfile</p><div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM scratch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY plugin.wasm ./</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>构建并推送 Docker 镜像 （这里示例用的是 Higress 的官方镜像仓库）</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t higress-registry.cn-hangzhou.cr.aliyuncs.com/plugins/demo:1.0.0 </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> push higress-registry.cn-hangzhou.cr.aliyuncs.com/plugins/demo:1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="下发配置">下发配置<a href="#下发配置" class="hash-link" aria-label="下发配置的直接链接" title="下发配置的直接链接">​</a></h3><p>编写 wasmplugin.yaml，配置说明：</p><ul><li>selector： 选中了默认安装在 higress-system 命名空间下的 higress-gateway 生效这份插件</li><li>pluginConfig：插件配置，最终会被转换成上面代码中的 MyConfig 对象</li><li>url：填写镜像地址，需要以"oci://"开头</li></ul><p>除了这些配置外，还可以定义插件的执行阶段和优先级等进阶配置，可以参考 Istio API 官方文档：<a href="https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/" target="_blank" rel="noopener noreferrer">https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># wasmplugin.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> extensions.higress.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"swagger.html"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hangzhou.cr.aliyuncs.com/plugins/demo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过 kubectl 创建这个资源</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f wasmplugin.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试插件功能">测试插件功能<a href="#测试插件功能" class="hash-link" aria-label="测试插件功能的直接链接" title="测试插件功能的直接链接">​</a></h2><p>基于之前生效的 quickstart.yaml，目前集群中的 Ingress 访问拓扑如下所示：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ing-topopng"><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN0178hYAV1sBTSczmfAf_!!6000000005728-2-tps-646-605.png" alt="ing-topo.png" class="img_ev3q"><a href="#ing-topopng" class="hash-link" aria-label="ing-topopng的直接链接" title="ing-topopng的直接链接">​</a></h3><p>未生效插件的情况下：</p><ul><li>请求<code>/foo</code> 将返回 HTTP 应答 <code>"foo"</code></li><li>请求<code>/bar</code> 将返回 HTTP 应答 <code>"bar"</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全局生效">全局生效<a href="#全局生效" class="hash-link" aria-label="全局生效的直接链接" title="全局生效的直接链接">​</a></h3><p>基于上文生效插件阶段，下发的 wasmplugin.yaml，生效插件后效果如下：</p><ul><li>请求<code>/foo</code> 将返回 HTTP 应答 <code>"hello higress"</code></li><li>请求<code>/bar</code> 将返回 HTTP 应答 <code>"hello higress"</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="域名路由级生效">域名&amp;路由级生效<a href="#域名路由级生效" class="hash-link" aria-label="域名&amp;路由级生效的直接链接" title="域名&amp;路由级生效的直接链接">​</a></h3><p>将 wasmplugin.yaml 配置修改如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># wasmplugin.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> extensions.higress.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 跟上面例子一样，这个配置会全局生效，但如果被下面规则匹配到，则会改为执行命中规则的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">block_urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"swagger.html"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">matchRules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 路由级生效配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ingress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> default/foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># default 命名空间下名为 foo 的 ingress 会执行下面这个配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">block_bodies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"foo"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">ingress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> default/bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># default 命名空间下名为 bar 的 ingress 会执行下面这个配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">block_bodies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bar"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 域名级生效配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*.example.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 若请求匹配了上面的域名, 会执行下面这个配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">block_bodies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"foo"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bar"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oci</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hangzhou.cr.aliyuncs.com/plugins/demo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 pluginConfig 中增加了 <code>_rules_</code>  规则列表，规则中可以指定匹配方式，并填写对应生效的配置:</p><ul><li><em>match_route</em>：匹配 Ingress 生效，匹配格式为：Ingress 所在命名空间 + "/" + Ingress 名称</li><li><em>match_domain</em>：匹配域名生效，填写域名即可，支持通配符</li></ul><p>生效这份修改后的配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f wasmplugin.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到效果如下：</p><ul><li>请求<code>/foo</code> 将返回 HTTP 应答 <code>"hello foo"</code> (匹配到第一条 rule)</li><li>请求<code>/bar</code> 将返回 HTTP 应答 <code>"hello bar"</code> (匹配到第二条 rule)</li><li>请求<code>www.example.com</code> 将返回 HTTP 应答 <code>"hello world"</code> （匹配到第三条 rule）</li><li>请求<code>www.abc.com</code> 将返回 HTTP 应答 <code>"hello higress"</code> （没有匹配的 rule，使用全局配置）</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="插件生效原理">插件生效原理<a href="#插件生效原理" class="hash-link" aria-label="插件生效原理的直接链接" title="插件生效原理的直接链接">​</a></h2><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01PO4HYC1h7qYHonHHZ_!!6000000004231-2-tps-1100-537.png" alt="wasm.png" class="img_ev3q"></p><p>这里对插件的生效机制简单做个说明：</p><ol><li>用户将代码编译成 wasm 文件</li><li>用户将 wasm 文件构建成 docker 镜像</li><li>用户将 docker 镜像推送至镜像仓库</li><li>用户创建 WasmPlugin 资源</li><li>Istio watch 到 WasmPlugin 资源的变化</li><li>Higress Gateway 中的 xDS proxy 进程从 Istio 获取到配置，发现插件的镜像地址</li><li>xDS proxy 从镜像仓库拉取镜像</li><li>xDS proxy 从镜像中提取出 wasm 文件</li><li>Higress Gateway 中的 envoy 进程从 xDS proxy 获取到配置，发现 wasm 文件的本地路径</li><li>envoy 从本地文件中加载 wasm 文件</li></ol><p>这里 envoy 获取配置并加载 wasm 文件使用到了 ECDS (Extension Config Discovery Service)的机制，实现了 wasm 文件更新，直接热加载，不会导致任何连接中断，业务流量完全无损。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三个革命性的特性">三个革命性的特性<a href="#三个革命性的特性" class="hash-link" aria-label="三个革命性的特性的直接链接" title="三个革命性的特性的直接链接">​</a></h2><p>上面的 Wasm 插件机制为网关自定义插件开发带来了三个革命性的特性。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特性一插件生命周期和网关解耦">特性一：插件生命周期和网关解耦<a href="#特性一插件生命周期和网关解耦" class="hash-link" aria-label="特性一：插件生命周期和网关解耦的直接链接" title="特性一：插件生命周期和网关解耦的直接链接">​</a></h3><p>这个特性主要得益于 Istio 的 WasmPlugin 机制设计。可以和 K8s Nginx Ingress 的插件机制做个对比：</p><blockquote><p>reference: <a href="https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/plugins/README.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/plugins/README.md</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="installing-a-plugin">Installing a plugin<a href="#installing-a-plugin" class="hash-link" aria-label="Installing a plugin的直接链接" title="Installing a plugin的直接链接">​</a></h3><p>There are two options:</p><ul><li>mount your plugin into /etc/nginx/lua/plugins/<your></your> in the ingress-nginx pod</li><li>build your own ingress-nginx image like it is done in the <a href="https://github.com/ElvinEfendi/ingress-nginx-openidc/tree/master/rootfs/etc/nginx/lua/plugins/openidc" target="_blank" rel="noopener noreferrer">example</a> and install your plugin during image build</li></ul></blockquote><p>可以看到 Nginx Ingress 加载自定义插件，需要将 lua 文件挂载进 pod，或者在构建镜像时装入。这样就将插件的生命周期跟网关绑定在一起，插件逻辑更新，需要发布新版本，网关也需要发布新版本或者重新部署。
使用 WasmPlugin 的机制，插件需要发布新版本，只需构建插件自身的镜像并进行下发生效，而且可以基于镜像的 tag 进行插件的版本管理。这样插件变更，不仅无需重新部署网关，结合 Envoy 的 ECDS 机制对流量也是完全无损。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特性二高性能的多语言支持">特性二：高性能的多语言支持<a href="#特性二高性能的多语言支持" class="hash-link" aria-label="特性二：高性能的多语言支持的直接链接" title="特性二：高性能的多语言支持的直接链接">​</a></h3><p>基于 Wasm 的能力，可以用多种语言编写插件，对开发人员更加友好。实现多语言开发插件的另一种方式是基于 RPC 和网关进程通信的外置进程/服务插件，这种模式会有额外的 IO 开销，并且附加的进程/服务也带来额外的运维复杂度。目前大家对 Wasm 插件的性能比较关心，从我们的测试数据来看，指令执行性能相比原生的 C++ 语言确实有差距，但性能和 Lua 持平，且远好于外置插件。
对于一段逻辑：<code>循环执行20次请求头设置，循环执行20次请求头获取，循环执行20次请求头移除。</code>我们对比了分别用 Lua 和不同语言实现的 Wasm 的处理性能，下面是对单个请求延时的影响对比：</p><table><thead><tr><th><strong>实现语言</strong></th><th><strong>请求延时增加</strong></th></tr></thead><tbody><tr><td>Lua</td><td>0.20毫秒</td></tr><tr><td>Wasm (C++)</td><td>0.19毫秒</td></tr><tr><td>Wasm (Go)</td><td>0.20毫秒</td></tr><tr><td>Wasm (Rust)</td><td>0.21毫秒</td></tr><tr><td>Wasm (AssemblyScript)</td><td>0.21毫秒</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特性三安全沙箱">特性三：安全沙箱<a href="#特性三安全沙箱" class="hash-link" aria-label="特性三：安全沙箱的直接链接" title="特性三：安全沙箱的直接链接">​</a></h3><p>Envoy 目前支持多种 Wasm 的运行时，例如 V8，WAMR，wasmtime 等等，这些运行时均提供了安全沙箱能力，即 Wasm 插件中出现了访问空指针、异常未捕获等逻辑，也不会令 Envoy 宿主进程 Crash。并且可以通过配置，在插件逻辑出现异常后进行 Fail Open 处理，跳过插件的执行逻辑，将对业务的影响降至最低。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="开源社区">开源社区<a href="#开源社区" class="hash-link" aria-label="开源社区的直接链接" title="开源社区的直接链接">​</a></h2><p>特别感谢 Istio/Envoy 社区的前置工作，让 Higress 可以实现对 Ingress 资源启用 WasmPlugin ，增强了 Ingress Controller 的自定义扩展能力。
特别感谢 Tetrate 社区实现的 proxy-wasm-go-sdk，Higress 在这个基础上封装了 wasm-go sdk，降低了开发插件的上手门槛。
Higress 对 Istio/Envoy 的 Wasm 能力做了一些 Bugfix 的工作，目前已经都合并进了上游社区。后续的一些 Feature 能力，也会持续反哺上游社区。
同时欢迎大家一起为 Higress 的插件以及其他社区生态添砖加瓦，为 Higress 贡献请参考文档：
<a href="https://higress.io/zh-cn/docs/developers/guide_dev.html" target="_blank" rel="noopener noreferrer">https://higress.io/zh-cn/docs/developers/guide_dev.html</a></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[欢迎报名Higress首次线下Meetup]]></title>
            <link>https://higress.io/zh-cn/blog/first-meetup</link>
            <guid>https://higress.io/zh-cn/blog/first-meetup</guid>
            <pubDate>Tue, 22 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[线下Meetup报名]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN013pqDug1iTf1wdYIat_!!6000000004414-2-tps-800-8358.png" class="img_ev3q"></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[阿里巴巴重磅开源云原生网关]]></title>
            <link>https://higress.io/zh-cn/blog/higress</link>
            <guid>https://higress.io/zh-cn/blog/higress</guid>
            <pubDate>Fri, 04 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[介绍Higress的诞生背景与发展历程]]></description>
            <content:encoded><![CDATA[<p>Higress 是一款标准化、高集成、易扩展、热更新的云原生网关。</p><p>Higress 源自阿里巴巴内部电商、交易等核心生产场景的实践沉淀，遵循 Ingress/Gateway API 标准，将流量网关、微服务网关、安全网关三合一，并在此基础上扩展了服务管理插件、安全类插件和自定义插件，高度集成 K8s 和微服务生态，包括 Nacos 注册和配置、Sentinel 限流降级等能力，并支持规则变更毫秒级生效等热更新能力。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01VYKTu922ZsiibaCml_!!6000000007135-2-tps-2178-1198.png" alt="image.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress的前世今生">Higress的前世今生<a href="#higress的前世今生" class="hash-link" aria-label="Higress的前世今生的直接链接" title="Higress的前世今生的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="诞生背景">诞生背景<a href="#诞生背景" class="hash-link" aria-label="诞生背景的直接链接" title="诞生背景的直接链接">​</a></h3><p>Higress 的创建源于阿里内部的“本地生活战役”，该战役始于“支付宝2020合作伙伴大会”，在此大会上支付宝宣布升级为数字生活开放平台。该战役的核心技术目标，是实现阿里巴巴业务域与蚂蚁业务域之间 RPC 直接调用，但因阿里巴巴与蚂蚁业务域网络是隔离的，即网络是不通的，很自然想到利用网关来解决此问题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="#技术选型" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h3><p>利用网关来解决阿里巴巴与蚂蚁跨业务域 RPC 互通问题，首先要对网关做技术选型。</p><p>相信大家也都或多或少知道，阿里巴巴开源的反向代理程序 Tengine。Tengine 在阿里内部统一接入网关 AServer 中被使用，我们团队就是负责其开发运维，同时我们团队也在负责阿里巴巴 Service Mesh 的落地，不管是对 Tengine 还是对 Istio + Envoy 这套架构都比较熟悉。</p><p>在选型时，虽然也调研过一些其他的软件，但考虑到网关对性能、可靠性的高要求，在结合我们自身的网关运维经验，决定看看 Tengine 与 Envoy 是否可以满足我们的业务需求，在对比时我们罗列了四个关键要点，其对比如下：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN0154SFHA1geXCJT8KIm_!!6000000004167-2-tps-2568-888.png" alt="image.png" class="img_ev3q">
这里提一下“为什么我们认为配置的热更新，是非常重要的”？</p><p>Tengine/Nginx 的配置更新需要 reload，reload 需要重启 worker 进程，重启时会引起流量抖动，对长连接影响尤为明显。在网关的集群规模非常大时，更是不能随意的做 reload，这时就会引发一个矛盾点：业务向网关提交配置后，希望能快速验证，但受限于 reload 机制和稳定性要求，无法满足业务快速验证与快速试错的诉求。</p><p>现在已经有很多主流应用选择采用长连接，HTTP 1.1一般默认会使用Keep-Alive去保持长连接，后续HTTP 2以及HTTP 3也是如此，随着网络协议的发展，未来使用长连接会变得更加普遍。而配置热更新天然对长连接非常友好。</p><p>如何解决这点呢？</p><p>一是采用两层网关，即流量网关 + 业务网关；二是实现网关原生支持配置热更新。除了对比不同方案的优劣势，我们也调研了 Envoy 作为网关在业界的趋势，结论是目前 Envoy 作为 K8s 中的 Ingress Provider 增长最快的事实（Ingress Provider 指 K8s Ingress 规范具体实现，因 K8s Ingress 自身只是规范定义，是 K8s 下外部流量进入集群内部的网关规范定义），我们最终选择了 Envoy 来实现两层网关。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01noxgsq1izikgjVavA_!!6000000004484-2-tps-2948-1054.png" alt="image.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="发展历程">发展历程<a href="#发展历程" class="hash-link" aria-label="发展历程的直接链接" title="发展历程的直接链接">​</a></h3><p>Higress从最初社区的 Istio + Envoy，到经历阿里巴巴内部的自研扩展，再到大规模生成验证，最后完成商业化产品的发布，其整个过程介绍如下：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01ZzyYWg1mJoyzwgeoC_!!6000000004934-2-tps-2296-908.png" alt="image.png" class="img_ev3q">
下面的章节会对Higress的各个阶段做进一步的详细说明。</p><h1>Higress (2020.05~2020.11)</h1><p>此阶段的大目标是为了满足集团与蚂蚁RPC互通，降低全链路的RT，解决原s2s链路因RT过高带来的用户体验差及无法满足更多集团与蚂蚁协同场景要求。s2s链路是走公网链路，协议采用HTTP。与蚂蚁互通网关的架构图如下，这里以上海云单元为背景说明。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01uEUUkR1Er4nkwYiOW_!!6000000000404-2-tps-2036-1088.png" alt="image.png" class="img_ev3q"></p><p>上图主要展示的是集团侧的架构，最终采用了Istio+Envoy的方案，在部署的时候又分成了出口集群和入口集群。之所以拆成两个集群，一方面是当时两边互访，蚂蚁调集团的流量要远远大于集团调蚂蚁的流量，上下行特别不均等；另一方面是分开之后两个集群可以各自维护，稳定性会更好。</p><p>Higress 从开始立项到完成第一期研发，网关改造的核心工作差不多两个人投入了一个半月左右，其中还涉及到大量网络、安全等协调部门的工作。Higress架构并没有完全按照社区方案来设计，社区版本中配置变更和服务发现使用的是K8s，在阿里内部庞大的服务规模及配置量下社区原生方案不管在稳定性及性能上都无法满足要求，因此阿里这套方案重点对服务发现、配置存储组件做了替换，及优化xDS推送性能。</p><p>Higress 上线后，顺利达成了最初的业务诉求，目前蚂蚁互通网关链路已经成为集团与蚂蚁互通的首选方案，一些支付链路也迁移到了该方案，例如充值中心等，具体达到的成果简述如下：</p><ul><li>蚂蚁调用集团链路相比原链路RT降低50%，网关自身RT 0.3ms。</li><li>Higress成功复制到集团与蚂蚁的消息互通，目前集团与蚂蚁的消息互通也是走的Higress Triple链路。</li><li>微服务网关从5月份上线，目前已经成为集团与蚂蚁东西向流量的核心链路，飞猪、手淘、口碑、饿了么、1688、部分导购应用、商品库、评价等业务已成功上线，而且圆满支撑了618大促、支付宝717夏至大促。</li><li>在2020双11大促每秒 数十万 的请求流量，圆满支撑了双11城市生活狂欢节的互动会场。</li><li>在技术侧完成了Higress在东西向流量分发的探索。</li></ul><h1>Higress (2020.12~2021.10)</h1><p>随着阿里巴巴上云战役的推进，越来越多的场景找到我们。比如云上云下业务互通，由于 Tengine 服务管理弱导致阿里内部大量二层微服务网关需要收敛，这就需要从业务上做 Tengine+Envoy 两层网关的演进，承担南北向网关流量。在 2020 年 12 月份，团队开始了Higress 架构的继续演进，以优酷场景为例的演进过程如下图：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01t1RGjj1RpKIIm5zQU_!!6000000002160-2-tps-1614-1194.png" alt="image.png" class="img_ev3q"></p><p>Higress  南北向的架构图如下：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01B2guUL1Q8RauU7pCo_!!6000000001931-2-tps-2390-1242.png" alt="image.png" class="img_ev3q"></p><p>在两层架构中，Higress 网关更多承担了微服务网关和微服务治理的需求，和 Tengine 流量网关完成了整合。在这个过程里，团队支撑优酷内部多个二层微服务网关统一的工作，大幅提升了性能和运维效率。</p><p>在这一阶段，Higress Gateway 实现了东西向、南北向全域流量的调度分发，东西向上不仅支持跨业务域的蚂蚁 RPC 互通，也扩展到了混合云的云上云下 RPC 互通场景，覆盖钉钉文档、阿里视频云、达摩院的店小蜜、智慧数字人等。该阶段的业务大图如下（云上云下互通场景，以钉钉为例说明）：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01VQ51BO2A5D7oqbLG6_!!6000000008151-2-tps-2370-1200.png" alt="image.png" class="img_ev3q"></p><p>随着 Higress Gateway 覆盖的业务场景越来多，在跟优酷持续合作的过程中，双方团队不约而同提出了一个设想：Tengine Gateway（承担流量网关角色） + Higress Gateway（承担微服务网关角色）的两层网关是否可以合并为一层 Higress Gateway？</p><p>我们对这一想法做了调研，答案是肯定的，并且当时大家也合作设计了新的架构方案，如下图：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01DMqpay1COYubY2QrN_!!6000000000071-2-tps-2394-1250.png" alt="image.png" class="img_ev3q"></p><p>虽然由于各种各样的原因，这个方案最终没有跟优酷继续往下推进。但这个演进方向让团队明确了网关新的发展趋势：<strong>在以 K8s 主导的容器化背景下，由于K8s 集群内外网络的天然隔离性，用户需要一款兼顾高性能与安全性，以及强大服务治理能力的入口网关。这也为后续团队将技术沉淀变成云产品、推进Higress的诞生打下了基础。</strong></p><p>2021 年，阿里巴巴开启了中间件三位一体战役，目标是用云产品支撑集团业务。<strong>我们开始将孵化成熟的Higress技术沉淀为云产品，即目前阿里云上提供的 MSE 云原生网关</strong>，一方面面向广大的公有云用户提供托管的网关服务，另一方面也对内服务集团。MSE 云原生网关的技术架构简图如下：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01jCUMA11It93SO68gE_!!6000000000950-2-tps-1570-1262.png" alt="image.png" class="img_ev3q"></p><h1>Higress (2021.11~2022.11)</h1><p>随着Higress成为云产品服务于更多外部用户，我们逐步发现用户对Higress提出了更高的要求，其中反馈较多的大的需求点是插件扩展、Waf防护、多注册中心、Nginx Ingress注解兼容以及HTTP转Dubbo协议，当然也有很多小的需求点在此就不一一列出，因此该阶段我们重点发力在上述用户反馈的高频需求。</p><p>Higress 提供的插件市场，其一阶段支持Wasm插件，满足追求高性能、高安全的用户对网关的扩展诉求，二阶段会支持Lua插件，满足传统用户使用Lua的扩展的诉求，如Nginx用户，三阶段会支持进程外插件，满足多语言用户诉求，尤其是Java用户因现阶段Java社区对WebAssembly支持尚不完善但又希望对网关进行扩展的诉求。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01j4BOm725DO7A6PdWS_!!6000000007492-2-tps-1424-1282.png" alt="image.png" class="img_ev3q"></p><p>Higress 也支持了Nginx Ingress注解平滑迁移的能力，满足部分用户期望迁移到Higress但又不希望重新配置网关的诉求，同时<strong>Higress打破了Nginx Ingress只能关联单个K8s集群的限制，支持关联多个K8s集群，即可以将Higress作为统一接入网关使用，同时又可以享受Ingress的红利</strong>。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01M65eMf1PZB6HdQsOt_!!6000000001854-2-tps-2480-1126.png" alt="image.png" class="img_ev3q"></p><p>对于传统使用Dubbo的微服务用户希望使用原生RPC方式暴露对外服务，但通常提供外部访问的服务以使用HTTP为主，为了帮助Dubbo用户降低服务暴露的开发成本，Higress提供了HTTP转Dubbo协议功能，且通过Console为用户提供白屏化的配置方式，<strong>某客户使用后反馈“这是业界完成度最高的HTTP转Dubbo协议”功能</strong>。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN013yp9rz202KTX6AkAa_!!6000000006791-2-tps-2356-1280.png" alt="image.png" class="img_ev3q"></p><p>在云原生的浪潮下，开源已经成为软件发展的必然趋势与快速路径，因为社区的力量是非常强大的。因此我们将
这套经过内部实践沉淀下来的网关方案Higress正式对外开源，以Kubernetes Ingress网关为契机带来了流量网关与微服务网关融合的可能性，结合阿里内部实践沉淀Higress实现了流量网关 + 微服务网关 + 安全网关三合一的高集成能力，同时深度集成了Dubbo、Nacos、Sentinel等，能够帮助用户极大的降低网关的部署及运维成本，而且能力不打折。</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01ad1fKt1toEafyw0GN_!!6000000005948-2-tps-1734-1360.png" alt="image.png" class="img_ev3q"></p><h1>Higress 未来展望</h1><p>虽然目前云原生已经成为必然趋势，但现实是有很大一部分用户处于迁移上云的过程中，在从传统架构向以Kubernetes 为代表的容器化云原生架构迁移，可预见这在未来很长一段时间会一直持续，因此 Higress 后续会重点支持非 Kubernetes 部署架构，以 Higress + Nacos 的组合形式为用户提供最小集运行环境，同时满足用户服务注册、配置管理、微服务治理的诉求。</p><p>在以 Kubernetes 为代表的容器化云原生方向，我们在兼容好现有 Ingress 标准的基础上，会重点发力下一代的Ingress 标准 Gateway API，利用 Gateway API 带来的契机打通南北向与东西向的全域流量调度，帮助用户使用一套架构架构同时管理外部与内部流量，降低部署运维成本、提升开发及运维效率。</p>]]></content:encoded>
        </item>
    </channel>
</rss>