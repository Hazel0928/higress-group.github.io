"use strict";(self.webpackChunkhigress_website=self.webpackChunkhigress_website||[]).push([[5275],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>g});var i=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=i.createContext({}),c=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=c(e.components);return i.createElement(s.Provider,{value:n},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(t),d=a,g=m["".concat(s,".").concat(d)]||m[d]||u[d]||o;return t?i.createElement(g,r(r({ref:n},p),{},{components:t})):i.createElement(g,r({ref:n},p))}));function g(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,r=new Array(o);r[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[m]="string"==typeof e?e:a,r[1]=l;for(var c=2;c<o;c++)r[c]=t[c];return i.createElement.apply(null,r)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},3318:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var i=t(7462),a=(t(7294),t(3905));const o={title:"Wasm Plugin Image Specification",keywords:["wasm","image","oci"],description:"Wasm Plugin Image Specification",custom_edit_url:"https://github.com/higress-group/higress-group.github.io/blob/main/i18n/en-us/docusaurus-plugin-content-docs/current/user/wasm-image-spec.md"},r="Wasm Plugin Image Specification",l={unversionedId:"user/wasm-image-spec",id:"user/wasm-image-spec",title:"Wasm Plugin Image Specification",description:"Wasm Plugin Image Specification",source:"@site/i18n/en-us/docusaurus-plugin-content-docs/current/user/wasm-image-spec.md",sourceDirName:"user",slug:"/user/wasm-image-spec",permalink:"/en-us/docs/user/wasm-image-spec",draft:!1,editUrl:"https://github.com/higress-group/higress-group.github.io/blob/main/i18n/en-us/docusaurus-plugin-content-docs/current/user/wasm-image-spec.md",tags:[],version:"current",frontMatter:{title:"Wasm Plugin Image Specification",keywords:["wasm","image","oci"],description:"Wasm Plugin Image Specification",custom_edit_url:"https://github.com/higress-group/higress-group.github.io/blob/main/i18n/en-us/docusaurus-plugin-content-docs/current/user/wasm-image-spec.md"},sidebar:"docs",previous:{title:"HTTP to Dubbo",permalink:"/en-us/docs/user/dubbo-http2rpc"},next:{title:"ai-proxy",permalink:"/en-us/docs/plugins/ai/ai-proxy"}},s={},c=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. Image Structure",id:"2-image-structure",level:2},{value:"3. Metadata File Format",id:"3-metadata-file-format",level:2},{value:"4. How to Build an Image",id:"4-how-to-build-an-image",level:2},{value:"5. Appendix",id:"5-appendix",level:2},{value:"5.1 Default Icon for Each Plugin Category",id:"51-default-icon-for-each-plugin-category",level:3}],p={toc:c},m="wrapper";function u(e){let{components:n,...t}=e;return(0,a.kt)(m,(0,i.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"wasm-plugin-image-specification"},"Wasm Plugin Image Specification"),(0,a.kt)("h2",{id:"1-overview"},"1. Overview"),(0,a.kt)("p",null,"This document defines the structure and building method of Higress Wasm Plugin images. When preparing, we referred to ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/solo-io/wasm/blob/master/spec/spec-compat.md"},"Wasm Image Specification"),"."),(0,a.kt)("h2",{id:"2-image-structure"},"2. Image Structure"),(0,a.kt)("p",null,"Each image needs to be build in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/opencontainers/image-spec"},"OCI Image Specification")," based on ",(0,a.kt)("inlineCode",{parentName:"p"},"scratch"),", and shall only contain following files:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"spec.yaml: Required. Metadata file of the plugin. Please refer to section 3 below for its format."),(0,a.kt)("li",{parentName:"ul"},"README.md: Required. Readme file describing the usage of the plugin. Markdown format. Written in English or Chinese."),(0,a.kt)("li",{parentName:"ul"},"README_{lang}.md: Optional. Readme file describing the usage of the plugin. Markdown format. ",(0,a.kt)("inlineCode",{parentName:"li"},"lang")," can be ",(0,a.kt)("inlineCode",{parentName:"li"},"ZH")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"EN"),"."),(0,a.kt)("li",{parentName:"ul"},"icon.png: Optional. Icon file of the plugin. A URL of the plugin icon can also be specified in spec.yaml. If both the file and the URL are configured, the file will be used for display."),(0,a.kt)("li",{parentName:"ul"},"plugin.wasm: Required. The binary file of the plugin.")),(0,a.kt)("p",null,"Each layer of the image can only contain a single file."),(0,a.kt)("p",null,"Except the layer containing plugin.wasm, the media type of other layers shall be set according to the file inside:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"spec.yaml: application/vnd.module.wasm.spec.v1+yaml "),(0,a.kt)("li",{parentName:"ul"},"README.md: application/vnd.module.wasm.doc.v1+markdown"),(0,a.kt)("li",{parentName:"ul"},"README_{lang}.md: application/vnd.module.wasm.doc.v1.{lang}+markdown"),(0,a.kt)("li",{parentName:"ul"},"icon.png: application/vnd.module.wasm.icon.v1+png")),(0,a.kt)("p",null,"plugin.wasm must be placed in the last layer of the image, with the media type of application/vnd.oci.image.layer.v1.tar+gzip."),(0,a.kt)("h2",{id:"3-metadata-file-format"},"3. Metadata File Format"),(0,a.kt)("p",null,"The format of metadata file, ",(0,a.kt)("inlineCode",{parentName:"p"},"spec.yaml"),", is as following, using the metadata of ",(0,a.kt)("inlineCode",{parentName:"p"},"basic-auth")," plugin as an example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: 1.0.0  # The schema version of the content below. Always use to 1.0.0 for now.\ninfo:\n  category: auth # Plugin category. Options: auth (authentication and authorization), security (security protection), protocol (protocol transformation), flow-control, flow-monitor,custom\n  name: basic-auth/v1  # Plugin name, which is the unique identifier of the plugin. It is recommended to add a version suffix, such as "/v1", just in case an incompatible upgrade in the future.\n  title: Basic Auth # Display name. I18n supported.\n  description: \u672c\u63d2\u4ef6\u5b9e\u73b0\u4e86\u57fa\u4e8e HTTP Basic Auth \u6807\u51c6\u8fdb\u884c\u8ba4\u8bc1\u9274\u6743\u7684\u529f\u80fd\u3002 # Plugin description. I18n supported.\n  x-description-i18n: # I18n content of the description field above. Translated contents can be added using "x-{name}-i18n" fields for all i18n-supported fields.\n    en-US: This plugin implements an authentication function based on HTTP Basic Auth standard.\n  iconUrl: https://img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png # Optional. URL of plugin icon file.\n  version: 1.0.0 # Plugin version\n  contact: # Plugin contact\n    name: Higress Team\n    url: http://higress.io/\n    email: admin@higress.io\nspec:\n  phase: AUTHN # Execution phase. Please refer to https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/#PluginPhase\n  priority: 0 # Execution priority within the given phase. Please refer to https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/#WasmPlugin\n  configSchema: # Schema of the plugin\'s runtime configurations, which shall be defined with the Schema object in OpenAPI 3.0.0 standard.\n    openAPIV3Schema: # Please refer to https://openapi.apifox.cn/#schema-%E5%AF%B9%E8%B1%A1 for the data structure. Some fields which can be used for display support i18n.\n      type: object\n      properties:\n        consumers:\n          type: array\n          scope: GLOBAL # Field effective scope. Options: GLOBAL (global configuration), INSTANCE (instance-level configuration, which can be set associated to routes or domains.), ALL (Available as both global and instance-level configurations). Optional. Default value is INSTANCE.\n          title: \u8c03\u7528\u65b9\u5217\u8868\n          x-title-i18n:\n            en-US: Consumer List\n          description: \u670d\u52a1\u8c03\u7528\u65b9\u5217\u8868\uff0c\u7528\u4e8e\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8ba4\u8bc1\n          x-description-i18n:\n            en-US: List of service consumers which will be used in request authentication\n          items:\n            type: object\n            properties:\n              name:\n                type: string\n                title: \u540d\u79f0\n                x-title-i18n:\n                  en-US: Name\n                description: \u8be5\u8c03\u7528\u65b9\u7684\u540d\u79f0\n                x-description-i18n:\n                  en-US: The name of the consumer\n                # Data validation shall be implemented according JSON Schema Validation Spec\n                # https://json-schema.org/draft/2020-12/json-schema-validation.html\n                # Following values are supported:\n                # - maximum\n                # - minimum\n                # - maxLength\n                # - minLength\n                # - pattern\n                # - maxItems\n                # - minItems\n                # - required\n                minLength: 6 # Minimum length for data validation\n                maxLength: 256 # Maximum length for data validation\n                pattern: "^$" # Regular experssion for data validation\n                example:\n                  - consumer1\n              credential:\n                type: string\n                title: \u8bbf\u95ee\u51ed\u8bc1\n                x-title-i18n:\n                  en-US: Credential\n                description: \u8be5\u8c03\u7528\u65b9\u7684\u8bbf\u95ee\u51ed\u8bc1\n                x-description-i18n:\n                  en-US: The credential of the consumer\n                example:\n                  - admin:123456\n            required:\n              - name\n              - credential\n        allow:\n          type: array\n          title: \u6388\u6743\u8bbf\u95ee\u7684\u8c03\u7528\u65b9\u5217\u8868\n          x-title-i18n:\n            en-US: Allowed Consumers\n          description: \u5bf9\u4e8e\u5339\u914d\u4e0a\u8ff0\u6761\u4ef6\u7684\u8bf7\u6c42\uff0c\u5141\u8bb8\u8bbf\u95ee\u7684\u8c03\u7528\u65b9\u5217\u8868\n          x-description-i18n:\n            en-US: Consumers to be allowed for matched requests\n          items:\n            type: string\n            example:\n              - consumer1\n      required:\n        - allow\n        - consumers\n      example:\n        consumers:\n          - name: consumer1\n            credential: admin:123456\n          - name: consumer2\n            credential: guest:abc\n        allow:\n          - consumer2\n')),(0,a.kt)("h2",{id:"4-how-to-build-an-image"},"4. How to Build an Image"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Start the builder container from the Higress root folder")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'GO_VERSION="1.19"\nTINYGO_VERSION="0.28.1"\nORAS_VERSION="1.0.0"\nPLUGIN_NAME="hello-world"\nBUILDER_IMAGE="higress-registry.cn-hangzhou.cr.aliyuncs.com/plugins/wasm-go-builder:go${GO_VERSION}-tinygo${TINYGO_VERSION}-oras${ORAS_VERSION}"\ndocker run -v ${PWD}:/workspace -e PLUGIN_NAME=${PLUGIN_NAME} -it --rm  /bin/bash\n')),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"Build Wasm file inside the container")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cd /workspace/plugins/wasm-go/extensions/${PLUGIN_NAME}\ngo mod tidy\ntinygo build -o ./plugin.wasm -scheduler=none -target=wasi -gc=custom -tags='custommalloc nottinygc_finalizer' ./main.go\n")),(0,a.kt)("ol",{start:3},(0,a.kt)("li",{parentName:"ol"},"Build and push an OCI image")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'tar czvf plugin.tar.gz plugin.wasm\nIMAGE_REGISTRY_SERVICE=docker.io\nIMAGE_REPOSITORY="${IMAGE_REGISTRY_SERVICE}/plugins/${PLUGIN_NAME}"\nIMAGE_TAG="v0.0.1"\noras login ${IMAGE_REGISTRY_SERVICE}\noras push ${IMAGE_REPOSITORY}:${IMAGE_TAG} \\\n    ./spec.yaml:application/vnd.module.wasm.spec.v1+yaml  \\\n    ./README.md:application/vnd.module.wasm.doc.v1+markdown \\\n    ./README_EN.md:application/vnd.module.wasm.doc.v1.en+markdown \\\n    ./plugin.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip\n')),(0,a.kt)("h2",{id:"5-appendix"},"5. Appendix"),(0,a.kt)("h3",{id:"51-default-icon-for-each-plugin-category"},"5.1 Default Icon for Each Plugin Category"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Custom: ",(0,a.kt)("a",{parentName:"li",href:"https://img.alicdn.com/imgextra/i1/O1CN018iKKih1iVx287RltL_!!6000000004419-2-tps-42-42.png"},"https://img.alicdn.com/imgextra/i1/O1CN018iKKih1iVx287RltL_!!6000000004419-2-tps-42-42.png")),(0,a.kt)("li",{parentName:"ul"},"Authentication and Authorization: ",(0,a.kt)("a",{parentName:"li",href:"https://img.alicdn.com/imgextra/i4/O1CN01BPFGlT1pGZ2VDLgaH_!!6000000005333-2-tps-42-42.png"},"https://img.alicdn.com/imgextra/i4/O1CN01BPFGlT1pGZ2VDLgaH_!!6000000005333-2-tps-42-42.png")),(0,a.kt)("li",{parentName:"ul"},"Flow Control: ",(0,a.kt)("a",{parentName:"li",href:"https://img.alicdn.com/imgextra/i3/O1CN01bAFa9k1t1gdQcVTH0_!!6000000005842-2-tps-42-42.png"},"https://img.alicdn.com/imgextra/i3/O1CN01bAFa9k1t1gdQcVTH0_!!6000000005842-2-tps-42-42.png")),(0,a.kt)("li",{parentName:"ul"},"Flow Monitor: ",(0,a.kt)("a",{parentName:"li",href:"https://img.alicdn.com/imgextra/i4/O1CN01aet3s61MoLOEEhRIo_!!6000000001481-2-tps-42-42.png"},"https://img.alicdn.com/imgextra/i4/O1CN01aet3s61MoLOEEhRIo_!!6000000001481-2-tps-42-42.png")),(0,a.kt)("li",{parentName:"ul"},"Security Protection: ",(0,a.kt)("a",{parentName:"li",href:"https://img.alicdn.com/imgextra/i1/O1CN01jKT9vC1O059vNaq5u_!!6000000001642-2-tps-42-42.png"},"https://img.alicdn.com/imgextra/i1/O1CN01jKT9vC1O059vNaq5u_!!6000000001642-2-tps-42-42.png")),(0,a.kt)("li",{parentName:"ul"},"Protocol Transformation: ",(0,a.kt)("a",{parentName:"li",href:"https://img.alicdn.com/imgextra/i2/O1CN01xIywow1mVGuRUjbhe_!!6000000004959-2-tps-42-42.png"},"https://img.alicdn.com/imgextra/i2/O1CN01xIywow1mVGuRUjbhe_!!6000000004959-2-tps-42-42.png"))))}u.isMDXComponent=!0}}]);