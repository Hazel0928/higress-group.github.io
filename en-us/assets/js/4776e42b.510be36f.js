"use strict";(self.webpackChunkhigress_website=self.webpackChunkhigress_website||[]).push([[5454],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=a.createContext({}),s=function(e){var t=a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(u.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,u=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),p=s(n),m=r,h=p["".concat(u,".").concat(m)]||p[m]||c[m]||l;return n?a.createElement(h,i(i({ref:t},d),{},{components:n})):a.createElement(h,i({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var o={};for(var u in t)hasOwnProperty.call(t,u)&&(o[u]=t[u]);o.originalType=e,o[p]="string"==typeof e?e:r,i[1]=o;for(var s=2;s<l;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4300:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var a=n(7462),r=(n(7294),n(3905));const l={title:"Key Authentication",keywords:["higress","key auth"],description:"API Key authentication plug-in configuration reference"},i=void 0,o={unversionedId:"plugins/key-auth",id:"plugins/key-auth",title:"Key Authentication",description:"API Key authentication plug-in configuration reference",source:"@site/i18n/en-us/docusaurus-plugin-content-docs/current/plugins/key-auth.md",sourceDirName:"plugins",slug:"/plugins/key-auth",permalink:"/en-us/docs/plugins/key-auth",draft:!1,editUrl:"https://github.com/higress-group/higress-group.github.io/blob/main/i18n/en-us/docusaurus-plugin-content-docs/current/plugins/key-auth.md",tags:[],version:"current",frontMatter:{title:"Key Authentication",keywords:["higress","key auth"],description:"API Key authentication plug-in configuration reference"},sidebar:"docs",previous:{title:"HMAC authentication",permalink:"/en-us/docs/plugins/hmac-auth"},next:{title:"Basic Auth",permalink:"/en-us/docs/plugins/basic-auth"}},u={},s=[{value:"Features",id:"features",level:2},{value:"Configuration field",id:"configuration-field",level:2},{value:"Example configuration",id:"example-configuration",level:2},{value:"Enabled for specific routes or domains",id:"enabled-for-specific-routes-or-domains",level:3},{value:"Depending on this configuration, the following requests would allow access\uff1a",id:"depending-on-this-configuration-the-following-requests-would-allow-access",level:4},{value:"The following requests will deny access\uff1a",id:"the-following-requests-will-deny-access",level:4},{value:"Gateway instance level enabled",id:"gateway-instance-level-enabled",level:3},{value:"Error code",id:"error-code",level:2}],d={toc:s},p="wrapper";function c(e){let{components:t,...n}=e;return(0,r.kt)(p,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"features"},"Features"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," plug-in implements the authentication function based on the API Key, supports parsing the API Key from the URL parameter or request header of the HTTP request, and verifies whether the API Key has permission to access."),(0,r.kt)("h2",{id:"configuration-field"},"Configuration field"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Parameter requirements"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"consumers")),(0,r.kt)("td",{parentName:"tr",align:null},"array of object"),(0,r.kt)("td",{parentName:"tr",align:null},"Required"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Configure the caller of the service to authenticate the request.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"keys")),(0,r.kt)("td",{parentName:"tr",align:null},"array of string"),(0,r.kt)("td",{parentName:"tr",align:null},"Required"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"The name of the source field of the API Key, which can be a URL parameter or an HTTP request header name.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"in_query")),(0,r.kt)("td",{parentName:"tr",align:null},"bool"),(0,r.kt)("td",{parentName:"tr",align:null},"At least one of ",(0,r.kt)("inlineCode",{parentName:"td"},"in_query")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"in_header")," must be true."),(0,r.kt)("td",{parentName:"tr",align:null},"true"),(0,r.kt)("td",{parentName:"tr",align:null},"When configured true, the gateway will try to parse the API Key from the URL parameters.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"in_header")),(0,r.kt)("td",{parentName:"tr",align:null},"bool"),(0,r.kt)("td",{parentName:"tr",align:null},"The same as above."),(0,r.kt)("td",{parentName:"tr",align:null},"true"),(0,r.kt)("td",{parentName:"tr",align:null},"The same as above.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"_rules_")),(0,r.kt)("td",{parentName:"tr",align:null},"array of object"),(0,r.kt)("td",{parentName:"tr",align:null},"Optional"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Configure the access list of a specific route or domain name for authenticating requests.")))),(0,r.kt)("p",null,"The configuration fields of each item in ",(0,r.kt)("inlineCode",{parentName:"p"},"consumers")," are described as follows:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Parameter requirements"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"credential")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Required"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Configure the consumer's access credentials.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"name")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Required"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Configure the name of the consumer.")))),(0,r.kt)("p",null,"The configuration fields of each item in ",(0,r.kt)("inlineCode",{parentName:"p"},"_rules_")," are described as follows:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Parameter requirements"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"_match_route_")),(0,r.kt)("td",{parentName:"tr",align:null},"array of string"),(0,r.kt)("td",{parentName:"tr",align:null},"Optional\uff0cOptionally fill in one of ",(0,r.kt)("inlineCode",{parentName:"td"},"_match_route_"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"_match_domain_"),"."),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Configure the route name to match.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"_match_domain_")),(0,r.kt)("td",{parentName:"tr",align:null},"array of string"),(0,r.kt)("td",{parentName:"tr",align:null},"Optional\uff0cOptionally fill in one of ",(0,r.kt)("inlineCode",{parentName:"td"},"_match_route_"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"_match_domain_"),"."),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Configure the domain name to match.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"allow")),(0,r.kt)("td",{parentName:"tr",align:null},"array of string"),(0,r.kt)("td",{parentName:"tr",align:null},"Required"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"For requests that meet the matching conditions, configure the name of the consumer that is allowed to access.")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Warning\uff1a")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If the ",(0,r.kt)("inlineCode",{parentName:"li"},"_rules_")," field is not configured, authentication will be enabled for all routes of the current gateway instance by default;"),(0,r.kt)("li",{parentName:"ul"},"For a request that passes authentication, an ",(0,r.kt)("inlineCode",{parentName:"li"},"X-Mse-Consumer")," field will be added to the request header to identify the name of the caller.")),(0,r.kt)("h2",{id:"example-configuration"},"Example configuration"),(0,r.kt)("h3",{id:"enabled-for-specific-routes-or-domains"},"Enabled for specific routes or domains"),(0,r.kt)("p",null,"The following configuration will enable Key Auth authentication and authentication for gateway-specific routes or domain names. Note that the ",(0,r.kt)("inlineCode",{parentName:"p"},"credential")," field can not be repeated."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'consumers:\n- credential: 2bda943c-ba2b-11ec-ba07-00163e1250b5\n  name: consumer1\n- credential: c8c8e9ca-558e-4a2d-bb62-e700dcc40e35\n  name: consumer2\nkeys:\n- apikey\nin_query: true\n# Use the _rules_ field for fine-grained rule configuration\n_rules_:\n# Rule 1: Match by route name to take effect\n- _match_route_:\n  - route-a\n  - route-b\n  allow:\n  - consumer1\n# Rule 2: Take effect by domain name matching\n- _match_domain_:\n  - "*.example.com"\n  - test.com\n  allow:\n  - consumer2\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"route-a")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"route-b")," specified in ",(0,r.kt)("inlineCode",{parentName:"p"},"_match_route_")," in this example are the route names filled in when creating the gateway route. When these two routes are matched, calls whose ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"consumer1")," will be allowed Access by callers, other callers are not allowed to access;"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"*.example.com")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"test.com")," specified in ",(0,r.kt)("inlineCode",{parentName:"p"},"_match_domain_")," in this example are used to match the domain name of the request. When the domain name matches, the caller whose ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"consumer2")," will be allowed to access, and other calls access is not allowed."),(0,r.kt)("h4",{id:"depending-on-this-configuration-the-following-requests-would-allow-access"},"Depending on this configuration, the following requests would allow access\uff1a"),(0,r.kt)("p",null,"Assume that the following request will match the route-a route:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Set the API Key in the url parameter")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl  http://xxx.hello.com/test?apikey=2bda943c-ba2b-11ec-ba07-00163e1250b5\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Set the API Key in the http request header")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl  http://xxx.hello.com/test -H 'x-api-key: 2bda943c-ba2b-11ec-ba07-00163e1250b5'\n")),(0,r.kt)("p",null,"After the authentication is passed, an ",(0,r.kt)("inlineCode",{parentName:"p"},"X-Mse-Consumer")," field will be added to the header of the request. In this example, its value is ",(0,r.kt)("inlineCode",{parentName:"p"},"consumer1"),", which is used to identify the name of the caller."),(0,r.kt)("h4",{id:"the-following-requests-will-deny-access"},"The following requests will deny access\uff1a"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"The request does not provide an API Key, return 401")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl  http://xxx.hello.com/test\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"The API Key provided by the request is not authorized to access, return 401")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl  http://xxx.hello.com/test?apikey=926d90ac-ba2e-11ec-ab68-00163e1250b5\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"The caller matched according to the API Key provided in the request has no access rights, return 403")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# consumer2 is not in the allow list of route-a\ncurl  http://xxx.hello.com/test?apikey=c8c8e9ca-558e-4a2d-bb62-e700dcc40e35\n")),(0,r.kt)("h3",{id:"gateway-instance-level-enabled"},"Gateway instance level enabled"),(0,r.kt)("p",null,"The following configuration does not specify the ",(0,r.kt)("inlineCode",{parentName:"p"},"_rules_")," field, so Key Auth authentication will be enabled at the gateway instance level."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"consumers:\n- credential: 2bda943c-ba2b-11ec-ba07-00163e1250b5\n  name: consumer1\n- credential: c8c8e9ca-558e-4a2d-bb62-e700dcc40e35\n  name: consumer2\nkeys:\n- apikey\nin_query: true\n")),(0,r.kt)("h2",{id:"error-code"},"Error code"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"HTTP status code"),(0,r.kt)("th",{parentName:"tr",align:null},"Error information"),(0,r.kt)("th",{parentName:"tr",align:null},"Reason"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"401"),(0,r.kt)("td",{parentName:"tr",align:null},"No API key found in request."),(0,r.kt)("td",{parentName:"tr",align:null},"API not provided by request Key.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"401"),(0,r.kt)("td",{parentName:"tr",align:null},"Request denied by Key Auth check. Invalid API key."),(0,r.kt)("td",{parentName:"tr",align:null},"Current API Key access is not allowed.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"403"),(0,r.kt)("td",{parentName:"tr",align:null},"Request denied by Basic Auth check. Unauthorized consumer."),(0,r.kt)("td",{parentName:"tr",align:null},"The requested caller does not have access.")))))}c.isMDXComponent=!0}}]);